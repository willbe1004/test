<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í•œêµ­ìˆ˜ì•ˆ AI ì˜ì—…ê´€ë¦¬ (ì„¸ì›€í„° L04)</title>
  <style>
    :root{
      --bg-main:#050b16; --bg-card:#0e1b2a; --bg-card-soft:#122538;
      --accent:#ffb83f; --accent-soft:rgba(255,184,63,.15); --accent-strong:#ff9f1c;
      --primary:#00c896; --primary-soft:rgba(0,200,150,.15);
      --danger:#ff5c7a;
      --text-main:#f4f7fb; --text-soft:#9faec6;
      --border-subtle:#1e3146;
      --shadow-soft:0 18px 40px rgba(6,17,36,.85);
      --radius-lg:18px; --radius-xl:22px;
      --transition-fast:.18s ease-out;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo",sans-serif;
      background:radial-gradient(circle at top,#10213a 0,#050b16 40%,#02030a 70%);
      color:var(--text-main); min-height:100vh;
    }
    .shell{max-width:1320px;margin:0 auto;padding:20px 18px 32px;}
    .header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:14px}
    .title h1{margin:0;font-size:22px;letter-spacing:.04em}
    .subtitle{margin-top:6px;font-size:11px;color:var(--text-soft);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .dot{width:4px;height:4px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px rgba(255,184,63,.8)}
    .badge{font-size:11px;padding:4px 9px;border-radius:999px;border:1px solid rgba(0,200,150,.6);color:var(--primary);
      background:radial-gradient(circle at top left,#123d3a,#050b16)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;flex:1}
    .btn{
      position:relative; display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      font-size:12px; color:var(--text-main); background:rgba(7,16,28,.9);
      cursor:pointer; transition:transform var(--transition-fast), background var(--transition-fast), box-shadow var(--transition-fast);
      white-space:nowrap;
    }
    .btn:hover{background:rgba(18,35,58,.9); transform:translateY(-1px); box-shadow:0 10px 28px rgba(0,0,0,.6)}
    .btn.primary{
      background:linear-gradient(135deg,#00c896,#00e0b0); border-color:rgba(0,0,0,.15);
      color:#061118; font-weight:700; box-shadow:0 10px 24px rgba(0,200,150,.3)
    }
    .btn.primary:hover{box-shadow:0 14px 32px rgba(0,200,150,.4)}
    .btn.danger{background:rgba(255,92,122,.1); border-color:rgba(255,92,122,.5); color:#ffbac9}
    .btn.danger:hover{background:rgba(255,92,122,.2)}
    .btn.loading{pointer-events:none; opacity:.75}
    .btn.loading::after{
      content:""; position:absolute; right:10px; width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(255,255,255,.6); border-top-color:transparent; animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;align-items:start}
    @media (max-width: 1020px){.grid{grid-template-columns:1fr}}

    .card{
      background:linear-gradient(180deg,rgba(14,27,42,.94),rgba(7,14,26,.9));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-soft);
      overflow:hidden;
    }
    .card-hd{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .card-hd h2{margin:0;font-size:14px;letter-spacing:.03em}
    .card-bd{padding:14px 16px}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
    .label{font-size:11px;color:var(--text-soft)}
    .input, .select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(10,23,40,.6);
      color:var(--text-main);
      outline:none;
    }
    .input::placeholder{color:rgba(159,174,198,.7)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      padding:6px 10px;border-radius:999px;font-size:11px;
      border:1px solid rgba(255,255,255,.10); background:rgba(18,35,58,.6); color:var(--text-soft);
      cursor:pointer; user-select:none;
      transition:background var(--transition-fast), transform var(--transition-fast);
    }
    .chip.active{border-color:rgba(0,200,150,.55); color:var(--primary); background:rgba(0,200,150,.10)}
    .chip:hover{transform:translateY(-1px)}
    .hint{font-size:11px;color:var(--text-soft);line-height:1.55}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      text-align:left; font-size:11px; color:var(--text-soft);
      padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(7,16,28,.35);
      position:sticky; top:0; backdrop-filter: blur(8px);
    }
    tbody td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); font-size:12px; vertical-align:top}
    tbody tr{cursor:pointer; transition:background var(--transition-fast)}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .col-title{font-weight:650}
    .muted{color:var(--text-soft)}
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px;
      font-size:11px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04);
    }
    .pill.wait{border-color:rgba(255,184,63,.45); color:#ffd08a; background:rgba(255,184,63,.08)}
    .pill.done{border-color:rgba(0,200,150,.45); color:#7ff0d0; background:rgba(0,200,150,.08)}
    .pill.err{border-color:rgba(255,92,122,.50); color:#ffbac9; background:rgba(255,92,122,.10)}
    .kw{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border-radius:999px;font-size:11px;
      border:1px solid rgba(255,255,255,.10); color:var(--text-soft); background:rgba(18,35,58,.45)}

    .side .block{padding:14px 16px;border-top:1px solid rgba(255,255,255,.06)}
    .side .block:first-child{border-top:none}
    .side h3{margin:0 0 10px;font-size:13px}
    .kv{display:grid;grid-template-columns:92px 1fr;gap:8px 10px;font-size:12px;line-height:1.5}
    .kv .k{color:var(--text-soft)}
    .kv .v a{color:var(--accent);text-decoration:none}
    .kv .v a:hover{text-decoration:underline}
    pre{
      margin:0; padding:12px; border-radius:14px;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.08);
      color:#e5e7eb; overflow:auto; font-family:var(--mono); font-size:11px; line-height:1.55;
      max-height:320px;
    }

    .toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      background:rgba(6,17,36,.92); border:1px solid rgba(255,255,255,.12);
      padding:10px 14px; border-radius:999px; font-size:12px; color:var(--text-main);
      box-shadow:0 18px 40px rgba(0,0,0,.55);
      opacity:0; pointer-events:none; transition:opacity .18s ease-out, transform .18s ease-out;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-3px)}
    .toast .small{color:var(--text-soft);font-size:11px;margin-left:8px}
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="title">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          <h1>í•œêµ­ìˆ˜ì•ˆ AI ì˜ì—…ê´€ë¦¬ (ì„¸ì›€í„° L04)</h1>
          <span class="badge">frontend v60</span>
        </div>
        <div class="subtitle">
          <span class="dot"></span>
          <span>1) L04 ìˆ˜ì§‘ â†’ 2) í‚¤ì›Œë“œ í•„í„° â†’ 3) Gemini ë¶„ì„ â†’ 4) DB ì¡°íšŒ</span>
        </div>
      </div>
      <div class="actions">
        <button id="btnRefresh" class="btn">ğŸ”„ DB ìƒˆë¡œê³ ì¹¨</button>
        <button id="btnGuide" class="btn">ğŸ§© ì„¤ì • ê°€ì´ë“œ</button>
        <button id="btnCollect" class="btn primary">ğŸ“¥ ëª©ë¡ ìˆ˜ì§‘</button>
        <button id="btnAI" class="btn primary">ğŸ¤– AI ë¶„ì„(ëŒ€ê¸°)</button>
      </div>
    </div>

    <div class="grid">
      <!-- MAIN -->
      <div class="card">
        <div class="card-hd">
          <h2>DB ëª©ë¡</h2>
          <div class="row" style="gap:8px;">
            <input id="q" class="input" style="width:260px;" placeholder="ê²€ìƒ‰: ê³µëª¨ëª…/ê¸°ê´€/í‚¤ì›Œë“œ" />
            <select id="statusFilter" class="select" style="width:140px;">
              <option value="all">ìƒíƒœ: ì „ì²´</option>
              <option value="ëŒ€ê¸°">ìƒíƒœ: ëŒ€ê¸°</option>
              <option value="ì™„ë£Œ">ìƒíƒœ: ì™„ë£Œ</option>
              <option value="ì—ëŸ¬">ìƒíƒœ: ì—ëŸ¬</option>
            </select>
          </div>
        </div>
        <div class="card-bd" style="padding:0;">
          <div style="overflow:auto; max-height: 68vh;">
            <table>
              <thead>
                <tr>
                  <th style="min-width:110px;">ë“±ë¡ì¼</th>
                  <th style="min-width:420px;">ì„¤ê³„ê³µëª¨ëª…</th>
                  <th style="min-width:160px;">ê¸°ê´€</th>
                  <th style="min-width:90px;">ìƒíƒœ</th>
                  <th style="min-width:220px;">í‚¤ì›Œë“œ</th>
                  <th style="min-width:260px;">AI ìš”ì•½</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="6" class="muted" style="padding:18px;">ë¡œë”© ì¤‘â€¦</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- SIDE -->
      <div class="card side">
        <div class="card-hd">
          <h2>ìƒì„¸</h2>
          <div class="row" style="gap:8px;">
            <button id="btnOpenLink" class="btn" disabled>ğŸ”— ì›ë¬¸ ì—´ê¸°</button>
            <button id="btnCopyJson" class="btn" disabled>ğŸ“‹ JSON ë³µì‚¬</button>
          </div>
        </div>

        <div class="block">
          <h3 style="margin:0 0 10px;">ì„ íƒëœ í•­ëª©</h3>
          <div class="kv">
            <div class="k">ê³µëª¨ëª…</div><div class="v" id="d_title" style="font-weight:650;">-</div>
            <div class="k">ê¸°ê´€</div><div class="v" id="d_agency">-</div>
            <div class="k">ë“±ë¡ì¼</div><div class="v" id="d_date">-</div>
            <div class="k">ìƒíƒœ</div><div class="v" id="d_status">-</div>
            <div class="k">í‚¤ì›Œë“œ</div><div class="v" id="d_kw">-</div>
            <div class="k">URL</div><div class="v" id="d_url">-</div>
          </div>
        </div>

        <div class="block">
          <h3>AI JSON</h3>
          <pre id="d_json">-</pre>
        </div>

        <div class="block">
          <h3>ì›ë¬¸ ë°œì·Œ(400ì)</h3>
          <pre id="d_excerpt">-</pre>
        </div>

        <div class="block">
          <div class="hint">
            <b>í•„ìˆ˜ endpoint</b> : <span class="muted">action=db_list / seumter_collect / seumter_ai / setup_guide</span><br/>
            <b>ì°¸ê³ </b> : ì„¸ì›€í„°ê°€ ë™ì  ë¡œë”©ì´ë©´ <span class="muted">EAIS_L04_XHR_*</span> ìŠ¤í¬ë¦½íŠ¸ ì†ì„±ì„ ì„¸íŒ…í•´ì•¼ ìˆ˜ì§‘ì´ ì•ˆì •ì ì…ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">-</div>

<script>
  /**
   * â˜… í•„ìˆ˜: ë³¸ì¸ WebApp URLë¡œ ë°”ê¾¸ì„¸ìš”.
   * ì˜ˆ) https://script.google.com/macros/s/XXXX/exec
   */
  // ê¸°ë³¸ê°’: ë³¸ì¸ WebApp URLë¡œ ë°”ê¾¸ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
// ì˜ˆ) https://script.google.com/macros/s/XXXX/exec
let API_BASE = "https://script.google.com/macros/s/AKfycbxxoKyR07FkajC6dvjlrDy8ns0L_HJaCAtGds7My9KSaF5BTEye8v1jaVjzoFC-YsjhuA/exec";

// (í¸ì˜) ì´ íŒŒì¼ì„ Apps Script WebAppì—ì„œ ì§ì ‘ ì—´ë©´, ìë™ìœ¼ë¡œ í˜„ì¬ /exec ë¥¼ API_BASEë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
// ë˜ëŠ” URLì— ?api=WEBAPP_URL ì„ ë¶™ì´ë©´(ì •ì í˜¸ìŠ¤íŒ… ì‹œ) ìë™ ì ìš©ë©ë‹ˆë‹¤.
(function autoDetectApiBase(){
  const qp = new URLSearchParams(location.search).get("api");
  if (qp && /^https?:\/\//i.test(qp)) { API_BASE = qp; return; }
  if (API_BASE.includes("PUT_YOUR_WEBAPP_URL_HERE") && location.href.includes("/exec")) {
    API_BASE = location.href.split("?")[0];
  }
})();


  const L04_URL = "https://www.eais.go.kr/moct/awp/aia01/AWPAIA01L04";

  const $ = (id) => document.getElementById(id);
  const state = {
    items: [],
    selected: null,
    guide: null
  };

  // ---------- UI helpers ----------
  let toastTimer = null;
  function toast(msg, sub){
    const t = $("toast");
    t.innerHTML = `${escapeHtml(msg)}${sub ? `<span class="small">${escapeHtml(sub)}</span>` : ""}`;
    t.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>t.classList.remove("show"), 2600);
  }
  function setLoading(btn, on){
    if(!btn) return;
    btn.classList.toggle("loading", !!on);
  }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- API ----------
  async function apiGet(action){
    const url = new URL(API_BASE);
    url.searchParams.set("action", action);
    const res = await fetch(url.toString(), { method:"GET" });
    const txt = await res.text();
    let data = null;
    try { data = JSON.parse(txt); } catch(e){ data = { ok:false, message:"JSON íŒŒì‹± ì‹¤íŒ¨", raw: txt }; }
    return data;
  }

  // ---------- Render ----------
  function renderTable(){
    const tbody = $("tbody");
    const q = ($("q").value || "").trim().toLowerCase();
    const st = $("statusFilter").value;

    const filtered = state.items.filter(it=>{
      if(st !== "all" && (it.status || "") !== st) return false;
      if(!q) return true;
      const blob = [
        it.title, it.agency, it.postedDate, it.matchedKeywords, it.aiSummary
      ].join(" ").toLowerCase();
      return blob.includes(q);
    });

    if(!filtered.length){
      tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map((it, idx)=>{
      const pillClass = it.status === "ì™„ë£Œ" ? "done" : (it.status === "ì—ëŸ¬" ? "err" : "wait");
      const kws = (it.matchedKeywords || "").split(",").map(x=>x.trim()).filter(Boolean).slice(0,6);
      const kwHtml = kws.length ? kws.map(k=>`<span class="kw">${escapeHtml(k)}</span>`).join("") : `<span class="muted">-</span>`;
      const date = escapeHtml(it.postedDate || "");
      const title = escapeHtml(it.title || "");
      const agency = escapeHtml(it.agency || "");
      const summary = escapeHtml(it.aiSummary || "");
      const status = escapeHtml(it.status || "");

      return `
        <tr data-id="${escapeHtml(it.id || "")}">
          <td class="muted">${date || "-"}</td>
          <td><div class="col-title">${title || "-"}</div></td>
          <td class="muted">${agency || "-"}</td>
          <td><span class="pill ${pillClass}">${status || "-"}</span></td>
          <td>${kwHtml}</td>
          <td class="muted">${summary || "-"}</td>
        </tr>
      `;
    }).join("");

    // row click
    [...tbody.querySelectorAll("tr[data-id]")].forEach(tr=>{
      tr.addEventListener("click", ()=>{
        const id = tr.getAttribute("data-id");
        const it = state.items.find(x => (x.id||"") === id);
        if(it) selectItem(it);
      });
    });
  }

  function prettyJson(s){
    if(!s) return "-";
    try{
      const obj = JSON.parse(s);
      return JSON.stringify(obj, null, 2);
    }catch(e){
      return s;
    }
  }

  function selectItem(it){
    state.selected = it;

    $("d_title").textContent = it.title || "-";
    $("d_agency").textContent = it.agency || "-";
    $("d_date").textContent = it.postedDate || "-";
    $("d_status").textContent = it.status || "-";

    // keywords
    const kws = (it.matchedKeywords || "").split(",").map(x=>x.trim()).filter(Boolean);
    $("d_kw").innerHTML = kws.length ? kws.map(k=>`<span class="kw">${escapeHtml(k)}</span>`).join("") : "-";

    // url
    if(it.detailUrl){
      $("d_url").innerHTML = `<a href="${escapeHtml(it.detailUrl)}" target="_blank" rel="noopener">ì›ë¬¸ ë§í¬</a>`;
      $("btnOpenLink").disabled = false;
    }else{
      $("d_url").textContent = "-";
      $("btnOpenLink").disabled = true;
    }

    $("d_json").textContent = prettyJson(it.aiJson || "");
    $("d_excerpt").textContent = it.fetchedAt ? `[${it.fetchedAt}] ${it.rawExcerpt || "-"}` : (it.rawExcerpt || "-");

    $("btnCopyJson").disabled = !(it.aiJson && it.aiJson.trim().length);
  }

  // ---------- Actions ----------
  async function refresh(){
    setLoading($("btnRefresh"), true);
    try{
      const data = await apiGet("db_list");
      if(!data.ok) throw new Error(data.message || "db_list ì‹¤íŒ¨");
      state.items = (data.items || []);
      renderTable();
      toast("DB ë¡œë“œ ì™„ë£Œ", `${state.items.length}ê±´`);
      // keep selection if possible
      if(state.selected){
        const cur = state.items.find(x => x.id === state.selected.id);
        if(cur) selectItem(cur);
      }
    }catch(e){
      console.error(e);
      toast("DB ë¡œë“œ ì‹¤íŒ¨", e.message || String(e));
      $("tbody").innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px;">DB ë¡œë“œ ì‹¤íŒ¨: ${escapeHtml(e.message || String(e))}</td></tr>`;
    }finally{
      setLoading($("btnRefresh"), false);
    }
  }

  async function collect(){
    setLoading($("btnCollect"), true);
    try{
      // backendëŠ” URL íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ, ë¡œê·¸/í™•ì¥ì„±ì„ ìœ„í•´ ê°™ì´ ì „ë‹¬í•´ë„ ë¬´í•´í•©ë‹ˆë‹¤.
      const url = new URL(API_BASE);
      url.searchParams.set("action", "seumter_collect");
      url.searchParams.set("url", L04_URL);
      const res = await fetch(url.toString(), { method:"GET" });
      const data = await res.json().catch(()=>null);
      if(!data || !data.ok) throw new Error((data && data.message) ? data.message : "ìˆ˜ì§‘ ì‹¤íŒ¨");
      toast("ëª©ë¡ ìˆ˜ì§‘ ì™„ë£Œ", `ì‹ ê·œ ${data.inserted ?? 0}ê±´`);
      await refresh();
    }catch(e){
      console.error(e);
      toast("ëª©ë¡ ìˆ˜ì§‘ ì‹¤íŒ¨", e.message || String(e));
    }finally{
      setLoading($("btnCollect"), false);
    }
  }

  async function runAI(){
    setLoading($("btnAI"), true);
    try{
      const data = await apiGet("seumter_ai");
      if(!data.ok) throw new Error(data.message || "AI ë¶„ì„ ì‹¤íŒ¨");
      toast("AI ë¶„ì„ ì™„ë£Œ", `ì²˜ë¦¬ ${data.processed ?? 0} / ì˜¤ë¥˜ ${data.errors ?? 0}`);
      await refresh();
    }catch(e){
      console.error(e);
      toast("AI ë¶„ì„ ì‹¤íŒ¨", e.message || String(e));
    }finally{
      setLoading($("btnAI"), false);
    }
  }

  async function guide(){
    setLoading($("btnGuide"), true);
    try{
      const data = await apiGet("setup_guide");
      if(!data.ok) throw new Error(data.message || "guide ì‹¤íŒ¨");
      state.guide = data.guide;
      const pretty = JSON.stringify(data.guide, null, 2);
      alert("ì„¤ì • ê°€ì´ë“œ(ìš”ì•½)\n\n" + pretty);
    }catch(e){
      console.error(e);
      alert("ì„¤ì • ê°€ì´ë“œ ë¡œë“œ ì‹¤íŒ¨: " + (e.message || String(e)));
    }finally{
      setLoading($("btnGuide"), false);
    }
  }

  function bind(){
    $("btnRefresh").addEventListener("click", refresh);
    $("btnCollect").addEventListener("click", collect);
    $("btnAI").addEventListener("click", runAI);
    $("btnGuide").addEventListener("click", guide);

    $("q").addEventListener("input", renderTable);
    $("statusFilter").addEventListener("change", renderTable);

    $("btnOpenLink").addEventListener("click", ()=>{
      const it = state.selected;
      if(it && it.detailUrl) window.open(it.detailUrl, "_blank", "noopener");
    });
    $("btnCopyJson").addEventListener("click", async ()=>{
      const it = state.selected;
      if(!it || !it.aiJson) return;
      try{
        await navigator.clipboard.writeText(prettyJson(it.aiJson));
        toast("ë³µì‚¬ ì™„ë£Œ", "AI JSON");
      }catch(e){
        toast("ë³µì‚¬ ì‹¤íŒ¨", "ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸");
      }
    });
  }

  // ---------- boot ----------
  bind();
  refresh();

</script>
</body>
</html>
