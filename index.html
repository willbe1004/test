<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>한국수안 AI 입찰관리 (EAIS L04)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; margin:0; background:#050b16; color:#e9f0ff;}
    .wrap{max-width:1100px; margin:0 auto; padding:18px;}
    .card{background:#0e1b2a; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; margin:12px 0;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input{background:#122538; border:1px solid rgba(255,255,255,.12); color:#e9f0ff; border-radius:12px; padding:10px 12px; min-width:260px;}
    button{background:#00c896; border:none; color:#042016; font-weight:900; border-radius:12px; padding:10px 12px; cursor:pointer;}
    button.secondary{background:#ffb83f;}
    button.ghost{background:transparent; border:1px solid rgba(255,255,255,.18); color:#e9f0ff;}
    .log{white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; color:#b9c7ff;}
    .muted{color:#a9b7d1; font-size:12px;}
    a{color:#7ad7ff}
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:8px 0 6px;">한국수안 AI 입찰관리 (EAIS L04 전용)</h2>
    <div class="muted">직원용 웹앱: EAIS(L04) 자동 수집 → 상세/AI 요약/2차/대책문서까지 버튼으로 처리</div>

    <div class="card">
      <div class="row">
        <input id="apiBase" placeholder="WebApp URL (https://script.google.com/macros/s/AKfycbxxoKyR07FkajC6dvjlrDy8ns0L_HJaCAtGds7My9KSaF5BTEye8v1jaVjzoFC-YsjhuA/exec)"/>
        <button class="ghost" id="saveApi">URL 저장</button>
        <div style="flex:1"></div>
        <div id="loginBox"></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="gateKeyword" placeholder="(선택) 단일 게이트키워드 예: 센터"/>
        <input id="maxRows" placeholder="max (기본 50)" style="min-width:140px;"/>
        <button id="btnCollect">EAIS(L04) 수집</button>
        <button class="secondary" id="btnPipeline">수집 + AI요약 + 2차 + 대책문서</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        * 다중 게이트키워드는 백엔드 Script Properties의 <b>GATE_KEYWORDS</b>로 관리됩니다.
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button class="ghost" id="btnRefresh">DB 새로고침</button>
      </div>
      <div id="dbArea" class="log" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div style="font-weight:800; margin-bottom:8px;">실행 로그</div>
      <div id="log" class="log"></div>
    </div>
  </div>

<script>
  // ===== storage =====
  const LS_API = "KSUA_API_BASE";
  const LS_CLIENT = "KSUA_GOOGLE_CLIENT_ID";
  const apiBaseEl = document.getElementById('apiBase');
  apiBaseEl.value = localStorage.getItem(LS_API) || "";
  document.getElementById('saveApi').onclick = ()=>{ localStorage.setItem(LS_API, apiBaseEl.value.trim()); alert("저장 완료"); };

  // ===== login (GIS) =====
  let accessToken = "";
  let idToken = "";
  function log(msg){ const el=document.getElementById('log'); el.textContent = (msg + "\n") + el.textContent; }

  function renderLogin(){
    const box = document.getElementById('loginBox');
    const clientId = localStorage.getItem(LS_CLIENT) || "";
    box.innerHTML = `
      <input id="clientId" placeholder="Google Client ID" value="${clientId}" style="min-width:380px"/>
      <button class="ghost" id="saveClient">ClientID 저장</button>
      <button id="btnLogin">로그인</button>
      <span class="muted" id="loginState">${accessToken ? "로그인됨" : "미로그인"}</span>
    `;
    document.getElementById('saveClient').onclick=()=>{
      localStorage.setItem(LS_CLIENT, document.getElementById('clientId').value.trim());
      alert("저장 완료");
    };
    document.getElementById('btnLogin').onclick=()=>startLogin();
  }

  async function startLogin(){
    const clientId = (document.getElementById('clientId')?.value || localStorage.getItem(LS_CLIENT) || "").trim();
    if(!clientId){ alert("Google Client ID를 저장하세요."); return; }

    const tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: "https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile",
      callback: (resp) => {
        accessToken = resp.access_token || "";
        document.getElementById('loginState').textContent = accessToken ? "로그인됨" : "미로그인";
        log("LOGIN OK");
      }
    });
    tokenClient.requestAccessToken({prompt: "consent"});
  }
  window.onload = ()=>renderLogin();

  // ===== call backend =====
  async function callApi(action, extra){
    const api = (apiBaseEl.value || localStorage.getItem(LS_API) || "").trim();
    if(!api){ alert("WebApp URL(…/exec)을 입력/저장하세요."); throw new Error("no api"); }
    if(!accessToken){ alert("먼저 로그인하세요."); throw new Error("no token"); }

    const payload = Object.assign({ action, accessToken, idToken }, extra || {});
    const res = await fetch(api, { method:"POST", headers:{ "Content-Type":"text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch(e){ return { ok:false, raw: txt }; }
  }

  document.getElementById('btnCollect').onclick = async()=>{
    try{
      log("EAIS 수집 시작...");
      const gateKeyword = document.getElementById('gateKeyword').value.trim();
      const max = Number(document.getElementById('maxRows').value || 50);
      const out = await callApi("eais_l04_collect", { gateKeyword, max });
      log(JSON.stringify(out, null, 2));
      alert(out.ok ? `완료: 신규 ${out.inserted}건` : ("실패: " + (out.error||"")));
    }catch(e){ log(String(e)); }
  };

  document.getElementById('btnPipeline').onclick = async()=>{
    try{
      log("EAIS 파이프라인 시작...");
      const gateKeyword = document.getElementById('gateKeyword').value.trim();
      const max = Number(document.getElementById('maxRows').value || 50);
      const out = await callApi("eais_l04_pipeline", { gateKeyword, max });
      log(JSON.stringify(out, null, 2));
      alert(out.ok ? `완료: 처리 ${out.processed?.length||0}건 / 문서 ${out.docCreated||0}건` : ("실패: " + (out.error||"")));
    }catch(e){ log(String(e)); }
  };

  document.getElementById('btnRefresh').onclick = async()=>{
    try{
      const out = await callApi("list", { limit: 30 });
      document.getElementById('dbArea').textContent = JSON.stringify(out, null, 2);
    }catch(e){ log(String(e)); }
  };
</script>
</body>
</html>
