/**************************************************************
 * í•œêµ­ìˆ˜ì•ˆ ì…ì°°ê´€ë¦¬ í†µí•© ìŠ¤í¬ë¦½íŠ¸ (ì„œë²„ ì‚¬ì´ë“œ / Apps Script)
 * - ë‚˜ë¼ì¥í„° API ìˆ˜ì§‘ + 1ì°¨ AI ìš”ì•½
 * - 2ì°¨ ì‹¬í™” ë¶„ì„ (ë‚˜ë¼ì¥í„° ìƒì„¸ + ì²¨ë¶€íŒŒì¼ ì´ë¦„Â·URL ë§¤í•‘)
 * - ì™¸ë¶€ ì›¹ ê³µê³  HWP/PDF â†’ Drive ë³€í™˜ â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ í›„ ìŠ¤ë§ˆíŠ¸ ë“±ë¡
 * - "ì™¸ë¶€ì‚¬ì´íŠ¸" / "ì™¸ë¶€ê³µê³ ì†ŒìŠ¤" ì‹œíŠ¸ì— ì ì–´ë‘” í˜ì´ì§€ì—ì„œ í›„ë³´ ìˆ˜ì§‘
 * - EAIS ì „ìš© íŒŒì„œ(ì°¸ê°€ë“±ë¡ë§ˆê° ê¸°ì¤€) + ì¼ë°˜ AI í•„í„° ë³´ì™„
 * - í†µê³„ ì €ì¥/ì¡°íšŒ, êµ¬ê¸€ ìº˜ë¦°ë” ë“±ë¡
 **************************************************************/

/**************************************************************
 * ğŸ”‘ í™˜ê²½ì„¤ì •
 **************************************************************/

// ë‚˜ë¼ì¥í„° OpenAPI í‚¤
var API_KEY =
  '9905ca4f96b64e977b48f71e78f281c254cf45a3bfeffef7a11e39113f60d4e2';

// Gemini API
var GEMINI_API_KEY =
  'AIzaSyAdBOlxwZXLo0687H-m14opRQHXYnVh4qw';
var GEMINI_MODEL_NAME = 'gemini-2.5-flash-lite';
var GEMINI_API_VERSION = 'v1beta';

// =======================================================
// âœ… ì„¤ì •ê°’ ë¡œë” (ìŠ¤í¬ë¦½íŠ¸ ì†ì„± ìš°ì„ , ì½”ë“œ ìƒìˆ˜ëŠ” ë°±ì—…)
// - ìŠ¤í¬ë¦½íŠ¸ ì†ì„± í‚¤ê°€ í™”ë©´ì— ë³´ì´ì‹  ê²ƒì²˜ëŸ¼ ë‹¤ì–‘í•œ í˜•íƒœë¡œ ì¡´ì¬í•  ìˆ˜ ìˆì–´
//   (ì˜ˆ: GEMINI_APIKEY vs GEMINI_API_KEY) ëª¨ë‘ í—ˆìš©í•©ë‹ˆë‹¤.
// =======================================================
function getScriptProp_(key) {
  try {
    return String(PropertiesService.getScriptProperties().getProperty(key) || '').trim();
  } catch (e) {
    return '';
  }
}

function pickFirstNonEmpty_() {
  for (var i = 0; i < arguments.length; i++) {
    var v = String(arguments[i] || '').trim();
    if (v) return v;
  }
  return '';
}

function getG2BApiKey_() {
  return pickFirstNonEmpty_(
    getScriptProp_('G2B_API_KEY'),
    getScriptProp_('API_KEY'),
    getScriptProp_('G2B_SERVICE_KEY'),
    API_KEY
  );
}

function getGeminiApiKey_() {
  return pickFirstNonEmpty_(
    getScriptProp_('GEMINI_API_KEY'),
    getScriptProp_('GEMINI_APIKEY'),
    getScriptProp_('GEMINI_KEY'),
    GEMINI_API_KEY
  );
}

function getGeminiModel_() {
  return pickFirstNonEmpty_(
    getScriptProp_('GEMINI_MODEL_NAME'),
    getScriptProp_('GEMINI_MODEL'),
    getScriptProp_('GEMINI_MODELNAME'),
    GEMINI_MODEL_NAME
  );
}

function getGeminiVersion_() {
  return pickFirstNonEmpty_(
    getScriptProp_('GEMINI_API_VERSION'),
    getScriptProp_('GEMINI_VERSION'),
    GEMINI_API_VERSION
  );
}

function getCalendarId_() {
  return pickFirstNonEmpty_(
    getScriptProp_('COMPANY_CALENDAR_ID'),
    getScriptProp_('TARGET_CALENDAR_ID'),
    getScriptProp_('CALENDAR_ID'),
    TARGET_CALENDAR_ID
  );
}


function _numOrDefault_(val, def) {
  var n = parseInt(String(val || '').replace(/[^0-9]/g, ''), 10);
  return (!isNaN(n) && n >= 0) ? n : def;
}

function getAiMaxItems_() {
  var sp = PropertiesService.getScriptProperties();
  var v = (sp.getProperty('AI_MAX_ITEMS') || sp.getProperty('MAX_AI_ITEMS') || '').trim();
  var n = _numOrDefault_(v, MAX_AI_ITEMS);
  return n > 0 ? n : MAX_AI_ITEMS;
}

function getGeminiGapMs_() {
  var sp = PropertiesService.getScriptProperties();
  var v = (sp.getProperty('GEMINI_GAP_MS') || '').trim();
  var n = _numOrDefault_(v, GEMINI_GAP_MS);
  return n;
}

function sleepGeminiGap_() {
  var ms = getGeminiGapMs_();
  if (ms > 0) Utilities.sleep(ms);
}

function shortErr_(e, maxLen) {
  maxLen = maxLen || 140;
  var s = '';
  try {
    s = (e && e.message) ? String(e.message) : String(e);
  } catch (ex) {
    s = 'unknown error';
  }
  s = s.replace(/\s+/g, ' ').trim();
  if (s.length > maxLen) s = s.substring(0, maxLen) + '...';
  return s;
}


// =======================================================
// 8ï¸âƒ£ Gemini 429 ê°ì§€/ë©”ì‹œì§€ ì •ë¦¬
// =======================================================
function isGemini429_(e) {
  var msg = String((e && (e.message || e)) || '');
  return msg.indexOf('HTTP 429') !== -1 || msg.indexOf(' 429') !== -1;
}

function extractGemini429Reason_(e) {
  var msg = String((e && (e.message || e)) || '');
  msg = msg.replace(/\s+/g, ' ').trim();
  if (msg.length > 180) msg = msg.substring(0, 180) + '...';
  if (/quota/i.test(msg) || /billing/i.test(msg) || /plan/i.test(msg)) {
    return 'ì¿¼í„°/ê²°ì œ ë¯¸ì„¤ì •(ë¬´ë£Œë“±ê¸‰) ê°€ëŠ¥ì„± ë†’ìŒ';
  }
  return 'ë ˆì´íŠ¸ë¦¬ë°‹(429) ê°€ëŠ¥ì„±';
}




// ìº˜ë¦°ë” (ì…ì°° ë§ˆê° ìº˜ë¦°ë” ID)
var TARGET_CALENDAR_ID =
  'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com';

// ìµœê·¼ ë©°ì¹ ì¹˜ ê³µê³  (ë‚˜ë¼ì¥í„° 1ì°¨ ìˆ˜ì§‘ìš©)
var DAYS_BACK = 7;

// ë„“ì€ í‚¤ì›Œë“œ (ë‚˜ë¼ì¥í„° 1ì°¨ ìˆ˜ì§‘ìš©)
var BROAD_KEYWORDS = [
  'ì €ë¥˜ì¡°',
  'ë¹—ë¬¼ì €ë¥˜',
  'ìš°ìˆ˜ì €ë¥˜',
  'ìš°ìˆ˜ë°°ìˆ˜',
  'ìš°ìˆ˜ê´€ë¡œ',
  'ë°°ìˆ˜íŒí”„ì¥',
  'ì¹¨ìˆ˜ë°©ì§€',
  'ë°°ìˆ˜ê°œì„ ',
  'í™ìˆ˜í„°',
  'ì„¤ê³„'
];

// 1ì°¨ ì œëª© í•„í„°
var DOMAIN_KEYWORDS = ['ì €ë¥˜', 'ìš°ìˆ˜', 'ë°°ìˆ˜', 'ì¹¨ìˆ˜', 'í™ìˆ˜', 'íŒí”„', 'ê´€ë¡œ', 'ìš°ìˆ˜ê´€', 'ë¬¼ìˆœí™˜'];

var NEGATIVE_TITLE_REGEXES = [
  /ì „ê¸°ìë™ì°¨\s*ì™„ì†ì¶©ì „ì‹œì„¤/i,
  /ì „ê¸°ì°¨\s*ì¶©ì „ì‹œì„¤/i,
  /íƒœì–‘ê´‘/i,
  /í’ë ¥ë°œì „/i,
  /ì§€ì—´ë°œì „/i
];

var SECONDARY_TITLE_REGEXES = [
  /ê°œì¶•ê³µì‚¬/i,
  /ì¦ì¶•/i,
  /ë¦¬ëª¨ë¸ë§/i,
  /ë¦¬ë…¸ë² ì´ì…˜/i,
  /ê°œì„ ê³µì‚¬/i,
  /ìš´ë™ì¥/i,
  /ì§€í•˜ì£¼ì°¨ì¥/i
];

// 1íšŒ ì—…ë°ì´íŠ¸ ì‹œ Gemini í˜¸ì¶œ ìƒí•œ (ê¸°ë³¸ê°’, ScriptPropertiesë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
var MAX_AI_ITEMS = 3; // AI_MAX_ITEMS ë˜ëŠ” MAX_AI_ITEMS

// Gemini í˜¸ì¶œ ê°„ê²©(ms) - 429(í• ë‹¹ëŸ‰/ë ˆì´íŠ¸ë¦¬ë°‹) ì™„í™”ìš©
var GEMINI_GAP_MS = 3000; // GEMINI_GAP_MS

// í†µê³„ ì €ì¥ìš© ScriptProperties í‚¤
var STATS_KEY = 'LAST_UPDATE_STATS';

// ê³µí†µ í˜ì¹˜ ì˜µì…˜
var FETCH_OPT = {
  muteHttpExceptions: true,
  followRedirects: true,
  headers: { 'User-Agent': 'Mozilla/5.0 (AppsScript)' }
};


// =======================================================
// ğŸ“˜ í•œêµ­ìˆ˜ì•ˆ ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë¡œí•„ (ê³µí†µ í”„ë¡¬í”„íŠ¸ìš©)
// =======================================================
var BUSINESS_PROFILE =
  'í•œêµ­ìˆ˜ì•ˆì€ ë¹—ë¬¼ê´€ë¦¬ ì‹œìŠ¤í…œ ë° ìš°ìˆ˜ìœ ì¶œì €ê°ì‹œì„¤ ì „ë¬¸ ê¸°ì—…ì´ë‹¤. ' +
  'ì£¼ìš” ì œí’ˆÂ·ê³µë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.\n' +
  '- PN ë¹—ë¬¼ì €ë¥˜ì¡°: í”Œë¼ìŠ¤í‹±Â·ë ˆì§„ì½˜í¬ë¦¬íŠ¸ ì ì¸µì‹ ì €ë¥˜ì¡°ë¡œ, ì§‘ì¤‘í˜¸ìš° ì‹œ ë¹—ë¬¼ì„ ì €ì¥í•´ í™ìˆ˜ ì˜ˆë°© ë° ì¡°ê²½ìš©ìˆ˜ ì¬ì´ìš©ì— í™œìš©. ' +
  '  ë†’ì€ ê³µê·¹ë¥ (ì•½ 95% ìˆ˜ì¤€)ì˜ ëª¨ë“ˆëŸ¬ êµ¬ì¡°ì´ë©°, ìƒë¶€ì— ì£¼ì°¨ì¥Â·ê³µì› ì¡°ì„±ì´ ê°€ëŠ¥í•˜ë„ë¡ ê³ ê°•ë„ ì„¤ê³„ë¥¼ ì„ í˜¸í•œë‹¤.\n' +
  '- SA ì¹¨íˆ¬ ë° ë¹„ì ì˜¤ì—¼ ì €ê° ì‹œìŠ¤í…œ: ì¹¨íˆ¬í˜• ë¹—ë¬¼ë°›ì´ ë° íŠ¸ë Œì¹˜ë¡œ ì´ˆê¸°ìš°ìˆ˜ì˜ ë¹„ì ì˜¤ì—¼ì›ì„ ì œê±°í•˜ê³  ì§€í•˜ìˆ˜ í•¨ì–‘ì„ ë•ëŠ” LID(ì €ì˜í–¥ê°œë°œ) ê¸°ë²•. ' +
  '- ë¹—ë¬¼ì´ìš© ì‹œìŠ¤í…œ: ì €ë¥˜ì¡°ì— ì €ì¥ëœ ë¬¼ì„ íŒí”„Â·ì œì–´ë°˜ìœ¼ë¡œ ì¡°ê²½Â·ì²­ì†Œ ë“±ì— ê³µê¸‰í•˜ëŠ” ì‹œìŠ¤í…œ.\n\n' +
  'ì£¼ìš” íƒ€ê²Ÿ í˜„ì¥ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.\n' +
  '- ê³µê³µê¸°ê´€Â·ì§€ìì²´Â·êµìœ¡ì²­Â·êµ°ë¶€ëŒ€ ë“± ëŒ€ì§€ë©´ì ì´ í° ê³µê³µ ê°œë°œ ì‚¬ì—…\n' +
  '- ì´ˆÂ·ì¤‘Â·ê³  ê°œì¶•/ê·¸ë¦°ìŠ¤ë§ˆíŠ¸ ë¯¸ë˜í•™êµ, ì²´ìœ¡ê´€Â·ìº í¼ìŠ¤ ì¡°ì„± ë“± êµìœ¡ ì‹œì„¤\n' +
  '- ê³µì›Â·ê³µì˜ì£¼ì°¨ì¥Â·ë„ì„œê´€Â·ì£¼ë¯¼ì„¼í„° ë“± ê³µê³µ í¸ì˜ì‹œì„¤\n' +
  '- ì•„íŒŒíŠ¸ ë‹¨ì§€, ëŒ€í˜• ë¬¼ë¥˜ì„¼í„°, ê³µì¥, ê³¨í”„ì¥, ì‚°ì—…ë‹¨ì§€Â·íƒì§€ ê°œë°œ ë“± ë¯¼ê°„ ëŒ€ê·œëª¨ ê°œë°œ\n\n' +
  'ì„ í˜¸ ê³µë²•ì€ RC í˜„ì¥íƒ€ì„¤ì´ ì•„ë‹ˆë¼ ì¡°ë¦½ì‹Â·ëª¨ë“ˆí˜• ê³µë²•ì´ë©°, ' +
  'ìš°ìˆ˜ìœ ì¶œì €ê°ì‹œì„¤, ë¹—ë¬¼ì €ë¥˜ì¡°, ì¹¨íˆ¬ì‹œì„¤, LID, ë…¹ìƒ‰ê±´ì¶•ì¸ì¦, ë¬¼ìˆœí™˜ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ì„¤ê³„/ê³µì‚¬ì— ë†’ì€ ê´€ì‹¬ì„ ê°€ì§„ë‹¤.\n' +
  'ë°˜ëŒ€ë¡œ ë‹¨ìˆœ í•˜ìˆ˜ê´€ ì¤€ì„¤, ë§¨í™€ ë³´ìˆ˜, ì†Œí˜• ê°€ì •ìš© ë¹—ë¬¼í†µ íŒë§¤, ì¼ë°˜ ë„ë¡œí¬ì¥ ë“±ì€ í•œêµ­ìˆ˜ì•ˆ ë¹„ì¦ˆë‹ˆìŠ¤ì™€ì˜ ê´€ë ¨ì„±ì´ ë‚®ë‹¤.\n\n' +
  'ê´€ë ¨ì„± ë“±ê¸‰ ê°€ì´ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.\n' +
  '- [ìƒ]: ë¹—ë¬¼ì €ë¥˜ì¡°Â·ìš°ìˆ˜ìœ ì¶œì €ê°ì‹œì„¤Â·LIDÂ·ë¹—ë¬¼ì´ìš© ì„¤ë¹„ê°€ ë²•ì  ì˜ë¬´ ë˜ëŠ” ì‚¬ì‹¤ìƒ í•„ìˆ˜ë¡œ ìš”êµ¬ë  ê°€ëŠ¥ì„±ì´ ë†’ê³ , ' +
  '  í•™êµÂ·ê³µì›Â·ê³µì˜ì£¼ì°¨ì¥Â·ëŒ€í˜• ê°œë°œì‚¬ì—… ë“±ì—ì„œ ìì‚¬ ì œí’ˆ ì œì•ˆ ì—¬ì§€ê°€ í° ê²½ìš°.\n' +
  '- [ì¤‘]: ì¹¨ìˆ˜ë°©ì§€Â·ë°°ìˆ˜ê°œì„ Â·í™˜ê²½ê°œì„  ë“±ìœ¼ë¡œ ë¹—ë¬¼ ê´€ë¦¬ ì‹œì„¤ì´ í¬í•¨ë  ì—¬ì§€ê°€ ìˆìœ¼ë‚˜ ê·œëª¨Â·ê³µë²•ì´ ë¶ˆë¶„ëª…í•œ ê²½ìš°.\n' +
  '- [í•˜]: ë‹¨ìˆœ ê´€ë¡œì •ë¹„, ì¤€ì„¤, ë§¨í™€ ë³´ìˆ˜ ë“±ìœ¼ë¡œ ì¡°ë¦½ì‹ ì €ë¥˜ì¡°Â·ì¹¨íˆ¬ì‹œì„¤ ì ìš©ì´ ì–´ë ¤ìš´ ê²½ìš°.\n' +
  'ë¬¸ì„œì— "ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±… ìˆ˜ë¦½ ëŒ€ìƒ", "ë…¹ìƒ‰ê±´ì¶•ì¸ì¦ ë¹—ë¬¼ê´€ë¦¬" ë“±ì´ ë³´ì´ë©´ í•œêµ­ìˆ˜ì•ˆê³¼ ë§¤ìš° ë†’ì€ ê´€ë ¨ì„±ì´ ìˆëŠ” [ìƒ]ìœ¼ë¡œ ë¶„ë¥˜í•œë‹¤.\n';


// =======================================================
// ê³µí†µ JSON ì‘ë‹µ í—¬í¼ / í†µê³„ í—¬í¼
// =======================================================
function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function saveUpdateStats_(stats) {
  try {
    PropertiesService.getScriptProperties().setProperty(
      STATS_KEY,
      JSON.stringify(stats)
    );
  } catch (e) {
    Logger.log('saveUpdateStats_ error: ' + e);
  }
}

function loadUpdateStats_() {
  try {
    var s = PropertiesService.getScriptProperties().getProperty(STATS_KEY);
    return s ? JSON.parse(s) : null;
  } catch (e) {
    Logger.log('loadUpdateStats_ error: ' + e);
    return null;
  }
}

function addComma_(num) {
  return String(num).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

function hasDigit_(s) {
  return /\d/.test(String(s || ''));
}

function resolveUrl_(base, href) {
  if (!href) return base;

  if (/^https?:\/\//i.test(href)) return href;
  if (href.indexOf('//') === 0) return 'https:' + href;

  var idx = base.indexOf('://');
  if (idx < 0) return href;

  var slashIndex = base.indexOf('/', idx + 3);
  var origin = slashIndex === -1 ? base : base.substring(0, slashIndex);

  if (href.charAt(0) === '/') {
    return origin + href;
  }

  var lastSlash = base.lastIndexOf('/');
  var baseDir = lastSlash > idx + 3
    ? base.substring(0, lastSlash + 1)
    : origin + '/';

  return baseDir + href;
}

function getXmlValue(item, tag) {
  try {
    var child = item.getChild(tag);
    return child ? (child.getText() || '').trim() : '';
  } catch (e) {
    return '';
  }
}

function parseG2BDate(str) {
  if (!str) return '';
  str = String(str).trim();

  // yyyy-mm-dd ë˜ëŠ” yyyy/mm/dd í˜•ì‹
  if (str.indexOf('-') >= 0 || str.indexOf('/') >= 0) {
    var d = new Date(str.replace(/-/g, '/'));
    if (!isNaN(d.getTime())) return d;
  }

  // yyyyMMddHHmm í˜•ì‹
  var y = str.substring(0, 4);
  var m = str.substring(4, 6);
  var d2 = str.substring(6, 8);
  var hh = str.length >= 12 ? str.substring(8, 10) : '00';
  var mm = str.length >= 12 ? str.substring(10, 12) : '00';

  var dt = new Date(+y, +m - 1, +d2, +hh, +mm);
  return isNaN(dt.getTime()) ? '' : dt;
}

function formatDate(v) {
  if (!v) return '';
  if (Object.prototype.toString.call(v) === '[object Date]') {
    if (isNaN(v.getTime())) return '';
    return Utilities.formatDate(v, 'Asia/Seoul', 'yyyy-MM-dd HH:mm');
  }
  return String(v);
}

function isClosedBid(deadlineDate) {
  if (!deadlineDate || Object.prototype.toString.call(deadlineDate) !== '[object Date]') {
    return false;
  }
  var now = new Date();
  return now.getTime() > deadlineDate.getTime();
}

// =======================================================
// 3ï¸âƒ£ ê¸°ë³¸ ì‹œíŠ¸ / í—¤ë” / ëª©ë¡ ì¡°íšŒ
// =======================================================
function ensureMainSheet_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('ì‹œíŠ¸1');
  if (!sheet) {
    sheet = ss.insertSheet('ì‹œíŠ¸1');
    initMainHeader_(sheet);
  }
  if (sheet.getLastRow() < 1) {
    initMainHeader_(sheet);
  }
  ensureMainSchema_(sheet);
  return sheet;
}

function initMainHeader_(sheet) {
  sheet.clearContents();
  sheet.appendRow([
    'ê³µê³ ë²ˆí˜¸',
    'ì§€ì—­',
    'ê³µê³ ëª…',
    'ê³µê³ ì¼',
    'ë§ˆê°ì¼',
    'ë°œì£¼ì²˜',
    'ìˆ˜ìš”ê¸°ê´€',
    'ìš©ì—­ê¸°ê°„',
    'ìš©ì—­ê¸ˆì•¡',
    'ì‚¬ì—…ë¹„',
    'ë°œì£¼ì²˜ë‹´ë‹¹ì(ì—°ë½ì²˜)',
    'ëŒ€ì§€ë©´ì (ã¡)',
    'ì˜ˆìƒí†¤ìˆ˜',
    'ë§í¬',
    'ìƒíƒœ',
    'AI ë¶„ì„ê²°ê³¼',
    'ì¡°ë¡€ê·¼ê±°',
    'ì ìš©ëŒ€ìƒ',
    'AIë³´ê³ ì„œURL',
    'ìº˜ë¦°ë”ID'
  ]);
}
// âœ… ì‹œíŠ¸1 ìŠ¤í‚¤ë§ˆ(ì—´) ìë™ ë³´ê°•: ê¸°ì¡´ 17ì—´ â†’ ì‹ ê·œ 20ì—´(ì¡°ë¡€ê·¼ê±°/ì ìš©ëŒ€ìƒ/AIë³´ê³ ì„œURL)
function ensureMainSchema_(sheet) {
  try {
    var header = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0] || [];
    var calIdx = header.indexOf('ìº˜ë¦°ë”ID'); // 0-based
    var hasOrdin = header.indexOf('ì¡°ë¡€ê·¼ê±°') !== -1;
    var hasAppl  = header.indexOf('ì ìš©ëŒ€ìƒ') !== -1;
    var hasRpt   = header.indexOf('AIë³´ê³ ì„œURL') !== -1;

    // ì •í™•íˆ ì˜› 17ì—´ ìŠ¤í‚¤ë§ˆ(ìº˜ë¦°ë”IDê¹Œì§€)ì´ê³  ì‹ ê·œ ì—´ì´ ì—†ë‹¤ë©´ ìº˜ë¦°ë”ID ì•ì— 3ì—´ ì‚½ì…
    if (calIdx !== -1 && !(hasOrdin && hasAppl && hasRpt)) {
      sheet.insertColumnsBefore(calIdx + 1, 3);
      sheet.getRange(1, calIdx + 1, 1, 3).setValues([['ì¡°ë¡€ê·¼ê±°', 'ì ìš©ëŒ€ìƒ', 'AIë³´ê³ ì„œURL']]);
    }

    // í—¤ë”ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš°(í˜¹ì€ ì—´ ë¶€ì¡±)ì—ëŠ” í‘œì¤€ í—¤ë”ë¡œ ë§ì¶¤
    var expected = [
      'ê³µê³ ë²ˆí˜¸','ì§€ì—­','ê³µê³ ëª…','ê³µê³ ì¼','ë§ˆê°ì¼','ë°œì£¼ì²˜','ìˆ˜ìš”ê¸°ê´€','ìš©ì—­ê¸°ê°„','ìš©ì—­ê¸ˆì•¡','ì‚¬ì—…ë¹„',
      'ë°œì£¼ì²˜ë‹´ë‹¹ì(ì—°ë½ì²˜)','ëŒ€ì§€ë©´ì (ã¡)','ì˜ˆìƒí†¤ìˆ˜','ë§í¬','ìƒíƒœ','AI ë¶„ì„ê²°ê³¼',
      'ì¡°ë¡€ê·¼ê±°','ì ìš©ëŒ€ìƒ','AIë³´ê³ ì„œURL','ìº˜ë¦°ë”ID'
    ];

    header = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0] || [];
    if (header.length < expected.length) {
      // ì—´ì´ ë¶€ì¡±í•˜ë©´ ì˜¤ë¥¸ìª½ì— ì¶”ê°€
      sheet.insertColumnsAfter(header.length, expected.length - header.length);
    }

    // í—¤ë”ëª…ì„ í‘œì¤€ìœ¼ë¡œ ë‹¤ì‹œ ì„¸íŒ…(ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€)
    sheet.getRange(1, 1, 1, expected.length).setValues([expected]);
  } catch (e) {
    Logger.log('ensureMainSchema_ error: ' + e);
  }
}

// í—¤ë”ëª…ìœ¼ë¡œ ì—´ ì¸ë±ìŠ¤(1-based) ì°¾ê¸°
function colIndex_(sheet, headerName) {
  var header = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0] || [];
  var idx = header.indexOf(headerName);
  return idx === -1 ? -1 : (idx + 1);
}


function listMainRows_() {
  var sheet = ensureMainSheet_();

  // ì²« ì‹¤í–‰ ì‹œ ìë™ ê°±ì‹ 
  if (sheet.getLastRow() <= 1) {
    updateBidData();
  }

  var values = sheet.getDataRange().getValues();
  if (values.length <= 1) {
    return jsonResponse({
      items: [],
      stats: loadUpdateStats_() || {}
    });
  }

  var result = [];
  for (var i = 1; i < values.length; i++) {
    var r = values[i];
    result.push({
      rowIndex: i + 1,
      no: r[0],
      region: r[1],
      title: r[2],
      date: formatDate(r[3]),
      deadline: formatDate(r[4]),
      client: r[5],
      agency: r[6],
      servicePeriod: r[7],
      serviceAmount: r[8],
      projectBudget: r[9],
      clientManager: r[10],
      siteArea: r[11],
      expectedTon: r[12],
      link: r[13],
      status: r[14],
      aiResult: r[15],
      ordinanceBasis: r[16] || '',
      applicability: r[17] || '',
      aiReportUrl: r[18] || '',
      calendarId: r[19] || ''
    });
  }

  // ìµœì‹  ë°ì´í„°ê°€ ë¨¼ì € ë³´ì´ë„ë¡ ì—­ìˆœ
  result.reverse();

  return jsonResponse({
    items: result,
    stats: loadUpdateStats_() || {}
  });
}


// =======================================================
// 4ï¸âƒ£ ë©”ì¸ ì§„ì…ì : doGet / doPost (ì•¡ì…˜ ë¼ìš°íŒ…)
// =======================================================
function doGet(e) {
  e = e || {};
  var p = e.parameter || {};
  var action = p.action || '';

  if (action === 'calendar_auth') return handleCalendarAuthPage_();
  if (action === 'add') return addDataToSheet(p);
  if (action === 'voiceSearch') return doVoiceSearch(p.query);
  if (action === 'analyze_file') {
    var fileUrl = p.url || '';
    var text = extractTextFromUrl(fileUrl);
    return jsonResponse({ result: 'success', text: text });
  }
  if (action === 'smart_add') return handleSmartAdd(p);
  if (action === 'deepAnalyze') return deepAnalyzeBid(p);
  if (action === 'generate_mitigation_doc') return generateMitigationDoc_(p);
  // (í˜¸í™˜) ê³¼ê±° ì•¡ì…˜ëª…
  if (action === 'generate_mitigation_report') return generateMitigationDoc_(p);
  if (action === 'external_update') return handleExternalUpdate_(); // ì™¸ë¶€ì‚¬ì´íŠ¸ ì‹œíŠ¸ ê¸°ë°˜
  if (action === 'updateAll') {
    updateBidData();
    var added2 = updateExternalFromSourceSheet(); // ì™¸ë¶€ê³µê³ ì†ŒìŠ¤ ì‹œíŠ¸ ê¸°ë°˜ ë¬¸ì„œë§í¬ ìˆ˜ì§‘
    return jsonResponse({
      result: 'success',
      externalAdded: added2,
      stats: loadUpdateStats_() || {}
    });
  }
  if (action === 'deleteRow') return deleteRowByIndex_(p);
  if (action === 'calendar_add') return addCalendarEventByRow_(p);
  if (action === 'stats') return jsonResponse(loadUpdateStats_() || {});
  if (action === 'update_eais') return updateFromEAIS_(p.url); // EAIS ì „ìš©(ë¦¬ìŠ¤íŠ¸ URL 1ê°œ)

  // ê¸°ë³¸: ì‹œíŠ¸1 ëª©ë¡ ë°˜í™˜
  return listMainRows_();
}

function doPost(e) {
  e = e || {};
  var p = {};

  if (e.postData && e.postData.type === 'application/json') {
    try {
      p = JSON.parse(e.postData.contents || '{}');
    } catch (err) {
      Logger.log('doPost JSON parse error: ' + err);
      p = {};
    }
  } else if (e.parameter) {
    p = e.parameter;
  }

  var action = p.action || '';

  if (action === 'smart_add') return handleSmartAdd(p);
  if (action === 'calendar_add') return addCalendarEventByRow_(p);
  if (action === 'voiceSearch') return doVoiceSearch(p.query);
  if (action === 'update_eais') return updateFromEAIS_(p.url);
  if (action === 'external_update') return handleExternalUpdate_();

  // ë‚˜ë¨¸ì§€ëŠ” doGet ë¡œì§ ì¬ì‚¬ìš©
  return doGet({ parameter: p });
}


// =======================================================
// 5ï¸âƒ£ ìº˜ë¦°ë” ê¶Œí•œ í™•ì¸ìš© HTML (íŒì—…)
// =======================================================
function handleCalendarAuthPage_() {
  try {
    var cal = CalendarApp.getCalendarById(getCalendarId_());
    if (cal) {
      var now = new Date();
      cal.getEvents(now, new Date(now.getTime() + 1));
    }
  } catch (e) {
    Logger.log('calendar_auth check error: ' + e);
  }

  var html =
    '<html><head><meta charset="UTF-8"></head>' +
    '<body style="font-family:-apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif;' +
    'font-size:13px;padding:24px;background:#0b1824;color:#ecf0f1;">' +
    '<h3>êµ¬ê¸€ ìº˜ë¦°ë” ì—°ë™ í™•ì¸</h3>' +
    '<p>ê¶Œí•œ ìŠ¹ì¸ íŒì—…ì´ ë–´ë‹¤ë©´ ì•ˆë‚´ì— ë”°ë¼ <b>í—ˆìš©</b>ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.<br>' +
    'ìŠ¹ì¸ì´ ëë‚˜ë©´ ì´ ì°½ì€ ê·¸ëƒ¥ ë‹«ìœ¼ì…”ë„ ë©ë‹ˆë‹¤.</p>' +
    '<p style="margin-top:16px;color:#95a5a6;">â€» ì´ í˜ì´ì§€ëŠ” ê¶Œí•œ í™•ì¸ìš©ì´ë©°, ' +
    'ì‹¤ì œ ë°ì´í„°ëŠ” ì›¹ ì•± í™”ë©´ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>' +
    '</body></html>';

  return HtmlService.createHtmlOutput(html);
}


// =======================================================
// 6ï¸âƒ£ ê¸°ë³¸ ìˆ˜ë™ ë“±ë¡ / ìŒì„± ê²€ìƒ‰ ìŠ¤í…
// =======================================================
function addDataToSheet(params) {
  var sheet = ensureMainSheet_();
  var row = [
    params.no || 'ì •ë³´ì—†ìŒ',
    params.region || '',
    params.title || 'ì œëª©ì—†ìŒ',
    params.date || '',
    params.deadline || '',
    params.client || 'ì§ì ‘ë“±ë¡',
    params.agency || 'ì§ì ‘ë“±ë¡',
    params.servicePeriod || '',
    params.serviceAmount || '',
    params.projectBudget || '',
    params.clientManager || '',
    params.siteArea || '',
    params.expectedTon || '',
    params.link || '#',
    params.status || 'ìˆ˜ë™ë“±ë¡',
    params.aiResult || 'AI ë¶„ì„ ëŒ€ê¸°ì¤‘',
    params.ordinanceBasis || '',
    params.applicability || '',
    params.aiReportUrl || '',
    params.calendarId || ''
  ];
  sheet.appendRow(row);
  return jsonResponse({
    result: 'success',
    storedNo: row[0],
    storedTitle: row[2]
  });
}

// (ì˜µì…˜) ìŒì„± ê²€ìƒ‰ ìŠ¤í…
function doVoiceSearch(query) {
  return jsonResponse({ result: 'not_implemented', query: query || '' });
}


// =======================================================
// 7ï¸âƒ£ ë‚˜ë¼ì¥í„° API ì—…ë°ì´íŠ¸ (1ì°¨ ìˆ˜ì§‘ + 1ì°¨ ìš”ì•½)
//      - ê¸°ì¡´ ë°ì´í„°(ì™¸ë¶€ì›¹/ìŠ¤ë§ˆíŠ¸ë“±ë¡/ì´ì „ ìˆ˜ì§‘ë¶„)ëŠ” ìœ ì§€
//      - ê³µê³ ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ ìƒˆ ê³µê³ ë§Œ ëˆ„ì  ì €ì¥
// =======================================================
function updateBidData() {
  var sheet = ensureMainSheet_(); // ë” ì´ìƒ initMainHeader_()ë¡œ ì „ì²´ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ

  var now = new Date();
  var start = new Date(now.getTime() - DAYS_BACK * 24 * 60 * 60 * 1000);

  var startStr = Utilities.formatDate(start, 'Asia/Seoul', 'yyyyMMdd') + '0000';
  var endStr = Utilities.formatDate(now, 'Asia/Seoul', 'yyyyMMdd') + '2359';

  // ì´ë¯¸ ì‹œíŠ¸ì— ì¡´ì¬í•˜ëŠ” ê³µê³ ë²ˆí˜¸(1ì—´)ë¥¼ ë¯¸ë¦¬ ìˆ˜ì§‘ â†’ ì¤‘ë³µ ë°©ì§€ìš©
  var existingNo = {};
  var lastRow = sheet.getLastRow();
  if (lastRow > 1) {
    var existingRange = sheet.getRange(2, 1, lastRow - 1, 1).getValues(); // Aì—´(ê³µê³ ë²ˆí˜¸)ë§Œ
    for (var r = 0; r < existingRange.length; r++) {
      var noVal = String(existingRange[r][0] || '').trim();
      if (noVal) existingNo[noVal] = true;
    }
  }

  var stats = {
    startedAt: now,
    startedAtText: Utilities.formatDate(now, 'Asia/Seoul', 'yyyy-MM-dd HH:mm'),
    finishedAt: null,
    finishedAtText: '',
    daysBack: DAYS_BACK,
    totalApiCalls: 0,
    totalItemsFromApi: 0,
    totalUnique: 0,
    totalNegativeExcluded: 0,
    totalPatternExcluded: 0,
    totalKept: 0,       // ì´ë²ˆ ì‹¤í–‰ì—ì„œ "ì‹ ê·œë¡œ" ìœ ì§€ëœ ê±´ìˆ˜
    totalAiCalls: 0,
    rowsWritten: 0,      // ì´ë²ˆ ì‹¤í–‰ì—ì„œ ìƒˆë¡œ ì‹œíŠ¸ì— ì¶”ê°€í•œ í–‰ ìˆ˜
    totalCountRaw: 0     // í‚¤ì›Œë“œë³„ totalCount ì¤‘ ìµœëŒ€ê°’
  };

  var unique = {};
  var k, i;

  // 1) í‚¤ì›Œë“œë³„ë¡œ ë‚˜ë¼ì¥í„° API í˜¸ì¶œ â†’ ê³µê³ ë²ˆí˜¸ ê¸°ì¤€ìœ¼ë¡œ unique ìˆ˜ì§‘
  for (k = 0; k < BROAD_KEYWORDS.length; k++) {
    var kw = BROAD_KEYWORDS[k];
    var url =
      'http://apis.data.go.kr/1230000/ad/BidPublicInfoService/getBidPblancListInfoCnstwk' +
      '?inqryDiv=1' +
      '&inqryBgnDt=' + startStr +
      '&inqryEndDt=' + endStr +
      '&numOfRows=50' +
      '&pageNo=1' +
      '&type=xml' +
      '&bidNtceNm=' + encodeURIComponent(kw) +
      '&ServiceKey=' + encodeURIComponent(getG2BApiKey_());

    Logger.log('REQUEST URL = ' + url);

    try {
      var res = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
      var code = res.getResponseCode();
      Logger.log('STATUS = ' + code);
      if (code !== 200) continue;

      stats.totalApiCalls++;

      var xml = XmlService.parse(res.getContentText());
      var root = xml.getRootElement();
      var body = root.getChild('body');

      var totalCount = body && body.getChildText('totalCount');
      var tc = parseInt(totalCount || '0', 10);
      if (!isNaN(tc) && tc > stats.totalCountRaw) {
        stats.totalCountRaw = tc;
      }

      var items = [];
      if (body && body.getChild('items')) {
        items = body.getChild('items').getChildren('item');
      }
      Logger.log('í‚¤ì›Œë“œ "' + kw + '" ì—ì„œ ë°›ì€ item ìˆ˜: ' + items.length);
      stats.totalItemsFromApi += items.length;

      for (i = 0; i < items.length; i++) {
        var item = items[i];
        var bidNo = getXmlValue(item, 'bidNtceNo');
        if (!bidNo) continue;

        // ì´ë²ˆ API í˜¸ì¶œ ë‚´ì—ì„œì˜ unique ì²˜ë¦¬ (ê¸°ì¡´ ì‹œíŠ¸ ì¤‘ë³µ ì—¬ë¶€ëŠ” ì•„ë˜ì—ì„œ ì²´í¬)
        if (!unique[bidNo]) {
          unique[bidNo] = { item: item, keyword: kw };
        }
      }
    } catch (e) {
      Logger.log('Keyword fetch error(' + kw + '): ' + e);
    }
  }

  var allKeys = Object.keys(unique);
  stats.totalUnique = allKeys.length;
  Logger.log('ì´ unique ê³µê³  ìˆ˜(ì´ë²ˆ API ê²°ê³¼ ê¸°ì¤€): ' + allKeys.length);

  var rows = [];
  var aiCount = 0;
  var aiBlocked = false;
  var aiBlockReason = '';

  // 2) í•„í„°ë§ + 1ì°¨ AI ìš”ì•½ + "ìƒˆ ê³µê³ ë§Œ" rows ë°°ì—´ì— ë‹´ê¸°
  for (i = 0; i < allKeys.length; i++) {
    var bidNoKey = allKeys[i];

    // ì´ë¯¸ ì‹œíŠ¸ì— ì¡´ì¬í•˜ëŠ” ê³µê³ ë²ˆí˜¸ë©´ ì´ë²ˆ ì‹¤í–‰ì—ì„œëŠ” ê±´ë„ˆëœ€ (ëˆ„ì  DB ìœ ì§€)
    if (existingNo[bidNoKey]) {
      continue;
    }

    var entry = unique[bidNoKey];
    var it = entry.item;

    var title = getXmlValue(it, 'bidNtceNm') || '';
    var client = getXmlValue(it, 'ntceInsttNm') || '';
    var demand = getXmlValue(it, 'dminsttNm') || '';

    var domainMatch = false;
    for (k = 0; k < DOMAIN_KEYWORDS.length; k++) {
      if (title.indexOf(DOMAIN_KEYWORDS[k]) !== -1) {
        domainMatch = true;
        break;
      }
    }

    var negative = false;
    for (k = 0; k < NEGATIVE_TITLE_REGEXES.length; k++) {
      if (NEGATIVE_TITLE_REGEXES[k].test(title)) {
        negative = true;
        break;
      }
    }

    var secondary = false;
    for (k = 0; k < SECONDARY_TITLE_REGEXES.length; k++) {
      if (SECONDARY_TITLE_REGEXES[k].test(title)) {
        secondary = true;
        break;
      }
    }

    if (negative) {
      stats.totalNegativeExcluded++;
      Logger.log('ë„¤ê±°í‹°ë¸Œ íŒ¨í„´ ì œì™¸: ' + title);
      continue;
    }

    if (!(domainMatch || secondary)) {
      stats.totalPatternExcluded++;
      Logger.log('ë„ë©”ì¸/2ì°¨ íŒ¨í„´ ë¯¸ì¼ì¹˜ ì œì™¸: ' + title);
      continue;
    }
    var summary = '';
    // 1ì°¨ ìë™ìš”ì•½ ëª¨ë“œ
    // - RULE(ê¸°ë³¸): Gemini ì—†ì´ ë£° ê¸°ë°˜ìœ¼ë¡œ ëª¨ë‘ ìš”ì•½(ë¬´ë£Œë“±ê¸‰ì—ì„œë„ ì•ˆì •ì )
    // - AI: ê¸°ì¡´ì²˜ëŸ¼ Geminië¡œ 1ì°¨ ìš”ì•½(ê²°ì œ/ì¿¼í„° í™•ë³´ í•„ìš”)
    if (getAutoSummaryMode_() === 'AI') {
    if (aiBlocked) {
      summary = '[ì¤‘] íŒ¨í„´ìƒ ê´€ë ¨ì„±ì€ ìˆìœ¼ë‚˜ AI ëŒ€ê¸°' + (aiBlockReason ? ' (' + aiBlockReason + ')' : '');
    } else if (aiCount < getAiMaxItems_()) {
      try {
        summary = askGeminiInference(title, client, demand);
        aiCount++;
        stats.totalAiCalls = aiCount;
        // ë ˆì´íŠ¸ë¦¬ë°‹(429) ì™„í™”: í˜¸ì¶œ ê°„ê²© ìœ ì§€
        sleepGeminiGap_();
      } catch (e2) {
        Logger.log('Gemini inference error: ' + e2);
        if (isGemini429_(e2)) {
          aiBlocked = true;
          aiBlockReason = extractGemini429Reason_(e2) || 'Gemini 429(ë ˆì´íŠ¸ë¦¬ë°‹/ì¿¼í„°)ë¡œ ìë™ë¶„ì„ ì¤‘ë‹¨';
          summary = '[ì¤‘] íŒ¨í„´ìƒ ê´€ë ¨ì„±ì€ ìˆìœ¼ë‚˜ AI ëŒ€ê¸° (' + aiBlockReason + ')';
        } else {
          summary = '[ì¤‘] íŒ¨í„´ìƒ ê´€ë ¨ì„±ì€ ìˆìœ¼ë‚˜ AI ë¶„ì„ ì‹¤íŒ¨ (' + shortErr_(e2, 120) + ')';
        }
      }
    } else {
      summary = '[ì¤‘] íŒ¨í„´ìƒ ê´€ë ¨ì„± ìˆìŒ (AI ë¶„ì„ í•œë„ ì´ˆê³¼)';
    }
    } else {
      summary = ruleSummarizeBidFromXml_(it);
    }
    var row = formatBidItemFromXml(it, summary);
    rows.push(row);
    stats.totalKept++; // ì´ë²ˆ ì‹¤í–‰ì—ì„œ "ì‹ ê·œ"ë¡œ ìœ ì§€ëœ ê±´ìˆ˜
  }

  // 3) ì‹œíŠ¸1ì˜ ê¸°ì¡´ ë°ì´í„° ë’¤ì— "ì‹ ê·œ ê³µê³ "ë“¤ë§Œ ì´ì–´ë¶™ì´ê¸°
  if (rows.length > 0) {
    var startRow = sheet.getLastRow() + 1;
    sheet
      .getRange(startRow, 1, rows.length, rows[0].length)
      .setValues(rows);
  }

  stats.rowsWritten = rows.length;
  stats.finishedAt = new Date();
  stats.finishedAtText = Utilities.formatDate(
    stats.finishedAt,
    'Asia/Seoul',
    'yyyy-MM-dd HH:mm'
  );

  saveUpdateStats_(stats);
}

// =======================================================
// 5-b) (ë¬´ë£Œë“±ê¸‰ ëŒ€ì‘) ë£° ê¸°ë°˜ 1ì°¨ ìë™ìš”ì•½
//   - Gemini í˜¸ì¶œ ì—†ì´ "ë‹¤ ìš”ì•½ì²˜ëŸ¼" ë³´ì´ë„ë¡ ì§§ê²Œ ì •ë¦¬
//   - ê³ ë¹„ìš©(ì§€ì‹í´ë”/ì¡°ë¡€/ì‚°ì •)ì€ 2ì°¨ ì‹¬í™”ë¶„ì„ ë²„íŠ¼ì—ì„œë§Œ ìˆ˜í–‰
// =======================================================
function getAutoSummaryMode_() {
  // 'RULE' (ê¸°ë³¸) | 'AI'
  // - ë¬´ë£Œë“±ê¸‰/429 ì¦ìœ¼ë©´ RULE ê¶Œì¥
  // - ê²°ì œ/ì¿¼í„° í™•ë³´ë˜ë©´ AIë¡œ ì „í™˜ ê°€ëŠ¥
  var v = (PropertiesService.getScriptProperties().getProperty('AUTO_SUMMARY_MODE') || '').trim();
  if (!v) v = 'RULE';
  v = String(v).toUpperCase();
  if (v !== 'AI' && v !== 'RULE') v = 'RULE';
  return v;
}

function ruleSummarizeBidFromXml_(item) {
  var title  = String(getXmlValue(item, 'bidNtceNm') || '').trim();
  var client = String(getXmlValue(item, 'ntceInsttNm') || '').trim();
  var agency = String(getXmlValue(item, 'dminsttNm') || '').trim();
  var region =
    String(getXmlValue(item, 'prtcptLmtRgnNm') || '').trim();

  // í‚¤ì›Œë“œ(ê°•/ì¤‘/ì•½) â€” í•„ìš” ì‹œ ì—¬ê¸°ë§Œ ì¡°ì •í•˜ë©´ ë©ë‹ˆë‹¤.
  var strongPos = [
    'ì €ë¥˜', 'ì €ë¥˜ì¡°', 'ìš°ìˆ˜', 'ìš°ìˆ˜ê´€', 'ìš°ìˆ˜ìœ ì¶œ', 'ì €ê°', 'ë¹—ë¬¼', 'ë¹—ë¬¼ì¬ì´ìš©',
    'ì¹¨ìˆ˜', 'ë°°ìˆ˜', 'ë°°ìˆ˜ê°œì„ ', 'í•˜ìˆ˜ë„', 'í•˜ìˆ˜', 'ìš°ìˆ˜í† ì‹¤', 'íŒí”„ì¥', 'íŒí”„', 'ì›”ë¥˜'
  ];
  var midPos = [
    'ì„¤ê³„', 'ì •ë¹„', 'ê°œì„ ', 'ì •ë¹„ê³µì‚¬', 'ê°œëŸ‰', 'ë„ë¡œ', 'í•˜ì²œ', 'ê³µì›', 'ì£¼ì°¨ì¥',
    'ìš´ë™ì¥', 'í•™êµ', 'ë‹¨ì§€', 'ê°œì¶•', 'ì¦ì¶•', 'ë¦¬ëª¨ë¸ë§', 'ì§€í•˜', 'ë°°ìˆ˜ë¡œ'
  ];
  var negKw = [
    'ìŠ¹ê°•ê¸°', 'ì—˜ë¦¬ë² ì´í„°', 'ì „ê¸°', 'í†µì‹ ', 'cctv', 'ì†Œë°©', 'ì¡°ëª…', 'ë°©ì†¡',
    'ëƒ‰ë‚œë°©', 'ë³´ì¼ëŸ¬', 'ê°€ìŠ¤', 'ì¸í…Œë¦¬ì–´', 'ë„ì¥', 'ë„ë°°', 'ì „ì‚°', 'ë„¤íŠ¸ì›Œí¬', 'íƒœì–‘ê´‘'
  ];

  function countHits(list) {
    var c = 0;
    for (var i = 0; i < list.length; i++) {
      if (title.indexOf(list[i]) !== -1) c++;
    }
    return c;
  }

  var strongHit = countHits(strongPos);
  var midHit = countHits(midPos);
  var negHit = countHits(negKw);

  var grade = 'ì¤‘';
  var reason = '';

  if (strongHit >= 2 || title.indexOf('ì €ë¥˜ì¡°') !== -1 || title.indexOf('ìš°ìˆ˜ìœ ì¶œ') !== -1) {
    grade = 'ìƒ';
    reason = 'ìš°ìˆ˜/ì €ë¥˜/ë°°ìˆ˜ ê´€ë ¨ í‚¤ì›Œë“œê°€ ë³µìˆ˜ í¬í•¨ë˜ì–´ ì˜ì—… íƒ€ê¹ƒ ê°€ëŠ¥ì„±ì´ ë†’ìŒ.';
  } else if (strongHit >= 1) {
    grade = 'ì¤‘';
    reason = 'ìš°ìˆ˜/ë°°ìˆ˜/ì¹¨ìˆ˜ ë“± í•µì‹¬ í‚¤ì›Œë“œê°€ ì¼ë¶€ í¬í•¨ë˜ì–´ ê²€í†  ê°€ì¹˜ê°€ ìˆìŒ.';
  } else if (negHit >= 1 && midHit <= 1) {
    grade = 'í•˜';
    reason = 'ì „ê¸°/ì„¤ë¹„/í†µì‹  ë“± ì‹œì„¤ ì„±ê²©ì´ ê°•í•´ ìš°ìˆ˜ìœ ì¶œì €ê°Â·ë¹—ë¬¼ ê´€ë ¨ì„±ê³¼ ë‚®ì„ ê°€ëŠ¥ì„±ì´ í¼.';
  } else if (midHit >= 1) {
    grade = 'ì¤‘';
    reason = 'ì¦ì¶•/ë¦¬ëª¨ë¸ë§/ë‹¨ì§€ ë“± ê°œë°œ íŒ¨í„´ìœ¼ë¡œ ë©´ì Â·ì¡°ë¡€ ì¡°ê±´ì— ë”°ë¼ ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŒ.';
  } else {
    grade = 'ì¤‘';
    reason = 'ì œëª© íŒ¨í„´ìƒ ê´€ë ¨ ê°€ëŠ¥ì„±ì€ ìˆìœ¼ë‚˜ ì •ë³´ê°€ ë¶€ì¡±í•˜ì—¬ 2ì°¨ í™•ì¸ì´ í•„ìš”.';
  }

  // â€œë‹¤ ìš”ì•½ì²˜ëŸ¼â€ ë³´ì´ë„ë¡ 1~2ë¬¸ì¥ + ë‹¤ìŒ ì•¡ì…˜ë§Œ ì œì‹œ
  var head = '[' + grade + '] ';
  var org = '';
  if (client || agency) {
    org = ' (ë°œì£¼: ' + (client || '-') + (agency ? ' / ìˆ˜ìš”: ' + agency : '') + ')';
  }
  var loc = region ? (' / ì§€ì—­: ' + region) : '';

  var msg =
    head + reason + '\n' +
    'â†’ 2ì°¨ ì‹¬í™” ë¶„ì„ì—ì„œ (1)ë©´ì (â‰¤5,000/â‰¤7,000) (2)ì§€ìì²´ ì¡°ë¡€(ë¹—ë¬¼ì¬ì´ìš©Â·ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±…) (3)ì €ë¥˜ìš©ëŸ‰ ì‚°ì •/ë©˜íŠ¸ ê°€ì´ë“œë¥¼ í™•ì¸ ê¶Œì¥.' +
    org + loc;

  return msg;
}


// =======================================================
// ë‚˜ë¼ì¥í„° XML item â†’ ì‹œíŠ¸1 í•œ í–‰ìœ¼ë¡œ ë³€í™˜
//   - ì‹œíŠ¸1 í—¤ë” ìˆœì„œ:
//     ê³µê³ ë²ˆí˜¸, ì§€ì—­, ê³µê³ ëª…, ê³µê³ ì¼, ë§ˆê°ì¼, ë°œì£¼ì²˜, ìˆ˜ìš”ê¸°ê´€,
//     ìš©ì—­ê¸°ê°„, ìš©ì—­ê¸ˆì•¡, ì‚¬ì—…ë¹„, ë°œì£¼ì²˜ë‹´ë‹¹ì(ì—°ë½ì²˜),
//     ëŒ€ì§€ë©´ì (ã¡), ì˜ˆìƒí†¤ìˆ˜, ë§í¬, ìƒíƒœ, AI ë¶„ì„ê²°ê³¼, ìº˜ë¦°ë”ID
// =======================================================
function formatBidItemFromXml(item, aiSummary) {
  // 1) ê¸°ë³¸ í•„ë“œ ì¶”ì¶œ
  var no     = getXmlValue(item, 'bidNtceNo') || 'ì •ë³´ì—†ìŒ';
  var title  = getXmlValue(item, 'bidNtceNm') || 'ì œëª©ì—†ìŒ';
  var client = getXmlValue(item, 'ntceInsttNm') || ''; // ë°œì£¼ì²˜
  var agency = getXmlValue(item, 'dminsttNm') || '';   // ìˆ˜ìš”ê¸°ê´€

  // 2) ì§€ì—­(ì—†ìœ¼ë©´ ì¼ë‹¨ ë¹ˆ ê°’, ë‚˜ì¤‘ì— í•„ìš”ì‹œ ë³´ì™„)
  var region =
    getXmlValue(item, 'prtcptLmtRgnNm') || // ìˆìœ¼ë©´ ì‚¬ìš©
    '';

  // 3) ê³µê³ ì¼ / ë§ˆê°ì¼
  var noticeRaw = getXmlValue(item, 'bidNtceDt') || getXmlValue(item, 'ntceDt') || '';
  var closeRaw  = getXmlValue(item, 'bidClseDt') || '';

  var noticeDt = noticeRaw ? parseG2BDate(noticeRaw) : '';
  var closeDt  = closeRaw  ? parseG2BDate(closeRaw)  : '';

  // 4) ì¶”ì •ê¸ˆì•¡ (presmptPrce) â†’ ìˆ«ì/ì½¤ë§ˆ ì¶”ê°€
  var amtRaw  = getXmlValue(item, 'presmptPrce') || '';
  var amtText = '';
  if (amtRaw) {
    var n = parseInt(String(amtRaw).replace(/[^0-9]/g, ''), 10);
    if (!isNaN(n) && n > 0) {
      amtText = addComma_(n) + 'ì›';
    }
  }

  // 5) ìƒì„¸í˜ì´ì§€ ë§í¬
  var link =
    getXmlValue(item, 'bidNtceDtlUrl') || // ë³´í†µ ì—¬ê¸°
    '';

  // 6) ì‹œíŠ¸1 í•œ í–‰ êµ¬ì„± (ë°˜ë“œì‹œ 20ê°œ ì»¬ëŸ¼)
  return [
    no,                     // ê³µê³ ë²ˆí˜¸
    region,                 // ì§€ì—­
    title,                  // ê³µê³ ëª…
    noticeDt || '',         // ê³µê³ ì¼ (Date ë˜ëŠ” ë¹ˆë¬¸ìì—´)
    closeDt || '',          // ë§ˆê°ì¼ (Date ë˜ëŠ” ë¹ˆë¬¸ìì—´)
    client,                 // ë°œì£¼ì²˜
    agency,                 // ìˆ˜ìš”ê¸°ê´€
    '',                     // ìš©ì—­ê¸°ê°„ (2ì°¨ ë¶„ì„ì—ì„œ ë³´ì™„)
    amtText,                // ìš©ì—­ê¸ˆì•¡ (ì¶”ì •ê¸ˆì•¡ ê¸°ë°˜)
    '',                     // ì‚¬ì—…ë¹„
    '',                     // ë°œì£¼ì²˜ë‹´ë‹¹ì(ì—°ë½ì²˜)
    '',                     // ëŒ€ì§€ë©´ì (ã¡)
    '',                     // ì˜ˆìƒí†¤ìˆ˜
    link || '#',            // ë§í¬
    'ì‹ ê·œìˆ˜ì§‘(API)',        // ìƒíƒœ
    aiSummary || '',        // AI ë¶„ì„ê²°ê³¼
    '',                     // ì¡°ë¡€ê·¼ê±°
    '',                     // ì ìš©ëŒ€ìƒ
    '',                     // AIë³´ê³ ì„œURL
    ''                      // ìº˜ë¦°ë”ID
  ];
}


// =======================================================
// 8ï¸âƒ£ Gemini í˜¸ì¶œ ë„ìš°ë¯¸ (í…ìŠ¤íŠ¸ / JSON)
// =======================================================

function callGeminiText(prompt) {
  var apiKey = getGeminiApiKey_();
  if (!apiKey) {
    throw new Error('Gemini API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. (ìŠ¤í¬ë¦½íŠ¸ ì†ì„±: GEMINI_APIKEY ë˜ëŠ” GEMINI_API_KEY)');
  }

  // ëª¨ë¸/ë²„ì „ì€ ìŠ¤í¬ë¦½íŠ¸ ì†ì„±ìœ¼ë¡œë„ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥
  var primaryVersion = getGeminiVersion_() || 'v1beta';
  var primaryModel = getGeminiModel_() || 'gemini-1.5-flash';

  // ì‹¤íŒ¨ ì‹œ ìë™ í´ë°±(ë²„ì „/ëª¨ë¸)
  var versions = [];
  [primaryVersion, 'v1beta', 'v1'].forEach(function (v) {
    if (v && versions.indexOf(v) === -1) versions.push(v);
  });

  var models = [];
  [primaryModel, 'gemini-2.0-flash', 'gemini-1.5-flash', 'gemini-1.5-pro'].forEach(function (m) {
    if (m && models.indexOf(m) === -1) models.push(m);
  });

  // í”„ë¡¬í”„íŠ¸ê°€ ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ì„œ 400 ë°©ì§€
  var p = String(prompt || '');
  if (p.length > 28000) p = p.substring(0, 28000) + '\n...(ì´í›„ ìƒëµ: ê¸¸ì´ ì œí•œ)';

  // ì¬ì‹œë„/ë°±ì˜¤í”„ ì„¤ì • (429/5xx ëŒ€ì‘)
  var sp = PropertiesService.getScriptProperties();
  var maxRetries = _numOrDefault_(sp.getProperty('GEMINI_RETRIES'), 3);
  if (maxRetries < 1) maxRetries = 1;
  if (maxRetries > 5) maxRetries = 5;

  var baseBackoff = _numOrDefault_(sp.getProperty('GEMINI_BACKOFF_MS'), 800);
  if (baseBackoff < 200) baseBackoff = 200;
  if (baseBackoff > 4000) baseBackoff = 4000;

  var lastErrs = [];

  for (var vi = 0; vi < versions.length; vi++) {
    for (var mi = 0; mi < models.length; mi++) {
      var ver = versions[vi];
      var model = models[mi];

      var url =
        'https://generativelanguage.googleapis.com/' +
        ver +
        '/models/' +
        model +
        ':generateContent?key=' +
        encodeURIComponent(apiKey);

      for (var ri = 0; ri < maxRetries; ri++) {
        var res, body, code;

        try {
          res = UrlFetchApp.fetch(url, {
            method: 'post',
            contentType: 'application/json',
            payload: JSON.stringify({
              contents: [{ parts: [{ text: p }] }],
              generationConfig: {
                temperature: 0.2,
                maxOutputTokens: 512
              }
            }),
            muteHttpExceptions: true
          });
          code = res.getResponseCode();
          body = res.getContentText() || '';
        } catch (e) {
          var fe = 'UrlFetch ì˜ˆì™¸(' + ver + '/' + model + '): ' + shortErr_(e, 180);
          lastErrs.push(fe);
          break; // ë‹¤ë¥¸ ëª¨ë¸/ë²„ì „ ì‹œë„
        }

        if (code === 200) {
          // ì„±ê³µ
          var json = {};
          try {
            json = JSON.parse(body);
          } catch (pe) {
            lastErrs.push('Gemini 200 JSON íŒŒì‹± ì‹¤íŒ¨(' + ver + '/' + model + '): ' + shortErr_(pe, 120));
            break;
          }

          var text =
            json.candidates &&
            json.candidates[0] &&
            json.candidates[0].content &&
            json.candidates[0].content.parts &&
            json.candidates[0].content.parts[0] &&
            json.candidates[0].content.parts[0].text;

          text = (text || '').trim();
          if (!text) {
            lastErrs.push('Gemini 200 ì‘ë‹µì´ ë¹„ì–´ìˆìŒ(' + ver + '/' + model + ')');
            break;
          }
          return text;
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ì¶œ(ìµœëŒ€ 300ì)
        var msg = '';
        try {
          var ej = JSON.parse(body);
          msg =
            (ej && ej.error && (ej.error.message || ej.error.status))
              ? String(ej.error.message || ej.error.status)
              : '';
        } catch (e2) {
          msg = body ? String(body) : '';
        }
        msg = msg.replace(/\s+/g, ' ').trim();
        if (msg.length > 300) msg = msg.substring(0, 300) + '...';

        var errLine = 'Gemini HTTP ' + code + ' (' + ver + '/' + model + '): ' + (msg || '(no body)');

        // 401ì€ í‚¤ ë¬¸ì œì¼ ê°€ëŠ¥ì„±ì´ ë§¤ìš° í¼ â†’ ì¦‰ì‹œ ì¢…ë£Œ
        if (code === 401) {
          throw new Error(errLine);
        }

        // 429/5xxëŠ” ë ˆì´íŠ¸ë¦¬ë°‹/ì¼ì‹œ ì¥ì•  ê°€ëŠ¥ì„± â†’ ë°±ì˜¤í”„ ì¬ì‹œë„
        if (code === 429 || code === 500 || code === 503) {
          lastErrs.push(errLine);

          // 429 ì¤‘ì—ì„œë„ "ì¿¼í„°/ê²°ì œ" ë¬¸êµ¬ê°€ ë‚˜ì˜¤ë©´(ë¬´ë£Œë“±ê¸‰/í• ë‹¹ëŸ‰ 0 ë“±) ì¬ì‹œë„/í´ë°±ì´ ì˜ë¯¸ ì—†ìŒ â†’ ì¦‰ì‹œ ì¢…ë£Œ
          if (code === 429 && (/(quota|billing|plan)/i).test(String(msg || ''))) {
            throw new Error(errLine);
          }

          // ë§ˆì§€ë§‰ ì¬ì‹œë„ê¹Œì§€ 429ë©´ ëª¨ë¸/ë²„ì „ í´ë°±ì„ í•˜ì§€ ì•Šê³  ì¦‰ì‹œ ì¢…ë£Œ(404 í˜¼ì„  ë°©ì§€)
          if (code === 429 && ri >= (maxRetries - 1)) {
            throw new Error(errLine);
          }

          var wait = baseBackoff * Math.pow(2, ri) + Math.floor(Math.random() * 200);
          // ë„ˆë¬´ ì˜¤ë˜ ê¸°ë‹¤ë¦¬ì§€ ì•Šë„ë¡ ìƒí•œ
          if (wait > 8000) wait = 8000;
          Utilities.sleep(wait);
          continue;
        }

        // ê·¸ ì™¸(400/403/404 ë“±)ëŠ” ë‹¤ìŒ ëª¨ë¸/ë²„ì „ ì‹œë„
        lastErrs.push(errLine);
        break;
      }

      // ëª¨ë¸/ë²„ì „ ë³€ê²½ ì „ ê°„ê²© ìœ ì§€(í­ì£¼ ë°©ì§€)
      sleepGeminiGap_();
    }
  }

  // ë§ˆì§€ë§‰ ì—ëŸ¬ 3ê°œë§Œ ìš”ì•½
  var tail = lastErrs.length ? lastErrs.slice(-3).join(' | ') : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
  throw new Error('Gemini í˜¸ì¶œ ì‹¤íŒ¨: ' + tail);
}


function callGeminiJson(prompt) {
  var text = callGeminiText(prompt);
  text = String(text || '').replace(/```json|```/g, '').trim();

  try {
    return JSON.parse(text);
  } catch (e) {
    // JSONì´ ì•„ë‹ ë•ŒëŠ” rawë¡œë¼ë„ ë‚´ë ¤ì„œ í”„ë¡ íŠ¸ì—ì„œ í‘œì‹œ ê°€ëŠ¥í•˜ê²Œ í•¨
    var start = text.indexOf('{');
    var end = text.lastIndexOf('}');
    if (start !== -1 && end !== -1 && end > start) {
      var sliced = text.substring(start, end + 1);
      try {
        return JSON.parse(sliced);
      } catch (e2) {
        return { rawText: text, _parseError: 'JSON íŒŒì‹± ì‹¤íŒ¨(sliced): ' + e2.message };
      }
    }
    return { rawText: text, _parseError: 'JSON íŒŒì‹± ì‹¤íŒ¨(raw): ' + e.message };
  }
}

function askGeminiInference(title, client, demand) {
  var prompt =
    'ë‹¤ìŒì€ í•œêµ­ìˆ˜ì•ˆì˜ ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë¡œí•„ì´ë‹¤.\n' +
    BUSINESS_PROFILE +
    '\n\n' +
    'ì—­í• : í•œêµ­ìˆ˜ì•ˆ(ë¹—ë¬¼ì €ë¥˜ì¡°Â·ìš°ìˆ˜Â·ì¹¨ìˆ˜ë°©ì§€ ì „ë¬¸ ì‹œê³µì‚¬) ì˜ì—… ë‹´ë‹¹ì.\n' +
    'ì•„ë˜ ì…ì°° ê³µê³ ê°€ í•œêµ­ìˆ˜ì•ˆ ì‚¬ì—…ê³¼ ì–¼ë§ˆë‚˜ ê´€ë ¨ì´ ìˆëŠ”ì§€ íŒë‹¨í•˜ë¼.\n\n' +
    'ê³µê³ ëª…: ' + title + '\n' +
    'ë°œì£¼ì²˜: ' + client + '\n' +
    'ìˆ˜ìš”ê¸°ê´€: ' + demand + '\n\n' +
    '1) ê´€ë ¨ì„±ì„ "ìƒ", "ì¤‘", "í•˜" ì¤‘ í•˜ë‚˜ë¡œ ê³ ë¥´ê³ ,\n' +
    '2) ê·¸ ì´ìœ ë¥¼ 1~2ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•˜ë¼.\n' +
    '3) ì‘ë‹µì€ ë°˜ë“œì‹œ í•œ ì¤„ í…ìŠ¤íŠ¸ë¡œë§Œ, ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥:\n' +
    '[ìƒ] í•™êµ ê°œì¶•ì— ë”°ë¥¸ ìš´ë™ì¥ ì§€í•˜ ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ìŒ.\n';

  var text = callGeminiText(prompt);
  if (!/^\[[ìƒì¤‘í•˜]\]/.test(text)) {
    text = '[ì¤‘] ' + text;
  }
  return text;
}


// =======================================================
// 9ï¸âƒ£ íŒŒì¼ URL/Drive â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ
// =======================================================
function extractTextFromUrl(fileUrl) {
  if (!fileUrl) return '';

  try {
    var driveId = parseDriveFileIdFromUrl_(fileUrl);
    if (driveId) {
      return extractTextFromDriveFile_(driveId);
    }

    var res = UrlFetchApp.fetch(fileUrl, FETCH_OPT);
    var code = res.getResponseCode();
    if (code !== 200) {
      Logger.log('File Download Failed: ' + code + ' / ' + fileUrl);
      return 'íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (HTTP ' + code + ')';
    }

    var blob = res.getBlob();
    var cfg = {
      title: 'temp_extract_' + new Date().getTime(),
      mimeType: 'application/vnd.google-apps.document'
    };

    var newFile;
    try {
      // OCR ì¼œë³´ê³  ì•ˆ ë˜ë©´ ì¼ë°˜ ë³€í™˜
      newFile = Drive.Files.insert(cfg, blob, { convert: true, ocr: true });
    } catch (e) {
      newFile = Drive.Files.insert(cfg, blob, { convert: true });
    }

    if (!newFile || !newFile.id) {
      throw new Error('Drive ë³€í™˜ ì‹¤íŒ¨');
    }

    var doc = DocumentApp.openById(newFile.id);
    var text = doc.getBody().getText() || '';
    Drive.Files.remove(newFile.id);

    if (!text.trim()) {
      return 'ë³¸ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
    }
    if (text.length > 20000) {
      text = text.substring(0, 20000) + ' ...(ì´í›„ ìƒëµ)';
    }
    return text;
  } catch (e2) {
    Logger.log('File Extract Error: ' + e2);
    return 'íŒŒì¼ ë‚´ìš© ì¶”ì¶œ ì‹¤íŒ¨: ' + e2.message;
  }
}

function parseDriveFileIdFromUrl_(url) {
  if (!url) return '';
  var m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (m && m[1]) return m[1];
  m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (m && m[1]) return m[1];
  return '';
}

function extractTextFromDriveFile_(fileId) {
  try {
    var meta = Drive.Files.get(fileId);
    if (meta.mimeType === 'application/vnd.google-apps.document') {
      var doc = DocumentApp.openById(fileId);
      var t = doc.getBody().getText() || '';
      if (!t) return 'ë³¸ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      if (t.length > 20000) t = t.substring(0, 20000) + ' ...(ì´í›„ ìƒëµ)';
      return t;
    }

    var blob = DriveApp.getFileById(fileId).getBlob();
    var newFile = Drive.Files.insert(
      {
        title: 'temp_drive_' + new Date().getTime(),
        mimeType: 'application/vnd.google-apps.document'
      },
      blob,
      { convert: true }
    );

    var doc2 = DocumentApp.openById(newFile.id);
    var text = doc2.getBody().getText() || '';
    Drive.Files.remove(newFile.id);

    if (!text) return 'ë³¸ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
    if (text.length > 20000) text = text.substring(0, 20000) + ' ...(ì´í›„ ìƒëµ)';
    return text;
  } catch (e) {
    Logger.log('Drive File Extract Error: ' + e);
    return 'íŒŒì¼ ë‚´ìš© ì¶”ì¶œ ì‹¤íŒ¨: ' + e.message;
  }
}


// =======================================================
// ğŸ”Ÿ ìŠ¤ë§ˆíŠ¸ ë“±ë¡ (í…ìŠ¤íŠ¸/íŒŒì¼ â†’ AI â†’ ì‹œíŠ¸1 ì €ì¥)
// =======================================================
function handleSmartAdd(p) {
  var baseText = (p.text || '').trim();
  var fileUrlRaw = (p.fileUrl || '').trim();

  var urls = [];
  if (fileUrlRaw) {
    urls = fileUrlRaw
      .split(/[\n,]+/)
      .map(function (u) { return u.trim(); })
      .filter(function (u) { return u; });
  }

  var combinedFileText = '';
  var fileNotes = [];
  var primaryUrl = urls.length ? urls[0] : (fileUrlRaw || '');

  // ì²¨ë¶€íŒŒì¼ë“¤ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
  for (var i = 0; i < urls.length; i++) {
    var u = urls[i];
    var t = extractTextFromUrl(u);
    if (
      /^íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨/.test(t) ||
      /^íŒŒì¼ ë‚´ìš© ì¶”ì¶œ ì‹¤íŒ¨/.test(t) ||
      /^ë³¸ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤/.test(t)
    ) {
      fileNotes.push(u + ': ' + t);
    } else {
      combinedFileText +=
        (combinedFileText ? '\n\n' : '') +
        '[ì²¨ë¶€íŒŒì¼ ' + (i + 1) + ' ' + u + ']\n' + t;
    }
  }

  var combined =
    (baseText ? '[ì‚¬ìš©ì ì…ë ¥]\n' + baseText + '\n\n' : '') +
    (combinedFileText ? '[ì²¨ë¶€íŒŒì¼ ë‚´ìš©]\n' + combinedFileText : '');

  if (!combined) {
    combined = 'â€» ê³µê³  í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. URL ëª©ë¡: ' + (fileUrlRaw || '(ì—†ìŒ)');
  }

  var prompt =
    'ë‹¤ìŒì€ ì…ì°° ê³µê³  ë˜ëŠ” ì²¨ë¶€íŒŒì¼ ë‚´ìš©ì´ë‹¤.\n' +
    'ë¨¼ì € í•œêµ­ìˆ˜ì•ˆì˜ ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë¡œí•„ì„ ìˆ™ì§€í•˜ë¼.\n' +
    BUSINESS_PROFILE + '\n\n' +
    'í•œêµ­ìˆ˜ì•ˆ(ë¹—ë¬¼ì €ë¥˜ì¡°Â·ìš°ìˆ˜Â·ì¹¨ìˆ˜ë°©ì§€ ì „ë¬¸ ì‹œê³µì‚¬) ì…ì¥ì—ì„œ ' +
    'ì…ì°° ì •ë³´ë¥¼ ì¶”ì¶œí•´ í•˜ë‚˜ì˜ JSON ê°ì²´ë¡œ ë§Œë“¤ì–´ë¼.\n\n' +
    'í•„ë“œ: {\n' +
    '  "no": "ê³µê³ ë²ˆí˜¸ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)",\n' +
    '  "region": "ì§€ì—­(ì‹œ/ë„ ìˆ˜ì¤€)",\n' +
    '  "title": "ê³µê³ ëª…",\n' +
    '  "date": "ê³µê³ ì¼ YYYY-MM-DD ë˜ëŠ” ë¹ˆ ë¬¸ìì—´",\n' +
    '  "deadline": "ë§ˆê°ì¼ YYYY-MM-DD HH:mm ë˜ëŠ” ë¹ˆ ë¬¸ìì—´",\n' +
    '  "client": "ë°œì£¼ì²˜",\n' +
    '  "agency": "ìˆ˜ìš”ê¸°ê´€",\n' +
    '  "servicePeriod": "ìš©ì—­/ê³µì‚¬ ê¸°ê°„ í…ìŠ¤íŠ¸",\n' +
    '  "serviceAmount": "ê³„ì•½(ì¶”ì •) ê¸ˆì•¡ í…ìŠ¤íŠ¸ (ì–µì›/ì²œë§Œì› ë“± ë‹¨ìœ„ í¬í•¨ ê°€ëŠ¥)",\n' +
    '  "projectBudget": "ì´ ì‚¬ì—…ë¹„ í…ìŠ¤íŠ¸ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)",\n' +
    '  "clientManager": "ë‹´ë‹¹ì ì´ë¦„ ë° ì—°ë½ì²˜",\n' +
    '  "siteArea": "ëŒ€ì§€ë©´ì  ë˜ëŠ” ê·œëª¨ ì •ë³´",\n' +
    '  "expectedTon": "ì˜ˆìƒ ë¹—ë¬¼ì €ë¥˜ ìš©ëŸ‰(í†¤ ìˆ˜ì¹˜ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´)",\n' +
    '  "link": "ê´€ë ¨ ë§í¬ê°€ ìˆìœ¼ë©´",\n' +
    '  "aiResult": "í•œêµ­ìˆ˜ì•ˆ ì…ì¥ì—ì„œ ë³¸ ê´€ë ¨ì„± ë° 2~3ì¤„ ìš”ì•½"\n' +
    '}\n\n' +
    'JSONë§Œ ì¶œë ¥í•˜ê³ , ì„¤ëª… ë¬¸ì¥ì€ ì ˆëŒ€ ë„£ì§€ ë§ˆë¼.\n\n' +
    'ë‚´ìš©:\n' + combined.substring(0, 20000);

  var ai = {};
  var aiError = null;
  try {
    ai = callGeminiJson(prompt);
  } catch (e) {
    aiError = e;
    Logger.log('smart_add Gemini error: ' + e);
    ai = {};
  }

  // ì‹œì„¤ìœ í˜• / ì˜ˆìƒí†¤ìˆ˜ ì¶”ì •
  var facilityType = guessFacilityType(ai.title || '', (ai.client || '') + ' ' + (ai.agency || ''));
  var estimatedTon = ai.expectedTon || '';
  if (!estimatedTon) {
    var hintTon = estimateExpectedTon(facilityType, combined);
    estimatedTon = hintTon ? String(hintTon) : '';
  }

  // í†¤ ê¸°ë°˜ ìš©ì—­ê¸ˆì•¡ ì¶”ì •
  var amountFromTon = estimateAmountFromTon_(estimatedTon);
  var serviceAmountText = '';
  if (ai.serviceAmount && hasDigit_(ai.serviceAmount)) {
    serviceAmountText = ai.serviceAmount;
  } else {
    serviceAmountText = amountFromTon || '';
  }

  var aiSummaryPrefix =
    '[' + (facilityType || 'ê¸°íƒ€') +
    (estimatedTon ? ' / ~' + estimatedTon + 'í†¤ ì˜ˆìƒ' : '') + '] ';

  var fileNoteStr = fileNotes.length ? fileNotes.join(' / ') : '';

  var aiResultText;
  if (ai.aiResult) {
    aiResultText = aiSummaryPrefix + ai.aiResult;
  } else if (aiError) {
    aiResultText = aiSummaryPrefix + '[AI ë¶„ì„ ì‹¤íŒ¨] ' + aiError.message;
  } else {
    aiResultText = aiSummaryPrefix + 'AI ë¶„ì„ ê²°ê³¼ ì—†ìŒ(ì‘ë‹µ ì—†ìŒ)';
  }

  if (fileNoteStr) {
    aiResultText += '\nâ€» ì²¨ë¶€íŒŒì¼: ' + fileNoteStr;
  }

  var sheet = ensureMainSheet_();
  var row = [
    ai.no || 'ì •ë³´ì—†ìŒ',
    ai.region || '',
    ai.title || 'ì œëª©ì—†ìŒ',
    ai.date || '',
    ai.deadline || '',
    ai.client || 'ì§ì ‘ë“±ë¡',
    ai.agency || 'ì§ì ‘ë“±ë¡',
    ai.servicePeriod || '',
    serviceAmountText,
    ai.projectBudget || '',
    ai.clientManager || '',
    ai.siteArea || '',
    estimatedTon ? (estimatedTon + 'í†¤(ì˜ˆìƒ)') : '',
    primaryUrl || ai.link || '#',
    'ìˆ˜ë™ë“±ë¡',
    aiResultText,
    '',
    '',
    '',
    ''
  ];
  sheet.appendRow(row);

  return jsonResponse({
    result: 'success',
    storedNo: row[0],
    storedTitle: row[2],
    facilityType: facilityType,
    estimatedTon: estimatedTon || '',
    fileNote: fileNoteStr,
    aiError: aiError ? aiError.message : ''
  });
}


// =======================================================
// 11ï¸âƒ£ 2ì°¨ ì‹¬í™” ë¶„ì„ (ë‚˜ë¼ì¥í„° ìƒì„¸ + ì²¨ë¶€íŒŒì¼ URL)
// =======================================================

function deepAnalyzeBid(p) {
  p = p || {};
  var no = p.no || '';
  var link = p.link || '';
  var titleParam = p.title || '';
  var clientParam = p.client || '';
  var agencyParam = p.agency || '';
  var regionParam = p.region || '';

  var sheet = ensureMainSheet_();
  ensureMainSchema_(sheet);

  // 1) í–‰ ì°¾ê¸°
  var rows = sheet.getDataRange().getValues();
  var row = null;
  var rowIndex = -1;
  for (var i = 1; i < rows.length; i++) {
    if (String(rows[i][0]) === String(no)) {
      row = rows[i];
      rowIndex = i + 1; // 1-based
      break;
    }
  }

  // 2) ê¸°ë³¸ê°’(í–‰ì´ ì—†ìœ¼ë©´ íŒŒë¼ë¯¸í„° ê¸°ë°˜ìœ¼ë¡œ)
  var title  = (row && row[2]) ? row[2] : titleParam;
  var client = (row && row[5]) ? row[5] : clientParam;
  var agency = (row && row[6]) ? row[6] : agencyParam;
  var region = (row && row[1]) ? row[1] : regionParam;
  var firstSummary = (row && row[15]) ? row[15] : '';

  // 3) ìƒì„¸ í…ìŠ¤íŠ¸(ê°€ëŠ¥í•˜ë©´ ë§í¬ì—ì„œ ì¶”ì¶œ)
  var detailText = '';
  try {
    if (link && link !== '#') {
      detailText = safeFetchTextFromUrl_(link, 4500);
    }
  } catch (e) {
    Logger.log('detail fetch failed: ' + e);
  }

  // 4) ë©´ì  íŒŒì‹±/ëŒ€ìƒ íŒì •/ì‚°ì •(ê·œì¹™ ê¸°ë°˜)
  var areaStr = (row && row[11]) ? String(row[11]) : '';
  var areaM2 = parseAreaM2_(areaStr) || parseAreaM2_(detailText) || 0;
  var targetClass = classifyTarget_(areaM2); // direct/review/large/unknown
  var isApplicable = (targetClass === 'direct' || targetClass === 'review');

  var ordinanceBasis = '';
  try {
    ordinanceBasis = findOrdinanceBasis_(region, areaM2);
  } catch (e) {
    ordinanceBasis = '';
  }
  var calc = computeCapacityCalc_(areaM2, detailText);

  // 5) ì§€ì‹í´ë” ì»¨í…ìŠ¤íŠ¸(ê°€ëŠ¥í•œ ê²½ìš°)
  var knowledge = '';
  try {
    knowledge = buildKnowledgeContext_({
      region: region,
      need: ['í•œêµ­ìˆ˜ì•ˆì¹´ë‹¤ë¡œê·¸', '1216', 'ìš©ëŸ‰ì‚°ì •', 'ìš°ìˆ˜ìœ ì¶œ']
    }, 4500);
  } catch (e) {
    knowledge = '';
  }

  // 6) Gemini í”„ë¡¬í”„íŠ¸ êµ¬ì„±(ì¡°ë¡€ + ì‚°ì • ìš”ì•½ í¬í•¨)
  var prompt =
    BUSINESS_PROFILE + '\n\n' +
    'ì—­í• : í•œêµ­ìˆ˜ì•ˆ(ë¹—ë¬¼ì €ë¥˜ì¡°Â·ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±…) ì˜ì—…/ì…ì°° ì „ëµ ë‹´ë‹¹.\n' +
    'ë‹¤ìŒ ê³µê³ ë¥¼ "ì†Œê·œëª¨ ë¶„ì‚°í˜•(ì§ì ‘<=5,000ã¡ / í™•ì¥ê²€í† <=7,000ã¡)" ê´€ì ì—ì„œ ì‹¬í™” ë¶„ì„í•˜ë¼.\n\n' +
    'ê³µê³ ë²ˆí˜¸: ' + no + '\n' +
    'ê³µê³ ëª…: ' + title + '\n' +
    'ë°œì£¼ì²˜: ' + client + '\n' +
    'ìˆ˜ìš”ê¸°ê´€: ' + agency + '\n' +
    'ì§€ì—­(ì¶”ì •): ' + (region || '') + '\n' +
    'ëŒ€ì§€ë©´ì (ã¡): ' + (areaM2 ? String(areaM2) : '(ë¯¸í™•ì¸)') + '\n' +
    'ëŒ€ìƒíŒì •: ' + targetClass + ' (direct/review/large/unknown)\n' +
    '1ì°¨ ìš”ì•½: ' + (firstSummary || '(ì—†ìŒ)') + '\n\n' +
    'ì¡°ë¡€/ê·¼ê±°(ê°€ëŠ¥í•˜ë©´ í•´ë‹¹ ì§€ìì²´ì˜ ë¹—ë¬¼ì¬ì´ìš©/ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±… ì˜ë¬´ ê¸°ì¤€, ì¡°í•­/ë©´ì ê¸°ì¤€ì„ ê·¼ê±°ë¡œ ìš”ì•½):\n' +
    (ordinanceBasis || '(ë¯¸í™•ì¸)') + '\n\n' +
    'ìš©ëŸ‰ ì‚°ì •(ê°„ì´) ìš”ì•½(JSON):\n' + JSON.stringify(calc) + '\n\n' +
    'ìƒì„¸í˜ì´ì§€ í…ìŠ¤íŠ¸ ì¼ë¶€(ì—†ìœ¼ë©´ ë¹„ì›Œì ¸ ìˆì„ ìˆ˜ ìˆìŒ):\n' +
    (detailText || '(ì œê³µëœ ìƒì„¸ í…ìŠ¤íŠ¸ ì—†ìŒ)') + '\n\n' +
    (knowledge ? ('[ì§€ì‹í´ë” ì°¸ê³ ìë£Œ ë°œì·Œ]\n' + knowledge + '\n\n') : '') +
    'ì•„ë˜ JSON í•œ ì¤„ë¡œë§Œ ì‘ë‹µí•˜ë¼.\n' +
    '{\n' +
    '  "relevance": "ìƒ/ì¤‘/í•˜",\n' +
    '  "summary2": "í•œêµ­ìˆ˜ì•ˆ ê´€ì ì—ì„œ 2~3ë¬¸ì¥ ì‹¬í™” ìš”ì•½",\n' +
    '  "servicePeriod": "ìš©ì—­/ê³µì‚¬ ê¸°ê°„(í…ìŠ¤íŠ¸)",\n' +
    '  "serviceAmount": "ê³„ì•½(ì¶”ì •) ê¸ˆì•¡(í…ìŠ¤íŠ¸)",\n' +
    '  "projectBudget": "ì´ ì‚¬ì—…ë¹„(í…ìŠ¤íŠ¸, ìˆìœ¼ë©´)",\n' +
    '  "ordinanceBasis": "ì¡°ë¡€ ê·¼ê±° ìš”ì•½(ì¡°í•­/ê¸°ì¤€ë©´ì  í¬í•¨, ê·¼ê±° ì—†ìœ¼ë©´ ë¯¸í™•ì¸)",\n' +
    '  "areaM2": ' + (areaM2 ? areaM2 : 0) + ',\n' +
    '  "targetClass": "' + targetClass + '",\n' +
    '  "capacityTon": ' + (calc.capacityTon || 0) + ',\n' +
    '  "capacitySummary": "ì‚°ì • ê·¼ê±° 2~4ì¤„ ìš”ì•½(ë©´ì /ê°•ìš°/ìœ ì¶œê³„ìˆ˜ ë“±)",\n' +
    '  "checkPoints": ["ì…ì°°/ì˜ì—… ì¤€ë¹„ ì‹œ í™•ì¸í•  ì‚¬í•­ 3~6ê°œ"],\n' +
    '  "riskLevel": "ë†’ìŒ/ë³´í†µ/ë‚®ìŒ",\n' +
    '  "suggestion": "ì˜ì—…/ì œì•ˆ ì „ëµ í•œ ë¬¸ì¥",\n' +
    '  "salesMent": "ì„¤ê³„ì‚¬/ì‹œê³µì‚¬ì—ê²Œ ì „í™”/ë©”ì¼ë¡œ ë³´ë‚¼ 2~3ë¬¸ì¥ ë©˜íŠ¸"\n' +
    '}\n' +
    'JSON ì´ì™¸ì˜ ì„¤ëª…ì€ ì ˆëŒ€ ì“°ì§€ ë§ˆë¼.';

  var deep = {};
  try {
    deep = callGeminiJson(prompt) || {};
  } catch (e) {
    Logger.log('deepAnalyze Gemini failed: ' + e);
    deep = {
      relevance: 'ì¤‘',
      summary2: 'AI ì‹¬í™” ë¶„ì„ ì‹¤íŒ¨(ëª¨ë¸ í˜¸ì¶œ ì˜¤ë¥˜).',
      ordinanceBasis: ordinanceBasis || '',
      areaM2: areaM2 || 0,
      targetClass: targetClass,
      capacityTon: calc.capacityTon || 0,
      capacitySummary: calc.capacitySummary || ''
    };
  }

  // 7) ê·œì¹™ ê¸°ë°˜ ê²°ê³¼ ìš°ì„  ë³´ê°•(ëª¨ë¸ ëˆ„ë½ ë°©ì§€)
  deep.areaM2 = deep.areaM2 || areaM2 || 0;
  deep.targetClass = deep.targetClass || targetClass;
  deep.ordinanceBasis = deep.ordinanceBasis || ordinanceBasis || '';
  deep.capacityTon = deep.capacityTon || calc.capacityTon || 0;
  deep.capacitySummary = deep.capacitySummary || calc.capacitySummary || '';
  deep.calcTable = calc.calcTable || [];

  // 8) ì‹œíŠ¸ ì—…ë°ì´íŠ¸(ìš©ì—­ê¸°ê°„/ê¸ˆì•¡/ì‚¬ì—…ë¹„ëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€)
  if (rowIndex !== -1) {
    var updated = false;
    var sp = (row && row[7]) ? row[7] : '';
    var sa = (row && row[8]) ? row[8] : '';
    var pb = (row && row[9]) ? row[9] : '';

    if (deep.servicePeriod && !sp) { sp = deep.servicePeriod; updated = true; }
    if (deep.serviceAmount && !sa) { sa = deep.serviceAmount; updated = true; }
    if (deep.projectBudget && !pb) { pb = deep.projectBudget; updated = true; }

    if (updated) {
      sheet.getRange(rowIndex, 8, 1, 3).setValues([[sp, sa, pb]]);
    }

    // ì‹ ê·œ ì»¬ëŸ¼ ì €ì¥
    var cOrdin = colIndex_(sheet, 'ì¡°ë¡€ê·¼ê±°');
    var cAppl  = colIndex_(sheet, 'ì ìš©ëŒ€ìƒ');
    if (cOrdin > 0) sheet.getRange(rowIndex, cOrdin).setValue(deep.ordinanceBasis || '');
    if (cAppl  > 0) sheet.getRange(rowIndex, cAppl).setValue(isApplicable ? (targetClass === 'direct' ? 'ì§ì ‘ëŒ€ìƒ' : 'í™•ì¥ê²€í† ') : 'ë¹„ëŒ€ìƒ');
  }

  // 9) ìºì‹œ(ë¬¸ì„œ ìƒì„± ì‹œ ì¬í™œìš©)
  try {
    PropertiesService.getDocumentProperties().setProperty('DEEP_' + String(no), JSON.stringify(deep));
  } catch (e) {}

  // 10) ì²¨ë¶€íŒŒì¼(ìƒì„¸í˜ì´ì§€ HTMLì—ì„œ ë§í¬ ì¶”ì¶œ ì‹œë„)
  var attachments = [];
  try {
    if (link && link !== '#') {
      var res2 = UrlFetchApp.fetch(link, FETCH_OPT);
      if (res2.getResponseCode() === 200) {
        var html2 = res2.getContentText('UTF-8');
        attachments = extractAttachmentsWithUrls_(html2, link) || [];
      }
    }
  } catch (e) {}  return jsonResponse({
    ok: true,
    action: 'deepAnalyze',
    no: no,
    title: title,
    client: client,
    agency: agency,
    region: region,
    link: link,
    aiResult: deep.summary2 || '',
    aiReport: deep,
    deep: deep, // legacy
    attachments: attachments,
    servicePeriod: deep.servicePeriod || (row ? row[7] : ''),
    serviceAmount: deep.serviceAmount || (row ? row[8] : ''),
    projectBudget: deep.projectBudget || (row ? row[9] : '')
  });
}


function extractAttachmentsWithUrls_(html, pageUrl) {
  var list = [];
  if (!html) return list;

  var regex = /<a[^>]+href=["']([^"']+)["'][^>]*>([\s\S]*?)<\/a>/gi;
  var m;
  while ((m = regex.exec(html)) !== null) {
    var href = m[1];
    if (!href) continue;

    var inner = m[2] || '';
    var lowerHref = href.toLowerCase();
    if (!/\.(pdf|hwp|hwpx|docx?|xlsx?|pptx?)(\?|$)/.test(lowerHref)) continue;

    var name = inner.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
    if (!name) {
      var cleaned = href.split(/[?#]/)[0];
      var idx = cleaned.lastIndexOf('/');
      if (idx >= 0) name = cleaned.substring(idx + 1);
      else name = cleaned;
    }

    var absUrl = resolveUrl_(pageUrl, href);
    var exists = list.some(function (x) { return x.url === absUrl; });
    if (!exists) list.push({ name: name, url: absUrl });
  }
  return list;
}


// =======================================================
// 12ï¸âƒ£ íœ´ë¦¬ìŠ¤í‹±: ì‹œì„¤ ìœ í˜• / í†¤ìˆ˜ / ê¸ˆì•¡ ì¶”ì •
// =======================================================
function guessFacilityType(title, agency) {
  var text = (title + ' ' + agency).replace(/\s/g, '');

  if (/ì´ˆë“±í•™êµ|ì¤‘í•™êµ|ê³ ë“±í•™êµ|í•™êµ|êµìœ¡ì²­/.test(text)) return 'í•™êµ';
  if (/ì•„íŒŒíŠ¸|ì£¼ê³µ|ì£¼íƒë‹¨ì§€|APT/i.test(text)) return 'ì•„íŒŒíŠ¸ë‹¨ì§€';
  if (/ê³µì¥|ì‚°ì—…ë‹¨ì§€|ì‚°ë‹¨|í´ëŸ¬ìŠ¤í„°/i.test(text)) return 'ê³µì¥/ì‚°ë‹¨';
  if (/ë³‘ì›|ì˜ë£Œì›|ë³´ê±´ì†Œ|ì˜ë£Œì„¼í„°/i.test(text)) return 'ì˜ë£Œì‹œì„¤';

  return 'ê¸°íƒ€ê³µê³µì‹œì„¤';
}


// =======================================================
// âœ… ì‹¬í™”ë¶„ì„ ë³´ê°• ìœ í‹¸(ì¡°ë¡€/ë©´ì /ì‚°ì •/ì§€ì‹í´ë”)
// =======================================================
function parseAreaM2_(text) {
  if (!text) return 0;
  var s = String(text);
  // ìˆ«ì + ã¡/m2/mÂ²
  var m = s.match(/(\d{1,3}(?:,\d{3})+|\d+(?:\.\d+)?)\s*(?:ã¡|m2|mÂ²)/i);
  if (m && m[1]) {
    var n = Number(String(m[1]).replace(/,/g, ''));
    if (!isNaN(n) && n > 0) return Math.round(n);
  }
  // "ëŒ€ì§€ë©´ì  5000" ê°™ì€ íŒ¨í„´
  m = s.match(/ëŒ€ì§€ë©´ì \s*[:ï¼š]?\s*(\d{1,3}(?:,\d{3})+|\d+(?:\.\d+)?)/);
  if (m && m[1]) {
    var n2 = Number(String(m[1]).replace(/,/g, ''));
    if (!isNaN(n2) && n2 > 0) return Math.round(n2);
  }
  return 0;
}

function classifyTarget_(areaM2) {
  if (!areaM2 || isNaN(areaM2)) return 'unknown';
  if (areaM2 <= 5000) return 'direct';
  if (areaM2 <= 7000) return 'review';
  return 'large';
}

function computeCapacityCalc_(areaM2, text) {
  var a = Number(areaM2 || 0);
  if (!a || isNaN(a) || a <= 0) {
    return { capacityTon: 0, capacitySummary: 'ëŒ€ì§€ë©´ì  ì •ë³´ê°€ ì—†ì–´ ì‚°ì • ë¶ˆê°€', calcTable: [] };
  }

  // ê°„ì´ ì‚°ì • ê°€ì •ê°’(í•„ìš”ì‹œ ì§€ì‹í´ë” ìƒ˜í”Œë¡œ ì¡°ì •)
  var designRainMm = 50;     // ì„¤ê³„ê°•ìš°(mm) (ê°„ì´)
  var runoffCoeff  = 0.9;    // ìœ ì¶œê³„ìˆ˜(ê°„ì´)
  var safetyFactor = 1.1;    // ì—¬ìœ ìœ¨

  // í‚¤ì›Œë“œë¡œ ì•½ê°„ ì¡°ì •
  var t = String(text || '');
  if (/ì§€ë¶•|ì˜¥ìƒ/.test(t)) runoffCoeff = Math.max(runoffCoeff, 0.95);
  if (/ë…¹ì§€|ê³µì›|ì¡°ê²½/.test(t)) runoffCoeff = Math.min(runoffCoeff, 0.85);

  var volumeM3 = a * (designRainMm / 1000) * runoffCoeff * safetyFactor; // m3
  var ton = Math.round(volumeM3); // 1m3 â‰’ 1í†¤

  var summary =
    'ê°€ì •: ì„¤ê³„ê°•ìš° ' + designRainMm + 'mm, ìœ ì¶œê³„ìˆ˜ ' + runoffCoeff + ', ì—¬ìœ ìœ¨ ' + safetyFactor +
    ' â†’ V=' + a + 'Ã—' + (designRainMm/1000) + 'Ã—' + runoffCoeff + 'Ã—' + safetyFactor + ' â‰’ ' + ton + 'í†¤';

  var table = [
    ['ëŒ€ì§€ë©´ì (ã¡)', a],
    ['ì„¤ê³„ê°•ìš°(mm)', designRainMm],
    ['ìœ ì¶œê³„ìˆ˜', runoffCoeff],
    ['ì—¬ìœ ìœ¨', safetyFactor],
    ['ê¶Œì¥ì €ë¥˜ëŸ‰(í†¤â‰ˆmÂ³)', ton]
  ];

  return {
    areaM2: a,
    designRainMm: designRainMm,
    runoffCoeff: runoffCoeff,
    safetyFactor: safetyFactor,
    volumeM3: volumeM3,
    capacityTon: ton,
    capacitySummary: summary,
    calcTable: table
  };
}

// ì¡°ë¡€ DB ì‹œíŠ¸(ìˆìœ¼ë©´)ì—ì„œ ì§€ì—­ ê¸°ì¤€ìœ¼ë¡œ ê°„ë‹¨ ë§¤ì¹­
function findOrdinanceBasis_(region, areaM2) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet =
    ss.getSheetByName('ì¡°ë¡€DB') ||
    ss.getSheetByName('ì¡°ë¡€') ||
    ss.getSheetByName('ordinance') ||
    ss.getSheetByName('OrdinanceDB');

  if (!sheet) return '';
  var values = sheet.getDataRange().getValues();
  if (values.length <= 1) return '';

  var rgn = String(region || '').trim();
  if (!rgn) return '';

  // 1ì—´ì— ì§€ìì²´ëª…ì´ ìˆë‹¤ê³  ê°€ì •í•˜ê³ , ë‚˜ë¨¸ì§€ ì»¬ëŸ¼ì„ ìš”ì•½ ë¬¸ìì—´ë¡œ ê²°í•©
  for (var i = 1; i < values.length; i++) {
    var row = values[i];
    var city = String(row[0] || '').trim();
    if (!city) continue;
    if (rgn.indexOf(city) !== -1 || city.indexOf(rgn) !== -1) {
      // ë©´ì  ê¸°ì¤€ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ê°„ë‹¨ ë¹„êµë„ ê°€ëŠ¥(ì˜µì…˜)
      var joined = row.map(function(v){ return String(v || '').trim(); }).filter(function(v){ return v; }).join(' | ');
      return joined;
    }
  }
  return '';
}

// ì§€ì‹í´ë”(Drive)ì—ì„œ ì°¸ê³  í…ìŠ¤íŠ¸ë¥¼ ìµœëŒ€ maxChars ë§Œí¼ ë°œì·Œ
function buildKnowledgeContext_(opt, maxChars) {
  opt = opt || {};
  maxChars = maxChars || 3000;

  var folder = getKnowledgeFolder_();
  if (!folder) return '';

  var need = opt.need || [];
  var out = '';
  var files = listFilesRecursive_(folder, 50); // ìµœëŒ€ 50ê°œë§Œ
  for (var i = 0; i < files.length; i++) {
    var f = files[i];
    var name = String(f.getName() || '');
    var ok = false;
    for (var k = 0; k < need.length; k++) {
      if (name.indexOf(need[k]) !== -1) { ok = true; break; }
    }
    if (!ok) continue;

    var piece = '';
    try {
      piece = extractTextFromFile_(f, 1200);
    } catch (e) {
      piece = '';
    }
    if (piece) {
      out += '### ' + name + '\n' + piece + '\n\n';
      if (out.length >= maxChars) break;
    }
  }

  if (out.length > maxChars) out = out.substring(0, maxChars);
  return out;
}

function getKnowledgeFolder_() {
  var it = DriveApp.getFoldersByName('ì§€ì‹í´ë”');
  if (it.hasNext()) return it.next();
  return null;
}

// í´ë” ì¬ê·€ íŒŒì¼ ëª©ë¡(ìµœëŒ€ limit)
function listFilesRecursive_(folder, limit) {
  limit = limit || 50;
  var out = [];
  function walk_(fld) {
    if (out.length >= limit) return;
    var files = fld.getFiles();
    while (files.hasNext() && out.length < limit) out.push(files.next());
    var subs = fld.getFolders();
    while (subs.hasNext() && out.length < limit) walk_(subs.next());
  }
  walk_(folder);
  return out;
}

// íŒŒì¼ íƒ€ì…ì— ë”°ë¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ(ë¬¸ì„œ/ìŠ¤í”„ë ˆë“œì‹œíŠ¸ëŠ” ì§ì ‘, PDF/PPT ë“±ì€ Drive ê³ ê¸‰ì„œë¹„ìŠ¤ ì‚¬ìš© ì‹œ ë³€í™˜)
function extractTextFromFile_(file, maxChars) {
  maxChars = maxChars || 1200;
  var mime = file.getMimeType();
  var text = '';

  try {
    if (mime === MimeType.GOOGLE_DOCS) {
      text = DocumentApp.openById(file.getId()).getBody().getText();
    } else if (mime === MimeType.GOOGLE_SHEETS) {
      var ss = SpreadsheetApp.openById(file.getId());
      var sh = ss.getSheets()[0];
      var vals = sh.getDataRange().getDisplayValues();
      text = vals.map(function(r){ return r.join('\t'); }).join('\n');
    } else if (mime === MimeType.PDF || mime === MimeType.MICROSOFT_POWERPOINT || mime === MimeType.MICROSOFT_WORD) {
      // Drive ê³ ê¸‰ì„œë¹„ìŠ¤(Drive) ì‚¬ìš© ê°€ëŠ¥ ì‹œ: ë¬¸ì„œë¡œ ë³€í™˜ í›„ í…ìŠ¤íŠ¸ ì¶”ì¶œ
      text = convertBinaryToTextViaDrive_(file);
    } else {
      // ê¸°íƒ€ëŠ” ì´ë¦„ë§Œ
      text = '';
    }
  } catch (e) {
    text = '';
  }

  if (text && text.length > maxChars) text = text.substring(0, maxChars);
  return (text || '').trim();
}

function convertBinaryToTextViaDrive_(file) {
  // âš ï¸ Advanced Drive Service(Drive) í™œì„±í™” í•„ìš”.
  try {
    if (typeof Drive === 'undefined' || !Drive.Files) return '';
  } catch (e) {
    return '';
  }

  var tmpId = '';
  try {
    var resource = { title: 'tmp_' + file.getName(), mimeType: MimeType.GOOGLE_DOCS };
    var copied = Drive.Files.copy(resource, file.getId());
    tmpId = copied.id;
    var txt = DocumentApp.openById(tmpId).getBody().getText();
    return txt || '';
  } catch (e2) {
    return '';
  } finally {
    try {
      if (tmpId) DriveApp.getFileById(tmpId).setTrashed(true);
    } catch (e3) {}
  }
}

// URL í˜ì´ì§€ì—ì„œ ê°„ë‹¨ í…ìŠ¤íŠ¸ ì¶”ì¶œ(HTML íƒœê·¸ ì œê±°)
function safeFetchTextFromUrl_(url, maxChars) {
  if (!url) return '';
  maxChars = maxChars || 4000;
  var res = UrlFetchApp.fetch(url, FETCH_OPT);
  var ct = res.getContentText('UTF-8');
  var txt = ct.replace(/<script[\s\S]*?<\/script>/gi, ' ')
              .replace(/<style[\s\S]*?<\/style>/gi, ' ')
              .replace(/<[^>]+>/g, ' ')
              .replace(/&nbsp;/g, ' ')
              .replace(/\s+/g, ' ')
              .trim();
  if (txt.length > maxChars) txt = txt.substring(0, maxChars);
  return txt;
}

// =======================================================
// âœ… ìš°ìˆ˜ìœ ì¶œ ì €ê°ëŒ€ì±… ë¬¸ì„œ ìƒì„± (AI) â†’ Drive ì €ì¥ URL ë°˜í™˜
// =======================================================
function generateMitigationDoc_(p) {
  p = p || {};
  var no = String(p.no || '').trim();
  var rowIndex = Number(p.rowIndex || 0);

  var sheet = ensureMainSheet_();
  ensureMainSchema_(sheet);

  // í–‰ ì¡°íšŒ(ìš°ì„  rowIndex)
  var row = null;
  if (rowIndex && rowIndex > 1) {
    row = sheet.getRange(rowIndex, 1, 1, sheet.getLastColumn()).getValues()[0];
    if (String(row[0]) !== no && no) {
      row = null;
    }
  }
  if (!row && no) {
    var values = sheet.getDataRange().getValues();
    for (var i = 1; i < values.length; i++) {
      if (String(values[i][0]) === no) { row = values[i]; rowIndex = i + 1; break; }
    }
  }
  if (!row) {
    return jsonResponse({ ok: false, error: 'í•´ë‹¹ ê³µê³ ë¥¼ ì‹œíŠ¸ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' });
  }

  // ê¸°ì¡´ ë³´ê³ ì„œ URLì´ ìˆìœ¼ë©´ ë°”ë¡œ ë°˜í™˜
  var cUrl = colIndex_(sheet, 'AIë³´ê³ ì„œURL');
  var existing = (cUrl > 0) ? String(sheet.getRange(rowIndex, cUrl).getValue() || '').trim() : '';
  if (existing) {
    return jsonResponse({ ok: true, docUrl: existing, aiReportUrl: existing });
  }

  // ìºì‹œëœ 2ì°¨ ë¶„ì„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì¦‰ì‹œ ì‹¬í™”ë¶„ì„ í˜¸ì¶œ
  var deep = {};
  try {
    var cached = PropertiesService.getDocumentProperties().getProperty('DEEP_' + no);
    if (cached) deep = JSON.parse(cached);
  } catch (e) { deep = {}; }

  if (!deep || !deep.summary2) {
    deep = deepAnalyzeBid({ no: no, link: row[13], title: row[2], client: row[5], agency: row[6], region: row[1] });
    // deepAnalyzeBidëŠ” ContentService ì‘ë‹µì´ë¼ ì—¬ê¸°ì„œëŠ” ë‹¤ì‹œ íŒŒì‹±ì´ ì–´ë ¤ì›€ â†’ ìºì‹œ ì‚¬ìš©
    try {
      var cached2 = PropertiesService.getDocumentProperties().getProperty('DEEP_' + no);
      if (cached2) deep = JSON.parse(cached2);
    } catch (e2) {}
  }

  // ì§€ì‹í´ë” ìƒ˜í”Œ ì»¨í…ìŠ¤íŠ¸(ëŒ€ì±…ë¬¸ì„œ ì„œì‹)
  var knowledge = '';
  try {
    knowledge = buildKnowledgeContext_({ need: ['ìš°ìˆ˜ìœ ì¶œ', 'ì €ê°ëŒ€ì±…', 'ëŒ€ì±…', 'ìƒ˜í”Œ'] }, 5000);
  } catch (e3) {
    knowledge = '';
  }

  var title = row[2] || '';
  var region = row[1] || '';
  var link = row[13] || '';

  // ë¬¸ì„œ ìƒì„± í”„ë¡¬í”„íŠ¸
  var prompt =
    BUSINESS_PROFILE + '\n\n' +
    'ì—­í• : í•œêµ­ìˆ˜ì•ˆ ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±…(ì†Œê·œëª¨ ë¶„ì‚°í˜•) ì œì•ˆì„œ ì‘ì„± ë‹´ë‹¹.\n' +
    'ì•„ë˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, "ìš°ìˆ˜ìœ ì¶œ ì €ê°ëŒ€ì±…" ë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„±í•˜ë¼.\n' +
    '- ë¬¸ì„œ í˜•ì‹: ì œëª©, 1) ì‚¬ì—…ê°œìš” 2) ê´€ë ¨ ë²•ë ¹/ì¡°ë¡€ ê²€í†  3) ëŒ€ìƒì§€ í˜„í™©(ë©´ì /ë¶ˆíˆ¬ìˆ˜ ì¶”ì •) 4) ì €ë¥˜ì¡° ìš©ëŸ‰ ì‚°ì •(í‘œ í¬í•¨) 5) ì ìš© ê³µë²•/ì œí’ˆ(PN ì €ë¥˜ì¡° ë“±) 6) ê¸°ëŒ€íš¨ê³¼ 7) ë‹¤ìŒ ì¡°ì¹˜/ìš”ì²­ìë£Œ.\n' +
    '- ê³¼ì¥/ì¶”ë¡  ê¸ˆì§€: ìˆ«ì/ë©´ì /ì¡°ë¡€ ê·¼ê±°ëŠ” ì œê³µëœ ì •ë³´ ë²”ìœ„ ë‚´ì—ì„œë§Œ. ë¯¸í™•ì¸ í•­ëª©ì€ "ë¯¸í™•ì¸"ìœ¼ë¡œ í‘œê¸°.\n\n' +
    'ê³µê³ ë²ˆí˜¸: ' + no + '\n' +
    'ê³µê³ ëª…: ' + title + '\n' +
    'ì§€ì—­: ' + region + '\n' +
    'ì›ë¬¸ë§í¬: ' + link + '\n\n' +
    '2ì°¨ ë¶„ì„(JSON):\n' + JSON.stringify(deep) + '\n\n' +
    (knowledge ? ('[ëŒ€ì±…ë¬¸ì„œ ìƒ˜í”Œ ë°œì·Œ]\n' + knowledge + '\n\n') : '') +
    'ì¶œë ¥ì€ "ë¬¸ì„œ ë³¸ë¬¸ í…ìŠ¤íŠ¸"ë§Œ ì‘ì„±í•˜ë¼.';

  var bodyText = '';
  try {
    bodyText = callGeminiText(prompt);
  } catch (e4) {
    return jsonResponse({ ok: false, error: 'Gemini í˜¸ì¶œ ì‹¤íŒ¨: ' + e4 });
  }

  // Drive ì €ì¥
  var folder = ensureMitigationFolder_();
  var docName = 'ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±…_' + no + '_' + Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyyMMdd_HHmm');
  var doc = DocumentApp.create(docName);
  doc.getBody().setText(bodyText || '');
  doc.saveAndClose();

  var file = DriveApp.getFileById(doc.getId());
  try { folder.addFile(file); DriveApp.getRootFolder().removeFile(file); } catch (e5) {}

  var url = doc.getUrl();

  // ì‹œíŠ¸ì— URL ì €ì¥
  if (cUrl > 0) sheet.getRange(rowIndex, cUrl).setValue(url);

  return jsonResponse({ ok: true, docUrl: url, aiReportUrl: url });
}

function ensureMitigationFolder_() {
  var root = getKnowledgeFolder_() || DriveApp.getRootFolder();
  var it = root.getFoldersByName('AI_ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±…');
  if (it.hasNext()) return it.next();
  return root.createFolder('AI_ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±…');
}
function estimateExpectedTon(facilityType, text) {
  var base = 0;
  switch (facilityType) {
    case 'í•™êµ': base = 300; break;
    case 'ì•„íŒŒíŠ¸ë‹¨ì§€': base = 500; break;
    case 'ê³µì¥/ì‚°ë‹¨': base = 800; break;
    case 'ì˜ë£Œì‹œì„¤': base = 400; break;
    default: base = 0;
  }
  if (!base) return 0;

  var factor = 1.0;
  if (/ì‹ ì¶•|ê°œì¶•|ì¦ì¶•|ì¬ê°œë°œ|ë³µí•©ê°œë°œ/.test(text)) factor *= 1.2;
  if (/ë¦¬ëª¨ë¸ë§|ë¦¬ë…¸ë² ì´ì…˜|ê°œì„ |ë³´ìˆ˜/.test(text)) factor *= 0.8;

  return Math.round(base * factor);
}

function estimateAmountFromTon_(ton) {
  if (ton === null || ton === undefined) return '';
  var n;
  if (typeof ton === 'number') {
    n = ton;
  } else {
    n = parseInt(String(ton).replace(/[^0-9]/g, ''), 10);
  }
  if (!n || isNaN(n)) return '';

  var est = n * 400000; // 1í†¤ë‹¹ 40ë§Œì›
  return 'ì•½ ' + addComma_(est) + 'ì› (í†¤ë‹¹ 40ë§Œì› ê¸°ì¤€ ì¶”ì •)';
}


// =======================================================
// 13ï¸âƒ£ í–‰ ì‚­ì œ (ì´ì œëŠ” ê³µê³  ìœ í˜•ê³¼ ìƒê´€ì—†ì´ ì‚­ì œ ê°€ëŠ¥)
//      - í—¤ë”(1í–‰)ë§Œ ë³´í˜¸
// =======================================================
function deleteRowByIndex_(p) {
  var rowIndexStr = p.rowIndex || p.row || '';
  var rowIndex = parseInt(rowIndexStr, 10);

  if (!rowIndex || rowIndex <= 1) {
    return jsonResponse({
      result: 'error',
      message: 'ìœ íš¨í•˜ì§€ ì•Šì€ í–‰ ë²ˆí˜¸ì…ë‹ˆë‹¤.'
    });
  }

  var sheet = ensureMainSheet_();
  var last = sheet.getLastRow();
  if (rowIndex > last) {
    return jsonResponse({
      result: 'error',
      message: 'í–‰ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.'
    });
  }

  // ê³¼ê±°ì—ëŠ” "ìˆ˜ë™ë“±ë¡/ì§ì ‘ë“±ë¡ë§Œ ì‚­ì œ" ì œì•½ì´ ìˆì—ˆì§€ë§Œ,
  // ì´ì œëŠ” ì „ì²´ DB ëˆ„ì ì„ ì „ì œë¡œ, í•„ìš” ì—†ëŠ” ê³µê³ ëŠ” ì–´ë–¤ ê²ƒì´ë“  ì‚­ì œ ê°€ëŠ¥í•˜ë„ë¡ ë³€ê²½
  sheet.deleteRow(rowIndex);

  return jsonResponse({ result: 'success' });
}


// =======================================================
// 14ï¸âƒ£ êµ¬ê¸€ ìº˜ë¦°ë” ì—°ë™ (í–‰ ë‹¨ìœ„ ì´ë²¤íŠ¸ ìƒì„±/ìˆ˜ì •)
// =======================================================
function addCalendarEventByRow_(p) {
  var rowIndexStr = p.rowIndex || p.row || '';
  var rowIndex = parseInt(rowIndexStr, 10);

  if (!rowIndex || rowIndex <= 1) {
    return jsonResponse({ result: 'error', message: 'ìœ íš¨í•˜ì§€ ì•Šì€ í–‰ ë²ˆí˜¸ì…ë‹ˆë‹¤.' });
  }

  var sheet = ensureMainSheet_();
  var lastRow = sheet.getLastRow();
  if (rowIndex > lastRow) {
    return jsonResponse({ result: 'error', message: 'í–‰ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.' });
  }

  var row = sheet.getRange(rowIndex, 1, 1, sheet.getLastColumn()).getValues()[0];

  var no = row[0];
  var title = row[2] || 'ì…ì°° ë§ˆê°';
  var deadlineVal = row[4];
  var client = row[5] || '';
  var agency = row[6] || '';
  var link = row[13] || '';
  var calendarIdExisting = row[19] || '';

  var deadlineDate = null;
  if (deadlineVal instanceof Date) {
    deadlineDate = deadlineVal;
  } else if (deadlineVal) {
    deadlineDate = parseG2BDate(deadlineVal);
  }

  if (
    !deadlineDate ||
    Object.prototype.toString.call(deadlineDate) !== '[object Date]' ||
    isNaN(deadlineDate.getTime())
  ) {
    return jsonResponse({
      result: 'error',
      message: 'ë§ˆê°ì¼ ì •ë³´ë¥¼ ë‚ ì§œ í˜•ì‹ìœ¼ë¡œ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'
    });
  }

  // ë§ˆê° 1ì‹œê°„ ì „ ~ ë§ˆê° í›„ 30ë¶„
  var start = new Date(deadlineDate.getTime() - 60 * 60 * 1000);
  var end = new Date(deadlineDate.getTime() + 30 * 60 * 1000);

  var calendar = null;
  try {
    calendar = CalendarApp.getCalendarById(getCalendarId_());
  } catch (e) {
    Logger.log('ì§€ì • ìº˜ë¦°ë” ì¡°íšŒ ì‹¤íŒ¨: ' + e);
  }
  if (!calendar) {
    calendar = CalendarApp.getDefaultCalendar();
  }

  var event = null;
  if (calendarIdExisting) {
    try {
      event = calendar.getEventById(calendarIdExisting);
    } catch (e2) {
      Logger.log('ê¸°ì¡´ ìº˜ë¦°ë” ì´ë²¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: ' + e2);
    }
  }

  var description =
    'ì…ì°° ê³µê³ ë²ˆí˜¸: ' + no + '\n' +
    'ë°œì£¼ì²˜: ' + client + '\n' +
    'ìˆ˜ìš”ê¸°ê´€: ' + agency + '\n' +
    'ë‚˜ë¼ì¥í„°/ì›ë¬¸ ë§í¬: ' + link;

  if (!event) {
    event = calendar.createEvent(
      title,
      start,
      end,
      {
        description: description,
        location: row[1] || ''
      }
    );
    event.addPopupReminder(24 * 60); // 1ì¼ ì „
    event.addPopupReminder(3 * 60);  // 3ì‹œê°„ ì „
  } else {
    event.setTime(start, end);
    event.setTitle(title);
    event.setDescription(description);
  }

  var eventId = event.getId();
  var cCal = colIndex_(sheet, 'ìº˜ë¦°ë”ID');
  if (cCal > 0) sheet.getRange(rowIndex, cCal).setValue(eventId);

  return jsonResponse({
    result: 'success',
    calendarId: eventId,
    eventStart: start,
    eventEnd: end,
    eventStartText: Utilities.formatDate(start, 'Asia/Seoul', 'yyyy-MM-dd HH:mm'),
    eventEndText: Utilities.formatDate(end, 'Asia/Seoul', 'yyyy-MM-dd HH:mm')
  });
}


// =======================================================
// 15ï¸âƒ£ ì™¸ë¶€ê³µê³ ì†ŒìŠ¤ ê¸°ë°˜ ì¼ë°˜ ì›¹ ìˆ˜ì§‘ (ë¬¸ì„œ ë§í¬ ì¤‘ì‹¬)
//      - "ì™¸ë¶€ê³µê³ ì†ŒìŠ¤" ì‹œíŠ¸ ê¸°ì¤€
// =======================================================
function ensureExternalSourceSheet_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('ì™¸ë¶€ê³µê³ ì†ŒìŠ¤');
  if (!sheet) {
    sheet = ss.insertSheet('ì™¸ë¶€ê³µê³ ì†ŒìŠ¤');
    sheet.appendRow(['ì‚¬ìš©', 'ì†ŒìŠ¤ëª…', 'URL', 'ë¹„ê³ ', 'ë§ˆì§€ë§‰ì‹¤í–‰', 'ìµœê·¼ê²°ê³¼ìš”ì•½']);
  }
  return sheet;
}

function collectExistingLinks_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var mainSheet = ensureMainSheet_();
  var mainValues = mainSheet.getDataRange().getValues();
  var existingLinks = {};
  for (var i = 1; i < mainValues.length; i++) {
    var link = String(mainValues[i][13] || '').trim();
    if (link) existingLinks[link] = true;
  }
  return existingLinks;
}

function updateExternalFromSourceSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var srcSheet = ensureExternalSourceSheet_();
  var data = srcSheet.getDataRange().getValues();
  if (data.length <= 1) return 0;

  var existingLinks = collectExistingLinks_();
  var totalNew = 0;

  for (var rowIdx = 1; rowIdx < data.length; rowIdx++) {
    var r = data[rowIdx];
    var useFlag = String(r[0] || '').trim().toUpperCase();
    var url = String(r[2] || '').trim();

    if (!url) continue;
    if (useFlag !== 'Y') continue;

    try {
      var newCount = processExternalSourceUrl_(url, existingLinks);
      totalNew += newCount;
      srcSheet.getRange(rowIdx + 1, 5).setValue(new Date());
      srcSheet.getRange(rowIdx + 1, 6).setValue('ì‹ ê·œ ìˆ˜ì§‘ ' + newCount + 'ê±´');
    } catch (e) {
      Logger.log('External source error (' + url + '): ' + e);
      srcSheet.getRange(rowIdx + 1, 6).setValue('ì˜¤ë¥˜: ' + e.message);
    }
  }

  return totalNew;
}

function processExternalSourceUrl_(pageUrl, existingLinks) {
  var res = UrlFetchApp.fetch(pageUrl, FETCH_OPT);
  var code = res.getResponseCode();
  if (code !== 200) throw new Error('HTTP ' + code + ' ì‘ë‹µ');

  var html = res.getContentText('UTF-8');
  var regex = /<a[^>]+href=["']([^"']+)["'][^>]*>([\s\S]*?)<\/a>/gi;
  var match;
  var found = 0;
  var detailCandidates = [];

  while ((match = regex.exec(html)) !== null) {
    var href = match[1];
    var anchorHtml = match[2] || '';
    var anchorText = anchorHtml.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
    if (!href) continue;

    var absUrl = resolveUrl_(pageUrl, href);
    var realUrl = absUrl;

    // ì˜ˆ: Google ê²€ìƒ‰ ê²°ê³¼ /url?q=
    var qMatch = absUrl.match(/[?&]q=([^&]+)/);
    if (qMatch && qMatch[1]) {
      realUrl = decodeURIComponent(qMatch[1]);
    }

    var lower = realUrl.toLowerCase();

    // 1) ë°”ë¡œ ë¬¸ì„œ ë§í¬ì¸ ê²½ìš°
    if (/\.(pdf|hwp|hwpx|doc|docx|xls|xlsx|ppt|pptx)(\?|$)/.test(lower)) {
      if (existingLinks[realUrl]) continue;
      Logger.log('ì™¸ë¶€ì†ŒìŠ¤ ë¬¸ì„œë§í¬ ë°œê²¬: ' + realUrl);
      try {
        handleSmartAdd({ fileUrl: realUrl, text: '' });
        existingLinks[realUrl] = true;
        found++;
      } catch (e) {
        Logger.log('handleSmartAdd failed for external link: ' + e);
      }
      continue;
    }

    // 2) "ì…ì°°/ê³µê³ /ìƒì„¸/ìˆ˜ì˜ê³„ì•½/ìš©ì—­" ë“± í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ìƒì„¸ í˜ì´ì§€ í›„ë³´
    if (/ì…ì°°|ê³µê³ |ìƒì„¸|ì„¸ë¶€|ìˆ˜ì˜ê³„ì•½|ìš©ì—­/i.test(anchorText)) {
      detailCandidates.push(realUrl);
    }
  }

  // ìƒì„¸ í˜ì´ì§€ëŠ” ë„ˆë¬´ ë§ì´ íƒ€ì§€ ì•Šë„ë¡ ìƒìœ„ 10ê°œë§Œ
  var maxDetail = Math.min(detailCandidates.length, 10);
  for (var i = 0; i < maxDetail; i++) {
    try {
      found += collectDocsFromDetailPage_(detailCandidates[i], existingLinks);
    } catch (e2) {
      Logger.log('Detail page parse error(' + detailCandidates[i] + '): ' + e2);
    }
  }

  return found;
}

function collectDocsFromDetailPage_(detailUrl, existingLinks) {
  var res = UrlFetchApp.fetch(detailUrl, FETCH_OPT);
  var code = res.getResponseCode();
  if (code !== 200) {
    Logger.log('Detail page HTTP ' + code + ': ' + detailUrl);
    return 0;
  }

  var html = res.getContentText('UTF-8');
  var regex = /<a[^>]+href=["']([^"']+)["'][^>]*>([\s\S]*?)<\/a>/gi;
  var match;
  var found = 0;

  while ((match = regex.exec(html)) !== null) {
    var href = match[1];
    if (!href) continue;

    var absUrl = resolveUrl_(detailUrl, href);
    var lower = absUrl.toLowerCase();
    if (!/\.(pdf|hwp|hwpx|doc|docx|xls|xlsx|ppt|pptx)(\?|$)/.test(lower)) continue;
    if (existingLinks[absUrl]) continue;

    Logger.log('ì„¸ë¶€í˜ì´ì§€ ë¬¸ì„œë§í¬ ë°œê²¬: ' + absUrl);
    try {
      handleSmartAdd({ fileUrl: absUrl, text: '' });
      existingLinks[absUrl] = true;
      found++;
    } catch (e) {
      Logger.log('handleSmartAdd failed for detail link: ' + e);
    }
  }

  return found;
}


// =======================================================
// 16ï¸âƒ£ ì™¸ë¶€ì‚¬ì´íŠ¸ ì‹œíŠ¸ ê¸°ë°˜ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ AI í•„í„° + EAIS ë³´ì™„
//      - "ì™¸ë¶€ì‚¬ì´íŠ¸" ì‹œíŠ¸ ê¸°ì¤€ (EAIS í¬í•¨)
// =======================================================
function handleExternalUpdate_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var main = ensureMainSheet_();

  // "ì™¸ë¶€ì‚¬ì´íŠ¸" ë˜ëŠ” "ì™¸ë¶€ì‚¬ì´íŠ¸ ì‹œíŠ¸" ì´ë¦„ ëª¨ë‘ ëŒ€ì‘
  var siteSheet = ss.getSheetByName('ì™¸ë¶€ì‚¬ì´íŠ¸') || ss.getSheetByName('ì™¸ë¶€ì‚¬ì´íŠ¸ ì‹œíŠ¸');
  var logSheet = ensureExternalSourceSheet_(); // ë¡œê·¸ëŠ” ì™¸ë¶€ê³µê³ ì†ŒìŠ¤ ì‹œíŠ¸ì— ê°™ì´ ê¸°ë¡

  if (!siteSheet) {
    return jsonResponse({ added: 0, error: 'ì™¸ë¶€ì‚¬ì´íŠ¸ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.' });
  }

  // ì¤‘ë³µ ë°©ì§€(ê³µê³ ë²ˆí˜¸ + ë§í¬)
  var existingNo = {};
  var existingLink = {};
  var last = main.getLastRow();
  if (last > 1) {
    var data = main.getRange(2, 1, last - 1, 14).getValues();
    for (var i = 0; i < data.length; i++) {
      var no = String(data[i][0] || '').trim();
      var link = String(data[i][13] || '').trim();
      if (no) existingNo[no] = true;
      if (link) existingLink[link] = true;
    }
  }

  var rows = siteSheet.getDataRange().getValues();
  var totalAdded = 0;
  var now = new Date();
  var today = Utilities.formatDate(now, 'Asia/Seoul', 'yyyy-MM-dd');

  for (var r = 1; r < rows.length; r++) {
    var row = rows[r];
    var use = String(row[0] || '').trim().toUpperCase() === 'Y';
    var siteName = row[1] || '';
    var url = row[2] || '';
    var maxCount = row[4] || 20;

    if (!use || !url) continue;

    // 1) EAIS URLì´ë©´ EAIS ì „ìš© íŒŒì„œ ìš°ì„  ì ìš©
    if (/eais\.go\.kr/i.test(url)) {
      try {
        var eaRes = updateFromEAIS_(url, existingNo, existingLink, maxCount, siteName);
        totalAdded += eaRes.added;
        appendExternalLog_(logSheet, siteName, url, now,
          'EAIS íŒŒì„œ: í›„ë³´ ' + eaRes.candidates + 'ê±´ / ì‹ ê·œ ' + eaRes.added + 'ê±´');
        continue; // EAISëŠ” ì—¬ê¸°ì„œ ë
      } catch (eEais) {
        Logger.log('EAIS parser fail, fallback to AI: ' + eEais);
        // ì‹¤íŒ¨ ì‹œ ì•„ë˜ ì¼ë°˜ AI ê²½ë¡œë¡œ í´ë°±
      }
    }

    // 2) ì¼ë°˜ ì‚¬ì´íŠ¸: HTML â†’ AI í•„í„°
    var html;
    try {
      html = UrlFetchApp.fetch(url, FETCH_OPT).getContentText('utf-8');
    } catch (e) {
      appendExternalLog_(logSheet, siteName, url, now, 'ì˜¤ë¥˜: ' + e.message);
      continue;
    }

    var prompt =
      'ë‹¤ìŒì€ ì…ì°°/ê³µëª¨ ëª©ë¡ í˜ì´ì§€ HTMLì´ë‹¤.\n' +
      'í•œêµ­ìˆ˜ì•ˆ í”„ë¡œí•„ì„ ê³ ë ¤í•˜ì—¬ "ì§„í–‰ì¤‘"ì´ë©´ì„œ ë§ˆê°ì¼ì´ ì˜¤ëŠ˜(' + today + ') ì´í›„ì¸ í•­ëª©ì„ ìµœëŒ€ ' + maxCount + 'ê±´ JSON ë°°ì—´ë¡œ ë°˜í™˜í•˜ë¼.\n' +
      'í•„ë“œ: {"no","region","title","date","deadline","client","agency","servicePeriod","serviceAmount","projectBudget","clientManager","siteArea","expectedTon","link","aiResult"}\n' +
      'JSON ë°°ì—´ë§Œ ì¶œë ¥í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ ì ˆëŒ€ ì“°ì§€ ë§ˆë¼.\n\n' +
      'HTML:\n' + html;

    var arr;
    try {
      arr = callGeminiJson(prompt);
    } catch (e2) {
      appendExternalLog_(logSheet, siteName, url, now, 'AI ì˜¤ë¥˜: ' + e2.message);
      continue;
    }

    if (!arr) {
      appendExternalLog_(logSheet, siteName, url, now, 'AI ì‘ë‹µ ì—†ìŒ');
      continue;
    }
    if (!Array.isArray(arr)) arr = [arr];

    var toAppend = [];
    var siteAdded = 0;

    for (var i2 = 0; i2 < arr.length; i2++) {
      var it = arr[i2] || {};
      var no2 = String(it.no || '').trim();
      var link2 = String(it.link || url).trim();

      if (no2 && existingNo[no2]) continue;
      if (link2 && existingLink[link2]) continue;

      var facility = guessFacilityType(it.title || '', (it.client || '') + ' ' + (it.agency || ''));
      var est = it.expectedTon || '';
      if (!est) {
        var h = estimateExpectedTon(
          facility,
          (it.title || '') + ' ' + (it.servicePeriod || '') + ' ' + (it.projectBudget || '')
        );
        est = h ? String(h) : '';
      }

      var amount = (it.serviceAmount && hasDigit_(it.serviceAmount))
        ? it.serviceAmount
        : (estimateAmountFromTon_(est) || '');

      var prefix =
        '[' + (facility || 'ê¸°íƒ€') +
        (est ? ' / ~' + est + 'í†¤ ì˜ˆìƒ' : '') + '] ';

      var aiRes = prefix + (it.aiResult || 'AI ë¶„ì„ ê²°ê³¼ ì—†ìŒ');
      var tonText = est ? (est + 'í†¤(ì˜ˆìƒ)') : '';

      toAppend.push([
        no2 || 'ì •ë³´ì—†ìŒ',
        it.region || '',
        it.title || 'ì œëª©ì—†ìŒ',
        it.date || '',
        it.deadline || '',
        it.client || siteName || 'ì™¸ë¶€ì‚¬ì´íŠ¸',
        it.agency || '',
        it.servicePeriod || '',
        amount,
        it.projectBudget || '',
        it.clientManager || '',
        it.siteArea || '',
        tonText,
        link2 || url,
        'ìˆ˜ë™ë“±ë¡',
        aiRes,
        ''
      ]);

      if (no2) existingNo[no2] = true;
      if (link2) existingLink[link2] = true;
      siteAdded++;
      totalAdded++;
    }

    if (toAppend.length > 0) {
      var startRow = main.getLastRow() + 1;
      main
        .getRange(startRow, 1, toAppend.length, toAppend[0].length)
        .setValues(toAppend);
    }

    appendExternalLog_(logSheet, siteName, url, now,
      'AI ì¶”ì¶œ ' + arr.length + 'ê±´ / ì‹ ê·œ ' + siteAdded + 'ê±´');
  }

  return jsonResponse({ added: totalAdded });
}

function appendExternalLog_(sheetLog, siteName, listUrl, when, summary) {
  if (!sheetLog) return;

  var last = sheetLog.getLastRow();
  if (last === 0) {
    sheetLog.appendRow(['ì‚¬ìš©', 'ì†ŒìŠ¤ëª…', 'URL', 'ë¹„ê³ ', 'ë§ˆì§€ë§‰ì‹¤í–‰', 'ìµœê·¼ê²°ê³¼ìš”ì•½']);
    last = 1;
  }

  var data = sheetLog.getDataRange().getValues();
  var target = -1;
  var urlStr = String(listUrl || '').trim();

  for (var i = 1; i < data.length; i++) {
    if (String(data[i][2] || '').trim() === urlStr) {
      target = i + 1;
      break;
    }
  }

  if (target === -1) {
    sheetLog.appendRow([
      '',
      siteName || '',
      listUrl || '',
      '',
      when || new Date(),
      summary || ''
    ]);
  } else {
    sheetLog.getRange(target, 5, 1, 2).setValues([
      [when || new Date(), summary || '']
    ]);
  }
}


// =======================================================
// 17ï¸âƒ£ EAIS ì „ìš© ì—…ë°ì´íŠ¸ (ì°¸ê°€ë“±ë¡ë§ˆê° ê¸°ë°˜ íŒŒì„œ)
//      - ì™¸ë¶€ì—ì„œ action=update_eais ë¡œ ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥
//      - handleExternalUpdate_ ë‚´ë¶€ì—ì„œë„ core í•¨ìˆ˜ ì¬ì‚¬ìš©
// =======================================================

/**
 * EAIS ì „ìš© ì—…ë°ì´íŠ¸
 *
 * ì‚¬ìš© ë°©ë²• 1) ì§ì ‘ í˜¸ì¶œ (í…ŒìŠ¤íŠ¸ìš©)
 *   doGet?action=update_eais&url=EAIS_LIST_URL
 *   â†’ jsonResponse({ added, candidates, error? }) ë°˜í™˜
 *
 * ì‚¬ìš© ë°©ë²• 2) handleExternalUpdate_ ë‚´ë¶€ì—ì„œ ì¬ì‚¬ìš©
 *   var r = updateFromEAIS_(url, existingNo, existingLink, maxCount, siteName);
 *   r.added, r.candidates ë“±ì„ í™œìš©
 *
 * @param {string} listUrl   EAIS ê³µëª¨ëª©ë¡ URL
 * @param {Object} existingNo   (ì„ íƒ) ê³µê³ ë²ˆí˜¸ ì¤‘ë³µ ì²´í¬ìš© ë§µ
 * @param {Object} existingLink (ì„ íƒ) ë§í¬ ì¤‘ë³µ ì²´í¬ìš© ë§µ
 * @param {number} maxCount  (ì„ íƒ) ìµœëŒ€ ìˆ˜ì§‘ ê±´ìˆ˜ (ê¸°ë³¸ 30)
 * @param {string} siteName  (ì„ íƒ) ì‚¬ì´íŠ¸ëª… (ë°œì£¼ì²˜ ê¸°ë³¸ê°’ì— ì‚¬ìš©)
 */
function updateFromEAIS_(listUrl, existingNo, existingLink, maxCount, siteName) {
  // í˜¸ì¶œ ëª¨ë“œ íŒë³„: íŒŒë¼ë¯¸í„° 1ê°œë§Œ ë“¤ì–´ì˜¤ë©´ doGetì—ì„œ ì§ì ‘ í˜¸ì¶œí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼
  var calledAsAction = (arguments.length <= 1);

  if (!listUrl) {
    var errRes = { added: 0, candidates: 0, error: 'EAIS URL ì—†ìŒ' };
    return calledAsAction ? jsonResponse(errRes) : errRes;
  }

  try {
    // ì¤‘ë³µ ì²´í¬ ë§µ ì¤€ë¹„
    if (!existingNo || !existingLink || calledAsAction) {
      existingNo = {};
      existingLink = {};
      // ë©”ì¸ ì‹œíŠ¸ì˜ ê¸°ì¡´ ë°ì´í„°ì—ì„œ ê³µê³ ë²ˆí˜¸/ë§í¬ ìˆ˜ì§‘
      var main = ensureMainSheet_();
      var last = main.getLastRow();
      if (last > 1) {
        var data = main.getRange(2, 1, last - 1, 14).getValues(); // A~N
        for (var i = 0; i < data.length; i++) {
          var no = String(data[i][0] || '').trim();
          var link = String(data[i][13] || '').trim();
          if (no) existingNo[no] = true;
          if (link) existingLink[link] = true;
        }
      }
    }

    var res = UrlFetchApp.fetch(listUrl, FETCH_OPT);
    if (res.getResponseCode() !== 200) {
      var httpRes = {
        added: 0,
        candidates: 0,
        error: 'EAIS HTTP ' + res.getResponseCode()
      };
      return calledAsAction ? jsonResponse(httpRes) : httpRes;
    }

    var html = res.getContentText('utf-8');
    var parsed = parseEAISList_(html, listUrl); // [{title, link, deadline, region, no, client, agency, rowText}]

    var todayStr = Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy-MM-dd');
    var todayNum = +todayStr.replace(/-/g, '');
    var candidates = 0;
    var added = 0;
    var outRows = [];

    var sheet = ensureMainSheet_();
    var cap = Math.max(1, maxCount || 30);

    for (var j = 0; j < parsed.length; j++) {
      var it = parsed[j];
      candidates++;

      var normDl = normDate_(it.deadline);
      if (!normDl) continue;

      var dlNum = +normDl.substring(0, 10).replace(/-/g, '');
      if (dlNum < todayNum) continue; // ì´ë¯¸ ë§ˆê°ëœ ê³µëª¨ ì œì™¸

      var no = String(it.no || '').trim();
      var link = it.link || listUrl;

      if (no && existingNo[no]) continue;
      if (link && existingLink[link]) continue;

      // ì‹œì„¤ ìœ í˜•/í†¤ìˆ˜/ê¸ˆì•¡ ì¶”ì •
      var facilityType = guessFacilityType(it.title || '', (it.client || '') + ' ' + (it.agency || ''));
      var estTon = estimateExpectedTon(facilityType, it.rowText || it.title || '');
      var amtText = estimateAmountFromTon_(estTon) || '';

      var prefix =
        '[' + (facilityType || 'ê¸°íƒ€') +
        (estTon ? ' / ~' + estTon + 'í†¤ ì˜ˆìƒ' : '') +
        '] ';

      var aiResult =
        prefix +
        'EAIS(ì°¸ê°€ë“±ë¡ë§ˆê° ' +
        normDl.substring(0, 16) +
        ') ê¸°ì¤€ ìë™ ì„ ë³„';

      outRows.push([
        no || 'ì •ë³´ì—†ìŒ',                  // A ê³µê³ ë²ˆí˜¸
        it.region || '',                  // B ì§€ì—­
        it.title || 'ì œëª©ì—†ìŒ',           // C ê³µê³ ëª…
        '',                               // D ê³µê³ ì¼ (ëª©ë¡ì— ì—†ìœ¼ë©´ ê³µë€)
        normDl,                           // E ë§ˆê°ì¼ (ì •ê·œí™” ë¬¸ìì—´)
        it.client || siteName || 'EAIS',  // F ë°œì£¼ì²˜
        it.agency || '',                  // G ìˆ˜ìš”ê¸°ê´€
        '',                               // H ìš©ì—­ê¸°ê°„
        amtText,                          // I ìš©ì—­ê¸ˆì•¡(í†¤ìˆ˜ ê¸°ë°˜ ì¶”ì •)
        '',                               // J ì‚¬ì—…ë¹„
        '',                               // K ë°œì£¼ì²˜ë‹´ë‹¹ì
        '',                               // L ëŒ€ì§€ë©´ì 
        estTon ? (estTon + 'í†¤(ì˜ˆìƒ)') : '', // M ì˜ˆìƒí†¤ìˆ˜
        link,                             // N ë§í¬
        'ìˆ˜ë™ë“±ë¡',                       // O ìƒíƒœ
        aiResult,                         // P AI ë¶„ì„ê²°ê³¼(ìš”ì•½)
        ''                                // Q ìº˜ë¦°ë”ID
      ]);

      if (no) existingNo[no] = true;
      if (link) existingLink[link] = true;
      added++;

      if (outRows.length >= cap) break;
    }

    if (outRows.length > 0) {
      var startRow = sheet.getLastRow() + 1;
      sheet
        .getRange(startRow, 1, outRows.length, outRows[0].length)
        .setValues(outRows);
    }

    var result = { added: added, candidates: candidates };
    return calledAsAction ? jsonResponse(result) : result;

  } catch (err) {
    Logger.log('updateFromEAIS_ error: ' + err);
    var errorRes = { added: 0, candidates: 0, error: String(err.message || err) };
    return calledAsAction ? jsonResponse(errorRes) : errorRes;
  }
}

/**
 * EAIS ë‚ ì§œ ë¬¸ìì—´ ì •ê·œí™”
 * ì˜ˆ) "2025.11.30 18:00" â†’ "2025-11-30 18:00"
 *    "2025-11-30"        â†’ "2025-11-30 00:00"
 */
function normDate_(s) {
  if (!s) return '';
  s = String(s).trim();

  // 2025-11-30 18:00, 2025.11.30 18:00, 2025/11/30 18:00 ë“±
  var m = s.match(
    /(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})(?:\s+(\d{1,2}):(\d{2}))?/
  );
  if (!m) return '';

  var y = +m[1];
  var mo = ('0' + m[2]).slice(-2);
  var d = ('0' + m[3]).slice(-2);
  var hh = ('0' + (m[4] || '00')).slice(-2);
  var mm = ('0' + (m[5] || '00')).slice(-2);

  return y + '-' + mo + '-' + d + ' ' + hh + ':' + mm;
}

/**
 * EAIS ê³µëª¨ëª©ë¡ HTML íŒŒì„œ
 *  - <tr> ë‹¨ìœ„ë¡œ ì½ì–´ ì œëª©/ìƒì„¸ë§í¬/ì°¸ê°€ë“±ë¡ë§ˆê°/ê³µê³ ë²ˆí˜¸ ë“± ì¶”ì¶œ
 *  - ì‹¤ì œ EAIS ë§ˆí¬ì—…ì— ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ ì •ê·œì‹ ê¸°ë°˜ ìµœì†Œ íŒŒì‹±
 *
 * @param {string} html    ëª©ë¡ í˜ì´ì§€ HTML
 * @param {string} baseUrl ê¸°ì¤€ URL (ìƒëŒ€ê²½ë¡œ ë³´ì •ìš©)
 * @returns {Array<{title, link, deadline, region, no, client, agency, rowText}>}
 */
function parseEAISList_(html, baseUrl) {
  var items = [];
  if (!html) return items;

  // tr ë‹¨ìœ„ë¡œ ë¶„ë¦¬
  var trs = html.match(/<tr[\s\S]*?<\/tr>/gi) || [];
  for (var i = 0; i < trs.length; i++) {
    var tr = trs[i];

    // script/style ì œê±°
    var clean = tr
      .replace(/<script[\s\S]*?<\/script>/gi, ' ')
      .replace(/<style[\s\S]*?<\/style>/gi, ' ');

    var rowText = clean
      .replace(/<[^>]+>/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();

    if (!rowText) continue;

    // ìµœì†Œ í‚¤ì›Œë“œë¡œ EAIS ê³µëª¨ í–‰ë§Œ í•„í„°
    if (!/ê³µëª¨|ì…ì°°|ì°¸ê°€|ë“±ë¡|ì„¤ê³„|ìš©ì—­|ì‚¬ì—…|ë§ˆê°/i.test(rowText)) {
      continue;
    }

    // ì œëª© ë° ìƒì„¸ ë§í¬
    var aMatch = tr.match(/<a[^>]+href=["']([^"']+)["'][^>]*>([\s\S]*?)<\/a>/i);
    var link = aMatch ? resolveUrl_(baseUrl, aMatch[1]) : baseUrl;
    var title = aMatch
      ? (aMatch[2] || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim()
      : rowText.substring(0, 80);

    // ì°¸ê°€ë“±ë¡ë§ˆê° / ë§ˆê°ì¼ ì¶”ì¶œ
    var deadlineMatch =
      rowText.match(
        /ì°¸ê°€\s*ë“±ë¡\s*ë§ˆê°[^0-9]*?(\d{4}[.\-\/]\d{1,2}[.\-\/]\d{1,2}(?:\s*\d{1,2}:\d{2})?)/i
      ) ||
      rowText.match(
        /ë§ˆê°ì¼[^0-9]*?(\d{4}[.\-\/]\d{1,2}[.\-\/]\d{1,2}(?:\s*\d{1,2}:\d{2})?)/i
      );
    var deadline = deadlineMatch ? deadlineMatch[1] : '';

    // ê³µê³ ë²ˆí˜¸ ë¹„ìŠ·í•œ íŒ¨í„´ (ìˆìœ¼ë©´)
    var noMatch =
      rowText.match(/ê³µê³ ë²ˆí˜¸[\s:]*([A-Za-z0-9\-\_]+)/) ||
      rowText.match(/ë²ˆí˜¸[\s:]*([A-Za-z0-9\-\_]+)/);
    var no = noMatch ? noMatch[1] : '';

    // ë°œì£¼ì²˜ ë‹¨ì„œ ì¶”ì¶œ (ìˆìœ¼ë©´)
    var client = '';
    var cli = rowText.match(
      /ë°œì£¼ì²˜\s*:?\s*([ê°€-í£A-Za-z0-9\(\)Â·\s]+?)(?:\s{2,}|,|$)/
    );
    if (cli) client = cli[1].trim();

    items.push({
      title: title,
      link: link,
      deadline: deadline,
      region: '',
      no: no,
      client: client,
      agency: '',
      rowText: rowText
    });
  }

  return items;
}

// =======================================================
// 18ï¸âƒ£ ì™¸ë¶€ ë¦¬ìŠ¤íŠ¸(ì¼ë°˜) í›„ë³´ ì¶”ì¶œê¸° â€” ë°±ì—…/ë””ë²„ê¹…ìš©
//      (í˜„ì¬ ë©”ì¸ ë¡œì§ì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šë”ë¼ë„ ê¸°ëŠ¥ ë³´ì¡´)
// =======================================================
function extractExternalItems_(html, baseUrl) {
  var items = [];
  if (!html) return items;

  var trs = html.match(/<tr[\s\S]*?<\/tr>/gi) || [];
  for (var i = 0; i < trs.length && items.length < 200; i++) {
    var tr = trs[i];
    var rowText = tr
      .replace(/<script[\s\S]*?<\/script>/gi, ' ')
      .replace(/<style[\s\S]*?<\/style>/gi, ' ')
      .replace(/<[^>]+>/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();

    if (!rowText) continue;

    // ì…ì°°/ê³µëª¨/ìš©ì—­/EAIS ë“± í‚¤ì›Œë“œ í¬í•¨ í–‰ë§Œ ì¶”ì¶œ
    if (
      !/ì…ì°°|ê³µëª¨|ìš©ì—­|ì„¤ê³„|ê³µê³ |ì°¸ê°€ë“±ë¡|ì°¸ê°€\s*ì‹ ì²­|ìˆ˜ì˜ê³„ì•½|ì‚¬ì—…|ì°¸ê°€|ë§ˆê°|EAIS/i.test(
        rowText
      )
    ) {
      continue;
    }

    var title = '';
    var a = tr.match(/<a[^>]*>([\s\S]*?)<\/a>/i);
    if (a) {
      title = a[1]
        .replace(/<[^>]+>/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }
    if (!title) {
      title = rowText.substring(0, 80);
    }

    var hrefMatch = tr.match(/<a[^>]+href=["']([^"']+)["']/i);
    var url = hrefMatch ? resolveUrl_(baseUrl, hrefMatch[1]) : baseUrl;

    var d = rowText.match(/(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/);
    var deadline = d ? d[0] : '';

    items.push({
      title: title,
      url: url,
      rowText: rowText,
      deadline: deadline
    });
  }

  return items;
}
