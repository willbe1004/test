<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ 100% ìœ ì§€ */
    :root { --bg-main: #050b16; --bg-card: #0e1b2a; --accent: #ffb83f; --text-main: #f4f7fb; --border: #1e3146; }
    body { background-color: var(--bg-main); color: var(--text-main); font-family: sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .title { font-size: 1.8rem; font-weight: bold; color: var(--accent); margin-bottom: 15px; }
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; }
    input, select, button { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: #122538; color: white; }
    button { cursor: pointer; font-weight: bold; background: var(--accent); color: black; border: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: #9faec6; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; background: #333; }
    .badge-high { background: rgba(255, 92, 122, 0.2); color: #ff5c7a; }
    .ai-btn { background: #00c896; color: black; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:999; color:white; font-size:1.5rem; }
  </style>
</head>
<body>

<div class="loading" id="loadingParams">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>

<div class="container">
  <div class="card">
    <div class="title">í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬ (v9 Final)</div>
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." style="flex:1;">
      <button onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <div class="card">
    <table id="mainTable">
      <thead>
        <tr>
          <th>No</th><th>ì§€ì—­</th><th>ê³µê³ ëª…</th><th>ê´€ë ¨ì„±</th><th>ê³µê³ ì¼</th><th>ë§ˆê°ì¼</th><th>ë°œì£¼ì²˜</th><th>AIë¶„ì„</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
  let rawData = [];

  window.onload = loadData;

  function showLoading(show) {
    document.getElementById('loadingParams').style.display = show ? 'flex' : 'none';
  }

  function loadData() {
    showLoading(true);
    google.script.run
      .withSuccessHandler(function(res) {
        showLoading(false);
        if (res && res.data) {
          rawData = res.data;
          renderTable();
        } else {
          alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
      })
      .withFailureHandler(function(err) {
        showLoading(false);
        alert("ì˜¤ë¥˜ ë°œìƒ: " + err);
      })
      .fetchRecentNotices();
  }

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    const keyword = document.getElementById('searchInput').value.toLowerCase();

    rawData.forEach(item => {
      if (item.title.toLowerCase().includes(keyword) || item.client.toLowerCase().includes(keyword)) {
        const tr = document.createElement('tr');
        
        let badgeClass = 'badge';
        if (item.relevance === 'ìƒ') badgeClass += ' badge-high';
        
        const btnText = item.lastDeepAnalyze ? 'âœ… ì™„ë£Œ' : 'âš¡ ë¶„ì„';
        
        tr.innerHTML = `
          <td>${item.no}</td>
          <td>${item.region}</td>
          <td><a href="${item.link}" target="_blank" style="color:#ffb83f;text-decoration:none;">${item.title}</a></td>
          <td><span class="${badgeClass}">${item.relevance || '-'}</span></td>
          <td>${item.date}</td>
          <td>${item.deadline}</td>
          <td>${item.client}</td>
          <td>
            <button class="ai-btn" onclick="runAi(${item.rowIndex}, this)">${btnText}</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    });
  }

  function runAi(rowIndex, btn) {
    if (!confirm("AI ìƒì„¸ ë¶„ì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    btn.innerText = "â³...";
    btn.disabled = true;

    google.script.run
      .withSuccessHandler(function(res) {
        btn.disabled = false;
        btn.innerText = "âœ… ì™„ë£Œ";
        
        if (res.ok) {
          alert("ë¶„ì„ ì™„ë£Œ!\n\nì‹œì„¤ìœ í˜•: " + res.data.facilityType + "\nì˜ˆìƒí†¤ìˆ˜: " + res.data.recommendedCapacityTon + "í†¤");
          loadData(); // ëª©ë¡ ê°±ì‹ 
        } else {
          alert("ë¶„ì„ ì‹¤íŒ¨: " + res.error);
          btn.innerText = "âš¡ ë¶„ì„";
        }
      })
      .withFailureHandler(function(err) {
        btn.disabled = false;
        btn.innerText = "âš¡ ë¶„ì„";
        alert("ì„œë²„ ì˜¤ë¥˜: " + err);
      })
      .fetchDetailReview({ rowIndex: rowIndex });
  }

  document.getElementById('searchInput').addEventListener('input', renderTable);
</script>
</body>
</html>
