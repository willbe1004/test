<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: #0b1824; color: #f4f7fb; margin: 0; }
        .app { max-width: 1280px; margin: 0 auto; padding: 20px; }

        /* í—¤ë” */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        h1 { margin: 0; font-size: 1.5em; }
        .badge { background: #00cec9; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.6em; margin-left: 5px; }

        .btn { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9em; color: white; }
        .btn-primary { background: #0984e3; }
        .btn-ghost { background: rgba(255,255,255,0.1); border: 1px solid #555; }
        .btn-add { background: #a29bfe; }

        /* íˆ´ë°” */
        .toolbar { background: #111822; padding: 15px; border-radius: 12px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
        .search-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #333; background: #1e272e; color: white; min-width: 200px; }
        select { padding: 10px; border-radius: 8px; background: #1e272e; color: white; border: 1px solid #333; }
        .check-label { font-size: 0.9em; color: #aaa; display: flex; align-items: center; gap: 5px; cursor: pointer; }

        /* í†µê³„ */
        .stats { display: flex; gap: 15px; color: #aaa; font-size: 0.9em; margin-bottom: 10px; }
        .stats strong { color: #fff; }

        /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .card { background: #111822; border: 1px solid #1f2933; border-radius: 12px; padding: 20px; margin-bottom: 10px; border-left: 4px solid #0984e3; }
        .card.urgent { border-left-color: #ff7675; }
        
        .card-header { display: flex; justify-content: space-between; font-size: 0.85em; color: #95a5a6; margin-bottom: 8px; }
        .card-title { font-size: 1.2em; font-weight: bold; color: #fff; text-decoration: none; display: block; margin-bottom: 12px; }
        
        .grid-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; font-size: 0.85em; color: #dfe6e9; background: #1a2634; padding: 12px; border-radius: 8px; }
        .info-item span { display: block; font-size: 0.75em; color: #7f92b2; margin-bottom: 3px; }
        .highlight { color: #00cec9; font-weight: bold; }
        .date-val { color: #ff7675; font-weight: bold; }

        .ai-box { margin-top: 10px; padding: 10px; background: rgba(162,155,254,0.1); border: 1px solid rgba(162,155,254,0.3); border-radius: 8px; color: #a29bfe; font-size: 0.9em; }
        
        .card-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; }
        .btn-sm { padding: 5px 12px; font-size: 0.8em; border-radius: 5px; border: none; cursor: pointer; }
        .btn-cal { background: #e3f2fd; color: #0984e3; }

        /* ëª¨ë‹¬ */
        .modal-wrap { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 999; }
        .modal { background: #1e272e; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; color: white; max-height: 80vh; overflow-y: auto; }
        textarea { width: 100%; height: 120px; background: #111; border: 1px solid #555; color: white; padding: 10px; margin: 10px 0; }
        
        iframe { width: 100%; height: 500px; border: none; border-radius: 12px; margin-top: 20px; background: #fff; }
    </style>
</head>
<body>

<div class="app">
    <header>
        <h1>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬ <span class="badge">v2025.11.29</span></h1>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn-primary" onclick="loadData()">ğŸ”„ ë°ì´í„° ê°±ì‹ </button>
        </div>
    </header>

    <div class="toolbar">
        <input id="searchInput" class="search-input" placeholder="ê²€ìƒ‰ì–´ (ì§€ì—­, ë°œì£¼ì²˜, ê³µê³ ëª…)" oninput="filterList()">
        <select id="sortSelect" onchange="filterList()">
            <option value="deadline_asc">â³ ë§ˆê°ì„ë°•ìˆœ</option>
            <option value="date_desc">ğŸ“… ìµœì‹ ê³µê³ ìˆœ</option>
        </select>
        <label class="check-label"><input type="checkbox" id="showClosed" onchange="filterList()"> ë§ˆê°ëœ ê³µê³  ë³´ê¸°</label>
        <button class="btn btn-ghost" onclick="runExternalUpdate()">ğŸŒ ì™¸ë¶€ìˆ˜ì§‘</button>
        <button class="btn btn-add" onclick="openModal('addModal')">ğŸ“ ì§ì ‘ë“±ë¡</button>
    </div>

    <div class="stats">
        <span>ì´ <b id="cnt-total">0</b>ê±´</span> | 
        <span>AI ë¶„ì„ <b id="cnt-ai">0</b>ê±´</span> | 
        <span id="last-update"></span>
    </div>

    <div id="bidList">
        <div style="text-align:center; padding:40px; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <h3 style="margin-top:30px; color:#54a0ff;">ğŸ“… ì…ì°° ìº˜ë¦°ë” (íšŒì‚¬ ê³µìš©)</h3>
    <iframe id="calFrame" src=""></iframe>
</div>

<!-- ìŠ¤ë§ˆíŠ¸ ë“±ë¡ ëª¨ë‹¬ -->
<div id="addModal" class="modal-wrap">
    <div class="modal">
        <h3>ğŸ“ ìŠ¤ë§ˆíŠ¸ ê³µê³  ë“±ë¡</h3>
        <p style="font-size:0.9em; color:#ccc;">URL ë˜ëŠ” í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë¶„ì„í•˜ì—¬ ë“±ë¡í•©ë‹ˆë‹¤.</p>
        <input id="smartUrl" class="search-input" placeholder="ì²¨ë¶€íŒŒì¼/ê³µê³  URL (ì„ íƒ)">
        <textarea id="smartText" placeholder="ê³µê³  ë‚´ìš© í…ìŠ¤íŠ¸ (ì„ íƒ)"></textarea>
        <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end;">
            <button class="btn btn-ghost" onclick="closeModal('addModal')">ì·¨ì†Œ</button>
            <button id="btnSmartSave" class="btn btn-primary" onclick="processSmartAdd()">ë¶„ì„ ë° ì €ì¥</button>
        </div>
    </div>
</div>

<!-- 2ì°¨ ë¶„ì„ ëª¨ë‹¬ -->
<div id="deepModal" class="modal-wrap">
    <div class="modal">
        <h3>ğŸ¤– 2ì°¨ ìƒì„¸ ë¶„ì„</h3>
        <div id="deepContent" style="white-space: pre-line; line-height: 1.6; font-size: 0.95em; color:#ddd;"></div>
        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-ghost" onclick="closeModal('deepModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
    // ğŸš¨ [í•„ìˆ˜] Apps Script ë°°í¬ URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec';
    // ğŸš¨ [í•„ìˆ˜] ê³µìš© ìº˜ë¦°ë” ID
    const CALENDAR_ID = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com';
    
    let allData = [];

    window.onload = function() {
        loadData();
        document.getElementById('calFrame').src = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(CALENDAR_ID)}&ctz=Asia%2FSeoul&bgcolor=%23111822`;
    };

    async function loadData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const json = await res.json();
            allData = json.items || [];
            
            document.getElementById('cnt-total').innerText = allData.length;
            document.getElementById('cnt-ai').innerText = json.stats?.aiCalls || 0;
            document.getElementById('last-update').innerText = json.stats?.lastUpdate || '';
            
            filterList();
        } catch(e) {
            document.getElementById('bidList').innerHTML = `<div style="color:red;text-align:center;">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
        }
    }

    function filterList() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const showClosed = document.getElementById('showClosed').checked;
        const sortOrder = document.getElementById('sortSelect').value;
        const now = new Date(); now.setHours(0,0,0,0);

        let filtered = allData.filter(d => {
            if(q && !JSON.stringify(d).toLowerCase().includes(q)) return false;
            if(!showClosed && d.deadline && d.deadline.length >= 10) {
                if(new Date(d.deadline.substring(0,10)) < now) return false;
            }
            return true;
        });

        // ì •ë ¬
        filtered.sort((a, b) => {
            const dateA = a.deadline ? new Date(a.deadline.substring(0,10)) : new Date(9999,0,1);
            const dateB = b.deadline ? new Date(b.deadline.substring(0,10)) : new Date(9999,0,1);
            const regA = a.date ? new Date(a.date) : new Date(0);
            const regB = b.date ? new Date(b.date) : new Date(0);
            
            if(sortOrder === 'deadline_asc') return dateA - dateB;
            if(sortOrder === 'date_desc') return regB - regA;
            return 0;
        });

        renderList(filtered);
    }

    function renderList(data) {
        const list = document.getElementById('bidList');
        list.innerHTML = "";
        if(!data.length) { list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

        data.forEach(item => {
            const div = document.createElement('div');
            const isUrgent = item.deadline && new Date(item.deadline.substring(0,10)) - new Date() < 3*24*60*60*1000;
            div.className = `card ${isUrgent ? 'urgent' : 'normal'}`;
            
            div.innerHTML = `
                <div class="card-header">
                    <span>${item.no} | ${item.region || '-'}</span>
                    <span style="color:${isUrgent?'#ff7675':'#aaa'}">${item.status}</span>
                </div>
                <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                
                <div class="grid-info">
                    <div class="info-item"><span>ë°œì£¼/ìˆ˜ìš”</span>${item.client} / ${item.agency}</div>
                    <div class="info-item"><span>ê¸ˆì•¡</span><span class="highlight">${item.serviceAmount||'-'}</span></div>
                    <div class="info-item"><span>ë§ˆê°</span><span class="date-val">${item.deadline||'-'}</span></div>
                    <div class="info-item"><span>ë‹´ë‹¹ì</span>${item.clientManager||'-'}</div>
                    <div class="info-item"><span>ì˜ˆìƒí†¤ìˆ˜</span>${item.expectedTon||'-'}</div>
                </div>
                
                <div class="ai-box">ğŸ¤– ${item.aiResult || 'ë¶„ì„ ëŒ€ê¸°'}</div>

                <div class="card-footer">
                    <button class="btn-sm btn-ghost" onclick="runDeepAnalyze('${item.no}', '${item.title}', '${item.link}')">ğŸ” 2ì°¨ ë¶„ì„</button>
                    <button class="btn-sm btn-cal" onclick="registerCalendar('${item.rowIndex}')">ğŸ“… ì¼ì •ë“±ë¡</button>
                    ${item.status==='ìˆ˜ë™ë“±ë¡' ? `<button class="btn-sm" style="color:red; background:none;" onclick="deleteRow('${item.rowIndex}')">ì‚­ì œ</button>` : ''}
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function registerCalendar(idx) {
        if(!confirm("ê³µìš© ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            await fetch(`${SCRIPT_URL}?action=calendar_add&rowIndex=${idx}`, {mode:'no-cors'});
            alert("âœ… ë“±ë¡ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. (ì ì‹œ í›„ ìº˜ë¦°ë” í™•ì¸)");
            document.getElementById('calFrame').src += '';
        } catch(e) { alert("ì‹¤íŒ¨: " + e.message); }
    }

    async function runDeepAnalyze(no, title, link) {
        openModal('deepModal');
        document.getElementById('deepContent').innerText = "â³ ìƒì„¸ ë¶„ì„ ì¤‘...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=deepAnalyze&no=${no}&title=${encodeURIComponent(title)}&link=${encodeURIComponent(link)}`);
            const json = await res.json();
            const d = json.deep || {};
            document.getElementById('deepContent').innerHTML = `
                <b>[${title}]</b>\n\n
                âš ï¸ <b>ë¦¬ìŠ¤í¬:</b> ${d.risk || '-'}\n
                ğŸ“ <b>ìƒì„¸ ì‚¬ìœ :</b> ${d.riskReason || '-'}\n
                ğŸ’¡ <b>ì œì•ˆ:</b> ${d.suggestion || '-'}
            `;
        } catch(e) { document.getElementById('deepContent').innerText = "ë¶„ì„ ì‹¤íŒ¨"; }
    }

    async function processSmartAdd() {
        const url = document.getElementById('smartUrl').value;
        const text = document.getElementById('smartText').value;
        if(!url && !text) return;
        
        document.getElementById('btnSmartSave').innerText = "ì²˜ë¦¬ ì¤‘...";
        await fetch(SCRIPT_URL, { method:'POST', body:JSON.stringify({action:'smart_add', fileUrl:url, text:text}) });
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); closeModal('addModal'); loadData();
        document.getElementById('btnSmartSave').innerText = "ë¶„ì„ ë° ì €ì¥";
    }

    async function runExternalUpdate() {
        if(!confirm("ì™¸ë¶€ ìˆ˜ì§‘ ì‹œì‘?")) return;
        await fetch(SCRIPT_URL + "?action=external_update");
        alert("ìˆ˜ì§‘ ì™„ë£Œ"); loadData();
    }

    async function deleteRow(idx) {
        if(confirm("ì‚­ì œ?")) { await fetch(`${SCRIPT_URL}?action=deleteRow&rowIndex=${idx}`, {mode:'no-cors'}); loadData(); }
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
</script>

</body>
</html>
