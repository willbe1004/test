<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>한국수안 AI 입찰관리 (Front v4 안정화)</title>
  <style>
    :root{
      --bg:#050b16;--card:#0e1b2a;--card2:#122538;--line:#1e3146;
      --txt:#f4f7fb;--muted:#9faec6;--accent:#ffb83f;--good:#00c896;--bad:#ff5c7a;
      --shadow:0 12px 32px rgba(0,0,0,.35);
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo",Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:var(--sans)}
    a{color:inherit}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:800;letter-spacing:.2px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--card),rgba(14,27,42,.86));border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
    .card h2{margin:0;font-size:15px}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid rgba(30,49,70,.8);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .card .bd{padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,textarea,select{width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--txt);outline:none}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 700px){.row{grid-template-columns:1fr}}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    button{border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--txt);padding:10px 12px;border-radius:12px;cursor:pointer}
    button:hover{border-color:rgba(255,184,63,.45)}
    .primary{border-color:rgba(0,200,150,.45);background:rgba(0,200,150,.10)}
    .warn{border-color:rgba(255,92,122,.45);background:rgba(255,92,122,.08)}
    .accent{border-color:rgba(255,184,63,.55);background:rgba(255,184,63,.10)}
    .muted{color:var(--muted)}
    .status{font-size:12px;color:var(--muted);font-family:var(--mono);white-space:pre-wrap;line-height:1.45}

    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:980px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(30,49,70,.65);vertical-align:top}
    th{position:sticky;top:0;background:rgba(5,11,22,.92);backdrop-filter:blur(8px);text-align:left;font-size:12px;color:var(--muted)}
    td{font-size:13px}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
    .ok{color:var(--good)}
    .bad{color:var(--bad)}
    .mono{font-family:var(--mono)}

    /* modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(980px,100%);max-height:88vh;overflow:auto;border-radius:18px;border:1px solid var(--line);background:linear-gradient(180deg,var(--card),rgba(14,27,42,.92));box-shadow:var(--shadow)}
    .modal .hd{position:sticky;top:0;background:rgba(14,27,42,.96);backdrop-filter:blur(10px);z-index:2}
    .kvs{display:grid;grid-template-columns:220px 1fr;gap:8px;margin-top:8px}
    @media (max-width: 720px){.kvs{grid-template-columns:1fr}}
    .k{color:var(--muted);font-size:12px}
    .v{white-space:pre-wrap;line-height:1.45}
    .hr{height:1px;background:rgba(30,49,70,.8);margin:12px 0}
    .file{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:9px 10px;border:1px solid rgba(30,49,70,.8);border-radius:12px;background:rgba(255,255,255,.02);margin-top:8px}
    .file a{color:var(--accent);text-decoration:none}
    .file a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">한국수안 AI 입찰관리</div>
      <div class="pill">Front v4 (안정화)</div>
      <div class="pill" id="pillCount">items: -</div>
      <div class="pill" id="pillLast">last: -</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2>목록 / 검색</h2>
          <div class="btns">
            <button class="accent" id="btnUpdateAll">나라장터 업데이트</button>
            <button class="accent" id="btnUpdateEais">EAIS 업데이트</button>
            <button class="primary" id="btnReload">새로고침</button>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:10px">
            <div>
              <label>WebApp URL (API_BASE)</label>
              <input id="apiBase" placeholder="https://script.google.com/macros/s/xxxx/exec" />
            </div>
            <div>
              <label>검색(클라이언트 필터)</label>
              <input id="q" placeholder="공고명/기관/키워드" />
            </div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:90px">구분</th>
                  <th>공고명</th>
                  <th style="width:180px">기관</th>
                  <th style="width:120px">게시/마감</th>
                  <th style="width:120px">금액</th>
                  <th style="width:280px">AI 1차</th>
                  <th style="width:220px">액션</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
          <div class="status" id="status" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2>스마트 등록</h2></div>
        <div class="bd">
          <label>원문 텍스트</label>
          <textarea id="smartText" placeholder="텍스트 붙여넣기"></textarea>
          <div style="height:10px"></div>
          <label>원문 링크(외부 URL/Drive 공유 URL)</label>
          <input id="smartLink" placeholder="https://..." />
          <div style="height:10px"></div>
          <div class="btns">
            <button class="primary" id="btnSmart">AI 분석 및 저장</button>
            <button id="btnSmartClear">비우기</button>
          </div>
          <div class="status" id="smartStatus" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="hd">
        <div style="padding:14px 14px 10px;display:flex;gap:10px;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="muted" style="font-size:12px" id="mMeta">-</div>
            <div style="font-size:16px;font-weight:800" id="mTitle">-</div>
          </div>
          <div class="btns">
            <button id="btnReDeep" class="accent">2차 재분석</button>
            <button id="btnClose">닫기</button>
          </div>
        </div>
      </div>
      <div class="bd">
        <div>
          <div class="tag">AI 1차 요약</div>
          <div class="v" id="mSummary" style="margin-top:8px"></div>
        </div>

        <div class="hr"></div>

        <div>
          <div class="tag">AI 심화(2차)</div>
          <div id="mDeep"></div>
        </div>

        <div class="hr"></div>

        <div>
          <div class="tag">첨부파일</div>
          <div id="mFiles" class="muted" style="margin-top:8px">-</div>
        </div>

        <div class="hr"></div>

        <div class="status" id="mStatus"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // --- state ---
  let ALL = [];
  let CURRENT = null;

  // --- helpers ---
  const nowStr = () => new Date().toISOString().replace('T',' ').slice(0,19);

  function getApiBase(){
    const v = ($('apiBase').value || '').trim();
    return v;
  }
  function setStatus(msg){ $('status').textContent = (msg || '').trim(); }
  function setSmartStatus(msg){ $('smartStatus').textContent = (msg || '').trim(); }
  function setModalStatus(msg){ $('mStatus').textContent = (msg || '').trim(); }

  function saveApiBase(){
    const v = getApiBase();
    if(v) localStorage.setItem('KSUAN_API_BASE', v);
  }
  function loadApiBase(){
    const q = new URLSearchParams(location.search);
    const fromUrl = (q.get('api_base') || q.get('apiBase') || '').trim();
    const fromStore = (localStorage.getItem('KSUAN_API_BASE') || '').trim();
    $('apiBase').value = fromUrl || fromStore || '';
  }

  async function fetchJson(url, options){
    const res = await fetch(url, options);
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; }
    catch(e){
      // non-json response (often auth page / error html)
      const msg = `Non-JSON response (HTTP ${res.status})\n` + text.slice(0, 400);
      const err = new Error(msg);
      err.httpStatus = res.status;
      err.raw = text;
      throw err;
    }
    if(!res.ok){
      throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
    }
    if(data && data.ok === false){
      throw new Error(data.error || 'Server returned ok=false');
    }
    return data;
  }

  function normalizeItem(x){
    const item = Object.assign({}, x || {});
    // common aliases
    item.no = item.no || item.bidNo || item.bidNtceNo || item.bidNtceNo || '';
    item.kind = item.kind || item.source || item.type || '';
    item.title = item.title || item.name || item.bidName || item.bidNtceNm || '';
    item.org = item.org || item.demandOrg || item.nfName || item.ntceInsttNm || '';
    item.posted = item.posted || item.postedDate || item.ntceDt || '';
    item.deadline = item.deadline || item.deadlineDate || item.clsgDt || item.bidClseDt || '';
    item.amount = item.amount || item.amountText || item.amountWon || item.amountKRW || '';
    item.link = item.link || item.url || item.detailUrl || item.bidUrl || '';

    // AI 1차
    item.aiSummary = item.aiSummary || item.aiResult || item.ai_summary || item.ai_result || item.summary || '';
    item.aiResult = item.aiResult || item.aiSummary;

    // attachments may come as JSON string
    item.attachments = normalizeAttachments(item.attachments || item.files || item.attachmentsJson || item.attachments_json || item.attachmentsJSON || null);

    return item;
  }

  function normalizeAttachments(raw){
    if(!raw) return [];
    if(Array.isArray(raw)){
      return raw.map(a => {
        if(typeof a === 'string') return { name: a, url: '' };
        return {
          name: (a.name || a.fileName || a.filename || a.title || '').toString(),
          url: (a.url || a.link || a.href || '').toString()
        };
      });
    }
    if(typeof raw === 'string'){
      const s = raw.trim();
      if(!s) return [];
      try{
        const j = JSON.parse(s);
        return normalizeAttachments(j);
      }catch(e){
        // fallback: split lines
        return s.split(/\r?\n+/).map(v=>v.trim()).filter(Boolean).map(v=>({name:v,url:''}));
      }
    }
    if(typeof raw === 'object'){
      return normalizeAttachments(raw.attachments || raw.files || raw.items || raw.list || []);
    }
    return [];
  }

  function trunc(s, n){
    s = (s || '').toString().trim();
    if(!s) return '';
    return s.length > n ? s.slice(0,n-1) + '…' : s;
  }

  function moneyPretty(v){
    const s = (v ?? '').toString().trim();
    if(!s) return '';
    // keep as-is; do not infer/convert
    return s;
  }

  function render(){
    const q = ($('q').value || '').trim().toLowerCase();
    const rows = (q ? ALL.filter(it => {
      const hay = `${it.title} ${it.org} ${it.kind} ${it.no}`.toLowerCase();
      return hay.includes(q);
    }) : ALL);

    $('pillCount').textContent = `items: ${rows.length}`;

    const tb = $('tbody');
    tb.innerHTML = '';

    if(rows.length === 0){
      tb.innerHTML = `<tr><td colspan="7" class="muted">표시할 항목이 없습니다.</td></tr>`;
      return;
    }

    for(const item of rows){
      const ai = (item.aiSummary || item.aiResult || '').toString().trim();
      const aiText = ai ? trunc(ai.replace(/\n+/g,' '), 140) : 'AI 분석 실패';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="tag">${(item.kind||'-').toString()}</span></td>
        <td>
          <div style="font-weight:800">${escapeHtml(item.title||'-')}</div>
          <div class="muted mono" style="font-size:12px;margin-top:4px">${escapeHtml(item.no||'')}</div>
          ${item.link ? `<div style="margin-top:6px"><a href="${escapeAttr(item.link)}" target="_blank" rel="noopener" class="muted" style="font-size:12px">원문 링크</a></div>` : ''}
        </td>
        <td>${escapeHtml(item.org||'-')}</td>
        <td>
          <div class="muted" style="font-size:12px">게시</div>
          <div>${escapeHtml(item.posted||'-')}</div>
          <div class="muted" style="font-size:12px;margin-top:6px">마감</div>
          <div>${escapeHtml(item.deadline||'-')}</div>
        </td>
        <td class="mono">${escapeHtml(moneyPretty(item.amount)||'-')}</td>
        <td>${escapeHtml(aiText)}</td>
        <td>
          <div class="btns">
            <button class="accent" data-act="deep">2차 상세</button>
            <button data-act="files">첨부</button>
            <button class="primary" data-act="cal">캘린더</button>
            <button class="warn" data-act="del">삭제</button>
          </div>
        </td>
      `;

      tr.querySelector('[data-act="deep"]').onclick = () => openModal(item, { force: false });
      tr.querySelector('[data-act="files"]').onclick = () => showFilesQuick(item);
      tr.querySelector('[data-act="cal"]').onclick = () => addCalendar(item);
      tr.querySelector('[data-act="del"]').onclick = () => deleteBid(item);
      tb.appendChild(tr);
    }
  }

  function escapeHtml(s){
    return (s ?? '').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll('`','');
  }

  async function loadList(){
    const api = getApiBase();
    if(!api){ setStatus('API_BASE가 비어 있습니다.'); return; }
    saveApiBase();
    setStatus(`[${nowStr()}] 목록 로딩...`);
    try{
      const data = await fetchJson(api, { method:'GET', cache:'no-store' });
      const raw = Array.isArray(data?.items) ? data.items : (Array.isArray(data?.rows) ? data.rows : []);
      ALL = raw.map(normalizeItem);
      $('pillLast').textContent = `last: ${nowStr()}`;
      setStatus(`[${nowStr()}] OK (items=${ALL.length})`);
      render();
    }catch(err){
      setStatus(`[${nowStr()}] ERROR\n${err.message}`);
    }
  }

  async function callUpdate(action){
    const api = getApiBase();
    if(!api){ setStatus('API_BASE가 비어 있습니다.'); return; }
    saveApiBase();
    setStatus(`[${nowStr()}] ${action} 실행...`);
    try{
      const url = api + (api.includes('?') ? '&' : '?') + 'action=' + encodeURIComponent(action);
      const data = await fetchJson(url, { method:'GET', cache:'no-store' });
      setStatus(`[${nowStr()}] OK\n${JSON.stringify(data).slice(0,800)}`);
      await loadList();
    }catch(err){
      setStatus(`[${nowStr()}] ERROR\n${err.message}`);
    }
  }

  function showModal(show){
    $('modalBack').style.display = show ? 'flex' : 'none';
  }

  function showFilesQuick(item){
    const files = normalizeAttachments(item.attachments);
    if(!files.length){
      alert('첨부파일 정보가 없습니다.');
      return;
    }
    const lines = files.map(f => f.url ? `${f.name} | ${f.url}` : `${f.name}`).join('\n');
    alert(lines);
  }

  function fillModal(item){
    $('mMeta').textContent = `${item.kind || '-'} · ${item.no || ''} · ${item.org || '-'}`;
    $('mTitle').textContent = item.title || '-';
    $('mSummary').textContent = (item.aiSummary || item.aiResult || '').toString().trim() || '-';
    $('mDeep').innerHTML = '<div class="muted">-</div>';
    $('mFiles').textContent = '-';
    setModalStatus('');
  }

  function renderDeep(deep){
    if(!deep || typeof deep !== 'object' || Object.keys(deep).length === 0){
      $('mDeep').innerHTML = '<div class="muted">AI 심화분석 결과가 없습니다.</div>';
      return;
    }

    // sectioned view (best-effort)
    const cps = Array.isArray(deep.checkpoints) ? deep.checkpoints : (Array.isArray(deep.checkpoint) ? deep.checkpoint : null);
    const risks = Array.isArray(deep.riskPoints) ? deep.riskPoints : (Array.isArray(deep.risks) ? deep.risks : null);

    let html = '';

    const addKv = (k,v) => {
      html += `<div class="kvs"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div></div>`;
    };

    if(deep.overview) addKv('overview', deep.overview);
    if(deep.scope) addKv('scope', deep.scope);
    if(deep.amount) addKv('amount', deep.amount);
    if(deep.period) addKv('period', deep.period);

    if(risks && risks.length){
      html += `<div class="hr"></div><div class="tag">riskPoints</div>`;
      html += '<div style="margin-top:8px">' + risks.map(r => `<div class="v">• ${escapeHtml(r)}</div>`).join('') + '</div>';
    }

    if(cps && cps.length){
      html += `<div class="hr"></div><div class="tag">checkpoints</div>`;
      html += '<div style="margin-top:8px">' + cps.map(r => `<div class="v">• ${escapeHtml(r)}</div>`).join('') + '</div>';
    }

    // dump rest
    const skip = new Set(['overview','scope','amount','period','riskPoints','risks','checkpoints','checkpoint']);
    const rest = Object.entries(deep).filter(([k]) => !skip.has(k));
    if(rest.length){
      html += `<div class="hr"></div><div class="tag">raw</div>`;
      for(const [k,v] of rest){
        const vv = typeof v === 'string' ? v : JSON.stringify(v, null, 2);
        addKv(k, vv);
      }
    }

    $('mDeep').innerHTML = html;
  }

  function renderFiles(files){
    const list = normalizeAttachments(files);
    if(!list.length){
      $('mFiles').innerHTML = '<div class="muted">첨부파일 정보가 없습니다.</div>';
      return;
    }
    $('mFiles').innerHTML = list.map(f => {
      const name = escapeHtml(f.name || '(파일명 없음)');
      const url = (f.url || '').trim();
      if(url){
        return `<div class="file"><div class="v">${name}</div><div><a href="${escapeAttr(url)}" target="_blank" rel="noopener">다운로드</a></div></div>`;
      }
      return `<div class="file"><div class="v">${name}</div><div class="muted">URL 없음</div></div>`;
    }).join('');
  }

  async function deepAnalyze(item, { force }){
    const api = getApiBase();
    const no = (item.no || '').toString().trim();
    const link = (item.link || '').toString().trim();

    const params = new URLSearchParams();
    params.set('action', 'deepAnalyze');
    if(no) params.set('no', no);
    if(link) params.set('link', link);
    if(force) params.set('force', '1');

    setModalStatus(`[${nowStr()}] deepAnalyze 호출...`);

    const data = await fetchJson(api, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: params.toString(),
    });

    const deep = (data && typeof data.deep === 'object') ? data.deep : (data?.data?.deep && typeof data.data.deep === 'object' ? data.data.deep : {});
    const files = normalizeAttachments(data.attachments || data.files || data.attachmentList || data.attachmentsJson || data.attachments_json || item.attachments || []);

    // best-effort: update summary from deep if provided
    const fs = (deep.firstSummary || deep.summary || deep.aiSummary || '').toString().trim();
    if(fs){
      item.aiSummary = item.aiSummary || fs;
      item.aiResult = item.aiResult || fs;
    }

    item.attachments = files;

    renderDeep(deep);
    renderFiles(files);

    setModalStatus(`[${nowStr()}] OK`);

    // refresh row text quickly
    render();
  }

  async function openModal(item, { force }){
    CURRENT = item;
    fillModal(item);
    showModal(true);

    try{
      // deep analyze if no 1차 요약 or if forced
      const hasAi = (item.aiSummary || item.aiResult || '').toString().trim().length > 0;
      if(force || !hasAi){
        await deepAnalyze(item, { force });
      }else{
        // still try deepAnalyze to get deep + files (non-blocking)
        await deepAnalyze(item, { force:false });
      }
    }catch(err){
      // stable error rendering (do not crash UI)
      renderDeep({});
      renderFiles([]);
      setModalStatus(`[${nowStr()}] ERROR\n${err.message}`);
    }
  }

  async function deleteBid(item){
    const api = getApiBase();
    if(!api){ alert('API_BASE가 비어 있습니다.'); return; }
    if(!confirm('삭제하시겠습니까?')) return;

    try{
      const params = new URLSearchParams();
      params.set('action', 'delete_bid');
      if(item.no) params.set('no', item.no);
      if(item.link) params.set('link', item.link);

      await fetchJson(api, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString(),
      });

      ALL = ALL.filter(x => x !== item);
      render();
      setStatus(`[${nowStr()}] 삭제 완료`);
    }catch(err){
      alert(err.message);
    }
  }

  async function addCalendar(item){
    const api = getApiBase();
    if(!api){ alert('API_BASE가 비어 있습니다.'); return; }
    try{
      const params = new URLSearchParams();
      params.set('action', 'calendar_add');
      if(item.no) params.set('no', item.no);
      if(item.title) params.set('title', item.title);
      if(item.deadline) params.set('deadline', item.deadline);
      if(item.link) params.set('link', item.link);

      const data = await fetchJson(api, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString(),
      });
      alert('캘린더 등록 완료');
      return data;
    }catch(err){
      alert(err.message);
    }
  }

  async function smartAdd(){
    const api = getApiBase();
    if(!api){ setSmartStatus('API_BASE가 비어 있습니다.'); return; }

    const text = ($('smartText').value || '').trim();
    const link = ($('smartLink').value || '').trim();
    if(!text && !link){ setSmartStatus('텍스트 또는 링크를 입력하세요.'); return; }

    saveApiBase();
    setSmartStatus(`[${nowStr()}] smartAdd 호출...`);

    try{
      const params = new URLSearchParams();
      params.set('action', 'smartAdd');
      if(text) params.set('text', text);
      if(link) params.set('link', link);

      const data = await fetchJson(api, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString(),
      });

      setSmartStatus(`[${nowStr()}] OK\n${JSON.stringify(data).slice(0,900)}`);
      await loadList();
    }catch(err){
      setSmartStatus(`[${nowStr()}] ERROR\n${err.message}`);
    }
  }

  // --- wiring ---
  $('btnReload').onclick = () => loadList();
  $('btnUpdateAll').onclick = () => callUpdate('updateAll');
  $('btnUpdateEais').onclick = () => callUpdate('update_eais');
  $('btnSmart').onclick = () => smartAdd();
  $('btnSmartClear').onclick = () => { $('smartText').value=''; $('smartLink').value=''; setSmartStatus(''); };

  $('q').addEventListener('input', () => render());
  $('apiBase').addEventListener('change', () => saveApiBase());

  $('btnClose').onclick = () => showModal(false);
  $('modalBack').addEventListener('click', (e) => { if(e.target === $('modalBack')) showModal(false); });
  document.addEventListener('keydown', (e) => { if(e.key === 'Escape') showModal(false); });

  $('btnReDeep').onclick = () => { if(CURRENT) openModal(CURRENT, { force:true }); };

  // init
  loadApiBase();
  // auto load if api base present
  if(getApiBase()) loadList();
})();
</script>
</body>
</html>
