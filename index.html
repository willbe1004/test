<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬ (í˜„ì¬ UI - ê°€ë…ì„± ê°•í™”)</title>

  <!-- âœ… Google Identity Services (ì„ íƒ) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg-main:#050b16;
      --bg-card:#0e1b2a;
      --bg-card-soft:#122538;
      --accent:#ffb83f;
      --accent-soft: rgba(255, 184, 63, 0.16);
      --accent-strong:#ff9f1c;
      --primary:#00c896;
      --primary-soft: rgba(0, 200, 150, 0.14);
      --text:#eaf1fb;
      --muted:#a7bad1;
      --muted2:#7f95ae;
      --danger:#ff5c7a;
      --line: rgba(255,255,255,0.10);
      --line2: rgba(255,255,255,0.06);

      /* âœ… ê°€ë…ì„± ê°•í™”: í°íŠ¸/ê°„ê²©ì„ í¬ê²Œ */
      --fs-base: 16.5px;
      --fs-small: 14.5px;
      --fs-title: 20px;
      --fs-card-title: 18px;
      --fs-btn: 15.5px;
      --radius: 18px;
      --shadow: 0 16px 60px rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial;
      font-size: var(--fs-base);
      line-height: 1.62;
      letter-spacing:-0.15px;
      color: var(--text);
      background:
        radial-gradient(1200px 520px at 12% 0%, rgba(0,200,150,0.15), transparent 55%),
        radial-gradient(1000px 520px at 88% 0%, rgba(255,184,63,0.14), transparent 58%),
        linear-gradient(180deg, var(--bg-main) 0%, #071427 60%, var(--bg-main) 100%);
    }
    a{color:inherit;}
    .wrap{max-width: 1280px; margin:0 auto; padding: 16px 18px;}

    /* top bar */
    header{
      position: sticky; top:0; z-index: 50;
      background: rgba(5,11,22,0.80);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--line2);
    }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
    }
    .brand h1{
      margin:0;
      font-size: var(--fs-title);
      font-weight: 950;
      letter-spacing:-0.6px;
    }
    .subline{
      margin-top:8px;
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: var(--fs-small);
      font-weight: 900;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,0.04);
    }
    .pill b{color: var(--text); font-weight: 950;}
    .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    #userEmail{
      color: var(--muted);
      font-size: var(--fs-small);
      font-weight: 950;
    }

    /* controls */
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top: 14px;
    }
    .search{
      flex:1; min-width: 260px;
      display:flex; align-items:center; gap:10px;
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,0.04);
    }
    .search input{
      width:100%;
      border:0; outline:none;
      background: transparent;
      color: var(--text);
      font-size: 16px; /* âœ… í¬ê²Œ */
      font-weight: 800;
    }

    .btn{
      cursor:pointer;
      border:1px solid var(--line2);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: 11px 14px;
      border-radius: 16px;
      font-size: var(--fs-btn);
      font-weight: 950;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px);}
    .btn.primary{ background: var(--primary-soft); border-color: rgba(0,200,150,0.38); }
    .btn.accent{ background: var(--accent-soft); border-color: rgba(255,184,63,0.34); }
    .btn.ghost{ background: rgba(255,255,255,0.03); }
    .btn.small{ padding: 9px 12px; border-radius: 14px; font-size: 14.5px; }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 14.5px;
      font-weight: 950;
    }
    .tab.active{
      background: rgba(0,200,150,0.15);
      border-color: rgba(0,200,150,0.40);
      color: var(--text);
    }

    /* list */
    main .wrap{ padding-top: 14px; padding-bottom: 64px; }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      gap: 12px;
    }
    .card{
      border:1px solid var(--line2);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(14,27,42,0.92), rgba(8,16,28,0.92));
      box-shadow: 0 10px 34px rgba(0,0,0,0.35);
      padding: 14px 14px 12px;
    }
    .cardTop{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .card h2{
      margin:0;
      font-size: var(--fs-card-title);
      font-weight: 950;
      letter-spacing:-0.35px;
    }
    .tag{
      display:inline-flex; align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size: 13.5px;
      font-weight: 950;
      white-space:nowrap;
    }
    .tag.g2b{ border-color: rgba(255,184,63,0.35); color:#ffd18a; }
    .tag.eais{ border-color: rgba(0,200,150,0.35); color:#8ff0d8; }
    .tag.web{ border-color: rgba(125,177,255,0.35); color:#b9d7ff; }
    .meta{
      margin-top: 10px;
      display:flex; gap:12px; flex-wrap:wrap;
      color: var(--muted);
      font-size: var(--fs-small);
      font-weight: 850;
    }
    .meta b{color: var(--text); font-weight: 950;}
    .summary{
      margin-top: 10px;
      padding: 12px 12px;
      border:1px solid var(--line2);
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      color:#dbe9fb;
      font-size: 15.2px;
      white-space: pre-wrap;
    }
    .actions{
      margin-top: 12px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .actions a{ text-decoration:none; display:inline-flex; align-items:center; }

    /* modal */
    .back{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,0.62);
      z-index: 1000;
    }
    .modal{
      width:min(1120px, 96vw);
      max-height: 88vh;
      overflow:auto;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,0.12);
      background:
        radial-gradient(1200px 400px at 0% 0%, rgba(0,200,150,0.12), transparent 60%),
        radial-gradient(1100px 460px at 100% 0%, rgba(255,184,63,0.10), transparent 60%),
        linear-gradient(180deg, rgba(14,27,42,0.98), rgba(8,16,28,0.98));
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
    }
    .modalHeader h3{
      margin:0;
      font-size: 19px;
      font-weight: 950;
      letter-spacing:-0.35px;
    }
    .modalHeader .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 14.5px;
      font-weight: 850;
    }
    .cols{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .cols{ grid-template-columns: 1fr; }
    }
    .panel{
      border:1px solid var(--line2);
      border-radius: 18px;
      background: rgba(255,255,255,0.03);
      padding: 14px;
    }
    .panel h4{
      margin:0 0 10px;
      font-size: 15.5px;
      font-weight: 950;
      letter-spacing:-0.2px;
    }
    .text{
      color:#dbe9fb;
      font-size: 15.2px;
      white-space: pre-wrap;
    }
    pre{
      margin:0;
      white-space: pre-wrap;
      color:#dbe9fb;
      font-size: 14px;
      line-height:1.55;
    }
    label{
      display:block;
      margin: 10px 0 6px;
      color:#cfe0f7;
      font-size: 14.5px;
      font-weight: 950;
    }
    input, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline:none;
      font-size: 16px; /* âœ… í¬ê²Œ */
      font-weight: 800;
    }
    textarea{ min-height: 120px; resize: vertical; }

    .mini{
      margin-top: 10px;
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 14px;
      font-weight: 850;
    }

    /* toast */
    .toast{
      position: fixed; left:50%; bottom: 22px; transform: translateX(-50%);
      background: rgba(0,0,0,0.82); color:#fff;
      border:1px solid rgba(255,255,255,0.12);
      padding: 12px 14px;
      border-radius: 999px;
      opacity: 0; pointer-events:none;
      transition: opacity .2s ease;
      font-weight: 950;
      z-index: 2000;
    }
    .toast.show{opacity:1;}

    /* settings */
    .drawerBack{
      position:fixed; inset:0;
      display:none;
      align-items:flex-start; justify-content:flex-end;
      background: rgba(0,0,0,0.62);
      z-index: 1200;
    }
    .drawer{
      width: min(520px, 92vw);
      height: 100%;
      overflow:auto;
      background: linear-gradient(180deg, rgba(14,27,42,0.98), rgba(8,16,28,0.98));
      border-left: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .divider{height:1px; background: rgba(255,255,255,0.08); margin: 12px 0;}
    .hint{ color: var(--muted2); font-size: 13.5px; font-weight: 800; line-height:1.55; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>
        <div class="subline">
          <span class="pill">API: <b id="apiShort">ë¯¸ì„¤ì •</b></span>
          <span class="pill">ë²„ì „: <b id="ver">-</b></span>
        </div>
      </div>

      <div class="right">
        <div id="gSignIn"></div>
        <div id="userEmail"></div>
        <button class="btn ghost small" onclick="openSettings()">ì„¤ì •</button>
      </div>
    </div>

    <div class="controls">
      <div class="search">
        <span style="opacity:.85;">ğŸ”</span>
        <input id="q" placeholder="ê²€ìƒ‰ (ê³µê³ ëª… / ê¸°ê´€ / ì§€ì—­)" onkeydown="if(event.key==='Enter'){reload();}"/>
      </div>
      <button class="btn primary" onclick="reload()">ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn accent" onclick="updateAll()">ì „ì²´ ì—…ë°ì´íŠ¸</button>

      <div class="tabs" id="tabs">
        <button class="tab active" data-v="all" onclick="setFilter(this)">ì „ì²´</button>
        <button class="tab" data-v="ë‚˜ë¼ì¥í„°" onclick="setFilter(this)">ë‚˜ë¼ì¥í„°</button>
        <button class="tab" data-v="EAIS" onclick="setFilter(this)">EAIS</button>
        <button class="tab" data-v="ì™¸ë¶€ì›¹" onclick="setFilter(this)">ì™¸ë¶€ì›¹</button>
        <button class="tab" data-v="ìŠ¤ë§ˆíŠ¸ë“±ë¡" onclick="setFilter(this)">ìŠ¤ë§ˆíŠ¸ë“±ë¡</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid" id="list"></div>
  </div>
</main>

<!-- ìƒì„¸ ëª¨ë‹¬ -->
<div class="back" id="modalBack" onclick="hideModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalHeader">
      <div>
        <h3 id="mTitle">-</h3>
        <div class="sub" id="mSub">-</div>
      </div>
      <button class="btn" onclick="hideModal()">ë‹«ê¸°</button>
    </div>

    <div class="cols">
      <div class="panel">
        <h4>AI ìš”ì•½(1ì°¨)</h4>
        <div class="text" id="mSummary"></div>

        <div style="height:12px"></div>

        <h4>ë²•ë ¹/ì¡°ë¡€ ë§¤ì¹­</h4>
        <div class="text" id="mLaw"></div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn accent" onclick="fetchLaw()">ë²•ë ¹ ë§¤ì¹­ ë‹¤ì‹œì¡°íšŒ</button>
          <button class="btn primary" onclick="runDeep()">2ì°¨ ì‹¬í™”ë¶„ì„ ì‹¤í–‰</button>
        </div>

        <div style="height:12px"></div>

        <h4>2ì°¨ ì‹¬í™”ë¶„ì„ ê²°ê³¼(JSON)</h4>
        <pre id="mDeep"></pre>
      </div>

      <div class="panel">
        <h4>ì‚¬ìš©ì ì…ë ¥ê°’ ì €ì¥ (ëŒ€ì±…ë¬¸ì„œ ë°˜ì˜ìš©)</h4>

        <label>ìš©ì—­ê¸°ê°„/ê³µì‚¬ê¸°ê°„</label>
        <input id="fServicePeriod" placeholder="ì˜ˆ: 2026-03-01 ~ 2026-08-31"/>

        <label>ìš©ì—­(ì˜ˆê°€) ê¸ˆì•¡</label>
        <input id="fServiceAmount" placeholder="ì˜ˆ: 120,000,000ì›"/>

        <label>ì´ ì‚¬ì—…ë¹„</label>
        <input id="fProjectBudget" placeholder="ì˜ˆ: ë¯¸í‘œê¸° / 3ì–µ ì› ë“±"/>

        <label>ì‹œì„¤ ìœ í˜•</label>
        <input id="fFacilityType" placeholder="ì˜ˆ: ë³‘ì› / ì²´ìœ¡ê´€ / ë„ë¡œ ë“±"/>

        <label>ë¦¬ìŠ¤í¬ ìˆ˜ì¤€</label>
        <input id="fRiskLevel" placeholder="ì˜ˆ: ë‚®ìŒ/ë³´í†µ/ë†’ìŒ"/>

        <label>ì²´í¬ í¬ì¸íŠ¸ (ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ)</label>
        <textarea id="fCheckPoints" placeholder="- ì˜ˆ: ìš°ìˆ˜ìœ ì¶œì €ê°ëŒ€ì±… ìˆ˜ë¦½ ëŒ€ìƒ ì—¬ë¶€"></textarea>

        <div class="actions">
          <button class="btn primary" onclick="saveStd()">ì…ë ¥ê°’ ì €ì¥</button>
        </div>

        <div class="mini">
          <span class="pill">ìµœì¢… ì €ì¥: <b id="mUpdatedAt">-</b></span>
          <span class="pill">ìˆ˜ì •ì: <b id="mUpdatedBy">-</b></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì„¤ì • ë“œë¡œì–´ -->
<div class="drawerBack" id="drawerBack" onclick="closeSettings()">
  <div class="drawer" onclick="event.stopPropagation()">
    <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
      <div style="font-size:16px; font-weight:950;">ì„¤ì •</div>
      <button class="btn" onclick="closeSettings()">ë‹«ê¸°</button>
    </div>

    <div class="divider"></div>

    <label>API_BASE (Apps Script WebApp URL)</label>
    <input id="apiInput" placeholder="https://script.google.com/macros/s/AKfycbxxoKyR07FkajC6dvjlrDy8ns0L_HJaCAtGds7My9KSaF5BTEye8v1jaVjzoFC-YsjhuA/exec" />

    <div class="actions" style="margin-top:10px;">
      <button class="btn primary" onclick="saveApi()">ì €ì¥</button>
      <button class="btn ghost" onclick="testApi()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </div>
    <div class="hint" style="margin-top:10px;">
      - ì´ íŒŒì¼ì€ â€œí˜„ì¬ UIâ€ ëŠë‚Œì„ ìœ ì§€í•˜ë©´ì„œ í°íŠ¸/ê°„ê²©ë§Œ í¬ê²Œ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.<br/>
      - ì €ì¥í•œ API_BASEëŠ” ë¸Œë¼ìš°ì €(localStorage)ì— ë³´ê´€ë©ë‹ˆë‹¤.
    </div>

    <div class="divider"></div>

    <label>ë¡œê·¸ì¸/í…ŒìŠ¤íŠ¸ìš© ì´ë©”ì¼(ì„ íƒ)</label>
    <input id="emailInput" placeholder="idTokenì´ ì—†ì„ ë•Œë§Œ ì‚¬ìš© (ì˜ˆ: user@company.com)" />
    <div class="hint" style="margin-top:10px;">
      - ë°±ì—”ë“œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Google idTokenì„ ê¶Œì¥í•©ë‹ˆë‹¤.<br/>
      - í…ŒìŠ¤íŠ¸ ìƒí™©ì—ì„œ idTokenì´ ë¶ˆê°€ëŠ¥í•˜ë©´, ì—¬ê¸° ì´ë©”ì¼ì´ ìš”ì²­ì— í¬í•¨ë©ë‹ˆë‹¤.
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const state = {
    apiBase: "",
    filter: "all",
    items: [],
    currentId: "",
    currentRegion: "",
    currentItem: null
  };

  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1800);
  }

  function shortUrl(u){
    try{
      const url = new URL(u);
      return url.host + url.pathname.replace(/\/macros\/s\/[^/]+\/exec.*/,'/macros/s/.../exec');
    }catch(e){ return u ? u.slice(0,32) + (u.length>32?'...':'') : "ë¯¸ì„¤ì •"; }
  }

  function openSettings(){ document.getElementById("drawerBack").style.display="flex"; }
  function closeSettings(){ document.getElementById("drawerBack").style.display="none"; }

  function loadApi(){
    const saved = localStorage.getItem("KSUAN_API_BASE") || "";
    state.apiBase = saved.trim();
    document.getElementById("apiInput").value = state.apiBase;
    document.getElementById("apiShort").textContent = state.apiBase ? shortUrl(state.apiBase) : "ë¯¸ì„¤ì •";

    const emailSaved = localStorage.getItem("KSUAN_TEST_EMAIL") || "";
    document.getElementById("emailInput").value = emailSaved;
  }

  function saveApi(){
    const v = (document.getElementById("apiInput").value || "").trim();
    if(!v){ toast("API_BASEë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”"); return; }
    localStorage.setItem("KSUAN_API_BASE", v);
    state.apiBase = v;
    document.getElementById("apiShort").textContent = shortUrl(v);

    const em = (document.getElementById("emailInput").value || "").trim();
    localStorage.setItem("KSUAN_TEST_EMAIL", em);

    toast("ì €ì¥ ì™„ë£Œ");
    closeSettings();
    reload();
  }

  function setFilter(btn){
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    btn.classList.add("active");
    state.filter = btn.dataset.v;
    reload();
  }

  function tagClass(sourceType){
    const s = String(sourceType || '');
    if(s.includes('ë‚˜ë¼') || s.toLowerCase()==='g2b') return 'tag g2b';
    if(s.toUpperCase()==='EAIS' || s.includes('ì„¸ì›€í„°')) return 'tag eais';
    if(s.includes('ì™¸ë¶€') || s.toLowerCase()==='external') return 'tag web';
    if(s.includes('ìŠ¤ë§ˆíŠ¸')) return 'tag';
    return 'tag';
  }

  // -----------------
  // Auth
  // -----------------
  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) { return null; }
  }
  function loadStoredToken(){
    const t = localStorage.getItem("KSUAN_ID_TOKEN");
    if(t) window.__idToken = t;
    const payload = t ? parseJwt(t) : null;
    if(payload && payload.email) document.getElementById("userEmail").textContent = payload.email;
  }

  function initGoogleLogin(clientId){
    if(!clientId || !window.google || !google.accounts || !google.accounts.id) return;
    google.accounts.id.initialize({
      client_id: clientId,
      callback: (response) => {
        window.__idToken = response.credential;
        localStorage.setItem("KSUAN_ID_TOKEN", window.__idToken);
        const payload = parseJwt(window.__idToken);
        if(payload && payload.email) document.getElementById("userEmail").textContent = payload.email;
        toast("ë¡œê·¸ì¸ ì™„ë£Œ");
      }
    });
    google.accounts.id.renderButton(document.getElementById("gSignIn"), { theme:"outline", size:"large" });
  }

  // -----------------
  // Network
  // -----------------
  async function post(action, data){
    if(!state.apiBase) throw new Error("API_BASE ë¯¸ì„¤ì •");

    const email = (localStorage.getItem("KSUAN_TEST_EMAIL") || "").trim();
    const payload = { action, ...data, idToken: (window.__idToken || ""), email };
    const res = await fetch(state.apiBase, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    try{ return JSON.parse(txt); }catch(e){ return { ok:false, error:"non_json", raw: txt }; }
  }

  async function reload(){
    if(!state.apiBase){ openSettings(); toast("API_BASEë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”"); return; }
    const q = document.getElementById("q").value || "";
    const r = await post("list_bids", { q, sourceFilter: state.filter, limit: 250 });

    if(!(r && r.ok)){
      console.log(r);
      toast("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      return;
    }
    state.items = Array.isArray(r.items) ? r.items : [];
    renderList();
    document.getElementById("ver").textContent = (r.version || r.appVersion || "-");
  }

  function renderList(){
    const wrap = document.getElementById("list");
    wrap.innerHTML = "";

    if(!state.items.length){
      wrap.innerHTML = `<div class="card"><h2>í‘œì‹œí•  ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</h2><div class="meta">ê²€ìƒ‰ì–´/í•„í„°ë¥¼ ì¡°ì •í•´ ì£¼ì„¸ìš”.</div></div>`;
      return;
    }

    state.items.forEach(it=>{
      const title = it.title || it.bidNtceNm || it.ê³µê³ ëª… || "(ì œëª© ì—†ìŒ)";
      const org = it.org || it.dminsttNm || it.ìˆ˜ìš”ê¸°ê´€ || it.ë°œì£¼ì²˜ || "-";
      const region = it.region || it.ì§€ì—­ || "-";
      const link = it.link || it.url || it.ë§í¬ || "";
      const src = it.sourceType || it.source || it.SOURCE || "UNKNOWN";
      const summary = it.aiSummary || it.summary1 || it.AI_ìš”ì•½ || it.AIìš”ì•½ || "";

      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="cardTop">
          <h2>${esc(title)}</h2>
          <span class="${tagClass(src)}">${esc(src)}</span>
        </div>
        <div class="meta">
          <span>ê¸°ê´€: <b>${esc(org)}</b></span>
          <span>ì§€ì—­: <b>${esc(region)}</b></span>
          <span>ìƒíƒœ: <b>${esc(it.status || it.ìƒíƒœ || "-")}</b></span>
        </div>
        <div class="summary">${esc(summary || "")}</div>
        <div class="actions">
          <button class="btn primary" onclick="openModal('${esc(it.id || it.ê³µê³ ë²ˆí˜¸ || it.bidId || "")}')">2ì°¨ ì‹¬í™”ë¶„ì„</button>
          ${link ? `<a class="btn ghost" href="${esc(link)}" target="_blank" rel="noopener">ì›ë¬¸ì—´ê¸°</a>` : ``}
        </div>
      `;
      wrap.appendChild(el);
    });
  }

  // -----------------
  // Modal
  // -----------------
  function showModal(){ document.getElementById("modalBack").style.display="flex"; }
  function hideModal(){ document.getElementById("modalBack").style.display="none"; }

  function bindStd(std){
    std = std || {};
    document.getElementById("fServicePeriod").value = std.servicePeriod || "";
    document.getElementById("fServiceAmount").value = std.serviceAmount || "";
    document.getElementById("fProjectBudget").value = std.projectBudget || "";
    document.getElementById("fFacilityType").value = std.facilityType || "";
    document.getElementById("fRiskLevel").value = std.riskLevel || "";
    const cps = std.checkPoints || [];
    document.getElementById("fCheckPoints").value = Array.isArray(cps) ? cps.join("\n") : String(cps || "");
  }

  function renderLaw(matches){
    const el = document.getElementById("mLaw");
    if(!matches || !matches.length){
      el.textContent = "í‘œê¸°í•  ë§¤ì¹­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }
    const lines = matches.slice(0, 12).map(m=>{
      if(typeof m === "string") return `- ${m}`;
      const name = m.lawName || m.name || m.title || "(ì´ë¦„ì—†ìŒ)";
      const art = m.article || "";
      const par = m.paragraph || "";
      const hint = [art, par].filter(Boolean).join(" ");
      return `- ${name}${hint ? (" / " + hint) : ""}`;
    });
    el.textContent = lines.join("\n");
  }

  async function openModal(id){
    if(!id){ toast("idê°€ ì—†ìŠµë‹ˆë‹¤"); return; }

    const r = await post("get_bid", { id });
    if(!(r && r.ok)){
      console.log(r);
      toast("ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      return;
    }

    const item = r.item || r.data || r.bid || r.result || r;
    state.currentItem = item;
    state.currentId = item.id || item.ê³µê³ ë²ˆí˜¸ || id;
    state.currentRegion = item.region || item.ì§€ì—­ || "";

    document.getElementById("mTitle").textContent = item.title || item.ê³µê³ ëª… || "-";
    document.getElementById("mSub").textContent = `ê¸°ê´€: ${(item.org || item.ìˆ˜ìš”ê¸°ê´€ || item.ë°œì£¼ì²˜ || "-")} Â· ì§€ì—­: ${(item.region || item.ì§€ì—­ || "-")} Â· ì†ŒìŠ¤: ${(item.sourceType || item.source || "-")}`;
    document.getElementById("mSummary").textContent = item.aiSummary || item.AI_ìš”ì•½ || "";

    const std = item.stdInfo || {};
    bindStd(std);

    document.getElementById("mUpdatedAt").textContent = item.updatedAt || "-";
    document.getElementById("mUpdatedBy").textContent = item.updatedBy || "-";

    const deep = item.deep || null;
    document.getElementById("mDeep").textContent = deep ? JSON.stringify(deep, null, 2) : "";

    const law = item.deep?.lawMatches || item.lawMatches || [];
    renderLaw(Array.isArray(law) ? law : []);

    showModal();
  }

  async function saveStd(){
    if(!state.currentId){ toast("ëŒ€ìƒ ê³µê³ ë¥¼ ë¨¼ì € ì—´ì–´ ì£¼ì„¸ìš”"); return; }

    const stdInfo = {
      servicePeriod: document.getElementById("fServicePeriod").value,
      serviceAmount: document.getElementById("fServiceAmount").value,
      projectBudget: document.getElementById("fProjectBudget").value,
      facilityType: document.getElementById("fFacilityType").value,
      riskLevel: document.getElementById("fRiskLevel").value,
      checkPoints: document.getElementById("fCheckPoints").value
    };

    const r = await post("saveStdInfo", { id: state.currentId, stdInfo });
    if(!(r && r.ok)){
      console.log(r);
      toast("ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      return;
    }
    toast("ì €ì¥ ì™„ë£Œ");

    // ìµœì‹  í‘œê¸° ê°±ì‹ 
    const rr = await post("get_bid", { id: state.currentId });
    if(rr && rr.ok){
      const item = rr.item || rr;
      document.getElementById("mUpdatedAt").textContent = item.updatedAt || "-";
      document.getElementById("mUpdatedBy").textContent = item.updatedBy || "-";
    }
  }

  async function runDeep(){
    if(!state.currentId){ toast("ëŒ€ìƒ ê³µê³ ë¥¼ ë¨¼ì € ì—´ì–´ ì£¼ì„¸ìš”"); return; }
    toast("2ì°¨ ë¶„ì„ ì‹¤í–‰ ì¤‘...");

    const r = await post("deepAnalyze", { id: state.currentId });
    if(!(r && r.ok)){
      console.log(r);
      toast("2ì°¨ ë¶„ì„ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      return;
    }

    const deep = r.deep || r.result || r.data || null;
    document.getElementById("mDeep").textContent = deep ? JSON.stringify(deep, null, 2) : "";
    renderLaw((deep && deep.lawMatches) ? deep.lawMatches : []);
    toast("2ì°¨ ë¶„ì„ ì™„ë£Œ");
  }

  async function fetchLaw(){
    const region = state.currentRegion || "";
    const title = (state.currentItem && (state.currentItem.title || state.currentItem.ê³µê³ ëª…)) || "";
    const r = await post("law_match", { region, title });
    if(!(r && r.ok)){
      console.log(r);
      toast("ë²•ë ¹ ë§¤ì¹­ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      return;
    }
    renderLaw(r.matches || []);
    toast("ë²•ë ¹ ë§¤ì¹­ ì™„ë£Œ");
  }

  async function updateAll(){
    toast("ì—…ë°ì´íŠ¸ ì‹¤í–‰ ì¤‘...");
    const r = await post("updateAll", {});
    if(!(r && r.ok)){
      console.log(r);
      toast("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
      return;
    }
    toast("ì—…ë°ì´íŠ¸ ì™„ë£Œ");
    reload();
  }

  async function testApi(){
    if(!state.apiBase){ toast("API_BASEë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”"); return; }
    const r = await post("ping", {});
    if(r && r.ok) toast("ì—°ê²° OK");
    else { console.log(r); toast("ì—°ê²° ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)"); }
  }

  async function boot(){
    loadApi();
    loadStoredToken();

    if(!state.apiBase){
      openSettings();
      toast("API_BASEë¥¼ ì„¤ì •í•´ ì£¼ì„¸ìš”");
      return;
    }

    // configê°€ ìˆìœ¼ë©´ google client idë¥¼ ë°›ì•„ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ
    try{
      const c = await post("getConfig", {});
      if(c && c.ok){
        if(c.googleClientId) initGoogleLogin(c.googleClientId);
        document.getElementById("ver").textContent = c.version || "-";
      }
    }catch(e){}

    reload();
  }

  boot();
</script>

</body>
</html>
